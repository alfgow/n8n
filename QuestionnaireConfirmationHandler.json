{
	"nodes": [
		{
			"parameters": {
				"workflowInputs": {
					"values": [
						{
							"name": "wa_id"
						},
						{
							"name": "userPrompt "
						},
						{
							"name": "context_data",
							"type": "object"
						},
						{
							"name": "api_contact",
							"type": "object"
						}
					]
				}
			},
			"type": "n8n-nodes-base.executeWorkflowTrigger",
			"typeVersion": 1.1,
			"position": [0, 0],
			"id": "20db0ebd-fd3b-4738-bdc1-7d5e39a37818",
			"name": "When Executed by Another Workflow"
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "gpt-5-nano",
					"mode": "list",
					"cachedResultName": "GPT-5-NANO"
				},
				"responses": {
					"values": [
						{
							"role": "system",
							"content": "=Eres un clasificador de respuestas de confirmaci√≥n.\n\nEl usuario respondi√≥ a la pregunta: \"¬øEst√°s listo/a para continuar con el cuestionario?\"\n\nMENSAJE DEL USUARIO: {{ $json['userPrompt '] }}\n\nClasifica la respuesta en UNA de estas categor√≠as:\n\n- afirmativa: Acepta continuar (s√≠, ok, listo, adelante, claro, de acuerdo, va, sale, √≥rale, sim√≥n, yes, yep)\n\n- negativa: Rechaza o pospone (no, ahora no, despu√©s, m√°s tarde, luego, ahorita no, nel, nope)\n\n- ambigua: No est√° claro o cambia de tema (cualquier otra respuesta que no sea claramente s√≠ o no)\n\nEjemplos:\n- \"S√≠, adelante\" ‚Üí afirmativa\n- \"Ok\" ‚Üí afirmativa  \n- \"Listo!\" ‚Üí afirmativa\n- \"No, ahora no\" ‚Üí negativa\n- \"Despu√©s te digo\" ‚Üí negativa\n- \"¬øCu√°nto cuesta?\" ‚Üí ambigua\n- \"Hola\" ‚Üí ambigua\n\nResponde SOLO con una palabra: afirmativa, negativa o ambigua\nNo agregues puntuaci√≥n ni explicaciones."
						}
					]
				},
				"builtInTools": {},
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.openAi",
			"typeVersion": 2,
			"position": [208, 0],
			"id": "aae2627e-9300-4346-b838-61e358de3b4b",
			"name": "Message a model",
			"credentials": {
				"openAiApi": {
					"id": "g8OPzRDvvB6YO7mf",
					"name": "OpenAi account"
				}
			}
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.output[0].content[0].text }}",
										"rightValue": "afirmativa",
										"operator": {
											"type": "string",
											"operation": "equals"
										},
										"id": "491dc383-ce20-4348-8b6e-07e1be42e6a9"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "afirmativa"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "337cfbb5-5030-4b75-837a-1a036921e10e",
										"leftValue": "={{ $json.output[0].content[0].text }}",
										"rightValue": "negativa",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "negativa"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "36e19012-f41e-42e1-af7d-9d4127facc43",
										"leftValue": "={{ $json.output[0].content[0].text }}",
										"rightValue": "ambigua",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "ambigua"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [528, -16],
			"id": "e7431a44-8874-4993-a883-75a9f145fc29",
			"name": "Switch"
		},
		{
			"parameters": {
				"jsCode": "const triggerData = $('When Executed by Another Workflow').item.json;\nconst timestamp = new Date().toISOString();\n\n// Clonar contexto existente\nconst updatedContext = JSON.parse(JSON.stringify(triggerData.context_data || {}));\n\n// Cambiar status e iniciar cuestionario\nupdatedContext.status = \"in_questionnaire\";\nupdatedContext.questionnaire_step = 1;\nupdatedContext.ultima_interaccion = timestamp;\n\n// Agregar interacci√≥n\nconst interactions = Array.isArray(updatedContext.interacciones) \n  ? updatedContext.interacciones \n  : [];\n\ninteractions.push({\n  timestamp: timestamp,\n  actor: 'usuario',\n  canal: 'whatsapp',\n  tipo: 'confirmacion_cuestionario',\n  mensaje: triggerData['userPrompt '],\n  detalles: {\n    respuesta: 'afirmativa',\n    inicia_cuestionario: true\n  }\n});\n\nupdatedContext.interacciones = interactions;\n\n// Preparar primera pregunta basada en restricciones\nconst property = updatedContext.property_found || {};\nconst restrictions = property.restrictions || {};\n\nlet firstQuestion = \"Perfecto, \\n\\n¬øCu√°ntas personas vivir√≠an en el inmueble?\";\n\n// Si la propiedad no acepta ni√±os, agregar aclaraci√≥n\nif (restrictions.acepta_ni√±os === \"no\") {\n  firstQuestion += \"\\n\\n_(Solo adultos, la propiedad no acepta ni√±os)_\";\n}\n\nreturn {\n  wa_id: triggerData.wa_id,\n  updatedContext: updatedContext,\n  firstQuestion: firstQuestion,\n  api_contact_id: updatedContext.api_contact_id\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [736, -128],
			"id": "d60c91b8-f6ab-4da9-bf13-1081ca6b88a6",
			"name": "Prepare Questionnaire Context"
		},
		{
			"parameters": {
				"jsCode": "const parseData = $json;\nconst timestamp = new Date().toISOString();\n\n// Clonar contexto existente\nconst updatedContext = JSON.parse(JSON.stringify(parseData.context_data || {}));\n\n// Agregar cuestionario y configuraci√≥n\nupdatedContext.status = \"in_questionnaire\";\nupdatedContext.questionnaire = parseData.questionnaire;\nupdatedContext.questionnaire_step = 1;\nupdatedContext.questionnaire_total = parseData.total_questions;\nupdatedContext.questionnaire_answers = []; // Array vac√≠o para ir guardando respuestas\nupdatedContext.ultima_interaccion = timestamp;\n\n// Agregar interacci√≥n al historial\nconst interactions = Array.isArray(updatedContext.interacciones) \n  ? updatedContext.interacciones \n  : [];\n\ninteractions.push({\n  timestamp: timestamp,\n  actor: 'sistema',\n  canal: 'whatsapp',\n  tipo: 'inicio_cuestionario',\n  mensaje: 'Cuestionario generado e iniciado',\n  detalles: {\n    total_preguntas: parseData.total_questions,\n    primera_pregunta: parseData.first_question.field\n  }\n});\n\nupdatedContext.interacciones = interactions;\n\n// Preparar primera pregunta para WhatsApp\nconst firstQuestion = parseData.first_question;\nlet questionText = `Perfecto, empecemos üòä:\\n\\n${firstQuestion.question}`;\n\nreturn {\n  wa_id: parseData.wa_id,\n  updatedContext: updatedContext,\n  questionText: questionText,\n  current_question: firstQuestion\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [1184, -128],
			"id": "a16d67b1-de75-4c14-8b2e-1bbb7add2462",
			"name": "Prepare Context with Questionnaire"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = $${{ $json.updatedContext.toJsonString() }}$$::jsonb,\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [1488, -144],
			"id": "b710c8ce-7d44-48a0-9928-d5ad14e58a62",
			"name": "Save Context with Questionnaire",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $json.wa_id }}",
				"textBody": "={{ $('Prepare Context with Questionnaire').item.json.questionText }}",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [1760, -144],
			"id": "acad6a4d-9d2c-41a8-8404-8770dac05582",
			"name": "Send message",
			"webhookId": "aef0e0a7-bf3c-454a-9777-e7370c1fcf3b",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const prepareData = $('Prepare Context with Questionnaire').item.json;\n\nreturn {\n  success: true,\n  status: 'in_questionnaire',\n  questionnaire_started: true,\n  step: 1,\n  total_questions: prepareData.updatedContext.questionnaire_total,\n  wa_id: prepareData.wa_id,\n  message_sent: true\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [1968, -144],
			"id": "d6b637d3-e110-4eea-8a0b-5a18bd155739",
			"name": "Format Success Output"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "INSERT INTO user_contexts (wa_id, context_data, created_at, updated_at)\nVALUES (\n  '{{ $('Send message').item.json.contacts[0].wa_id }}',\n  jsonb_build_object('statusBot', 'working'),\n  CURRENT_TIMESTAMP,\n  CURRENT_TIMESTAMP\n)\nON CONFLICT (wa_id) DO UPDATE SET\n  context_data = jsonb_set(\n    COALESCE(user_contexts.context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [1152, -336],
			"id": "e079643f-a93c-46a4-9981-52f391e597ac",
			"name": "Update Bot to Free",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('Prepare Questionnaire Context').item.json.wa_id }}",
				"textBody": "üòí Vaya, eso no funcion√≥ como esper√°bamos, puedes volver a intenar? Gracias",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [1328, 80],
			"id": "dd49e142-659c-43ad-9a6f-86fa67af9efc",
			"name": "Send message1",
			"webhookId": "56363a2a-8373-40d1-8b03-ac8b4e9373de",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "// Obtener datos del nodo anterior\nconst previousData = $('Prepare Questionnaire Context').item.json;\nconst propertyData = previousData.updatedContext.property_found;\nconst contextData = previousData.updatedContext;\n\nconst TEMPLATE = {\n  caracteristicas_fisicas: [\n    {\n      condition: () => !propertyData.parkings || propertyData.parkings === 0,\n      field: \"necesita_estacionamiento\",\n      question: \"El inmueble no cuenta con estacionamiento. ¬øEst√°s de acuerdo con esto?\"\n    }\n  ],\n  \n  restricciones_convivencia: [\n    {\n      condition: () => propertyData.restrictions?.acepta_ni√±os === \"no\",\n      field: \"tiene_ninos\",\n      question: \"¬øEntre las personas que vivir√≠an en el inmueble habr√≠a ni√±os?\"\n    },\n    {\n      condition: () => propertyData.restrictions?.acepta_mascotas === \"no\",\n      field: \"tiene_mascotas\",\n      question: \"El arrendador no acepta mascotas, es una restricci√≥n no negociable. ¬øTienes inconveniente con esto?\"\n    },\n    {\n      condition: () => propertyData.restrictions?.acepta_roomies === \"no\",\n      field: \"tiene_roomies\",\n      question: \"Plat√≠came con quien vivir√°s ¬øsolo/a, con pareja, familia o con roomies?\"\n    }\n  ],\n  \n  condiciones_contratacion: [\n    {\n      condition: () => propertyData.restrictions?.precio_poliza > 0,\n      field: \"acepta_poliza\",\n      question: `Se solicita una p√≥liza jur√≠dica de $${parseFloat(propertyData.restrictions.precio_poliza).toLocaleString('es-MX')} que se paga anualmente, es decir, cada a√±o que renueves el contrato. ¬øEst√°s de acuerdo?`\n    },\n    {\n      condition: () => true,\n      field: \"acepta_deposito_renta\",\n      question: \"Los pagos iniciales que se requieren son: Primer mes de renta y un mes de renta como dep√≥sito en garant√≠a. ¬øEst√°s de acuerdo con √©ste requisito?\"\n    }\n  ],\n  \n  validacion_ingresos: [\n    {\n      condition: () => propertyData.restrictions?.ingresos_minimos > 0,\n      field: \"cumple_ingresos\",\n      question: `Se pide un ingreso m√≠nimo de $${parseFloat(propertyData.restrictions.ingresos_minimos).toLocaleString('es-MX')} mensuales, puede ser individual o mancomunado si vivir√°s en pareja. ¬øCumples con √©ste requisito?`\n    },\n    {\n      condition: () => true,\n      field: \"ocupacion\",\n      question: \"Para conocer mejor tu perfil, ¬øa qu√© te dedicas actualmente?\"\n    },\n    {\n      condition: () => propertyData.restrictions?.requiere_comprobantes_ingresos === true,\n      field: \"tipo_comprobante\",\n      question: \"¬øQu√© tipo de comprobantes de ingresos tienes? (Recibo de n√≥mina timbrado por el SAT, estados de cuenta completos o facturas?)\"\n    }\n  ]\n};\n\n// Generar cuestionario\nconst questionnaire = [];\n\nfor (const [section, questions] of Object.entries(TEMPLATE)) {\n  questions.forEach(q => {\n    if (q.condition()) {\n      questionnaire.push({\n        section: section,\n        field: q.field,\n        question: q.question,\n        type: \"text\"\n      });\n    }\n  });\n}\n\n// Obtener primera pregunta\nconst firstQuestion = questionnaire[0] || null;\n\n// Validar que hay al menos una pregunta\nif (!firstQuestion) {\n  throw new Error('No se generaron preguntas para este inmueble');\n}\n\nreturn {\n  wa_id: previousData.wa_id,\n  questionnaire: questionnaire,\n  total_questions: questionnaire.length,\n  first_question: firstQuestion,    // ‚Üê ESTO FALTABA\n  context_data: contextData          // ‚Üê ESTO FALTABA\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [944, -128],
			"id": "728f00a9-217e-412d-ab66-ff2db7ad8dec",
			"name": "Generate Static Questionnaire"
		}
	],
	"connections": {
		"When Executed by Another Workflow": {
			"main": [
				[
					{
						"node": "Message a model",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Message a model": {
			"main": [
				[
					{
						"node": "Switch",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Switch": {
			"main": [
				[
					{
						"node": "Prepare Questionnaire Context",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Prepare Questionnaire Context": {
			"main": [
				[
					{
						"node": "Generate Static Questionnaire",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Prepare Context with Questionnaire": {
			"main": [
				[
					{
						"node": "Save Context with Questionnaire",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Save Context with Questionnaire": {
			"main": [
				[
					{
						"node": "Send message",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Send message": {
			"main": [
				[
					{
						"node": "Format Success Output",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Format Success Output": {
			"main": [
				[
					{
						"node": "Update Bot to Free",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Generate Static Questionnaire": {
			"main": [
				[
					{
						"node": "Prepare Context with Questionnaire",
						"type": "main",
						"index": 0
					}
				]
			]
		}
	},
	"pinData": {},
	"meta": {
		"templateCredsSetupCompleted": true,
		"instanceId": "37571b6e3b06c0ce894d50931b94c0b80b70f40d5b859a8ce717ce6c0e3d4b9d"
	}
}
