{
    "nodes": [
        {
            "parameters": {
                "updates": [
                    "messages"
                ],
                "options": {}
            },
            "type": "n8n-nodes-base.whatsAppTrigger",
            "typeVersion": 1,
            "position": [
                -48,
                704
            ],
            "id": "c8ae6932-5f89-4f47-b03e-d6cd7ba2265b",
            "name": "WhatsApp Trigger",
            "webhookId": "74594388-e12c-4f20-b583-78678872e5e7",
            "credentials": {
                "whatsAppTriggerApi": {
                    "id": "wFOtw7oArsG5zhql",
                    "name": "WhatsApp OAuth account"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "7f76b2d5-6c02-451f-9c67-7777b3e92f92",
                            "leftValue": "={{ $json.misbehaviorDetected }}",
                            "rightValue": "",
                            "operator": {
                                "type": "boolean",
                                "operation": "true",
                                "singleValue": true
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                1904,
                496
            ],
            "id": "5e0223cf-3862-4a17-8caf-7dea5edd0dd1",
            "name": "If: Misbehavior?"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "WITH context_data AS (\n  SELECT id, wa_id, context_data\n  FROM user_contexts\n  WHERE wa_id = '{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}'\n  LIMIT 1\n)\nSELECT\n  '{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}'::text AS wa_id,\n    (\n    SELECT row_to_json(context_row)\n    FROM context_data AS context_row\n  ) AS context_record;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                688,
                160
            ],
            "id": "7e1e9658-76fb-4573-bf06-832de0bfdf06",
            "name": "Get Misbehavior Context",
            "alwaysOutputData": true,
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const detectorData = $('Parse Misbehavior').item.json;\nconst contextRecord = $json.context_record || null;\n\n// ‚úÖ Evitar error si context_data no existe\nconst contextData = contextRecord?.context_data\n  ? JSON.parse(JSON.stringify(contextRecord.context_data))\n  : {};\n\n// ‚úÖ Verificar si ya existe contexto\nconst isExisting = Boolean(contextRecord && contextRecord.id);\n\n// ‚úÖ Obtener contacto de manera segura\nconst contactData = $('Get API Contact').first().json?.data || [];\nconst contactName = contactData[1]?.nombre || contactData[0]?.nombre || null;\n\n// ‚úÖ Nombre con fallback seguro\nconst fallbackName =\n  contactName && contactName.trim() !== ''\n    ? contactName.trim()\n    : 'ü§ñ - Sin Nombre Mal Comportamiento';\n\n// ‚úÖ Texto de motivo de rechazo\nconst reasonText =\n  detectorData.misbehaviorReason && detectorData.misbehaviorReason.trim() !== ''\n    ? detectorData.misbehaviorReason\n    : 'Comportamiento indebido detectado autom√°ticamente';\n\n// ‚úÖ Palabras y mensaje original\nconst matchedWords = detectorData.misbehaviorMatchedWords || [];\nconst originalMessage = detectorData.misbehaviorOriginalMessage || detectorData.userPrompt || '';\nconst timestamp = new Date().toISOString();\n\n// ‚úÖ Registro de historial\nconst historyEntry = {\n  timestamp,\n  mensaje_original: originalMessage,\n  palabras_detectadas: matchedWords,\n  origen: 'auto_filter'\n};\n\n// ‚úÖ Interacciones actualizadas\nconst existingInteractions = Array.isArray(contextData.interacciones)\n  ? contextData.interacciones.map((entry) => ({ ...entry }))\n  : [];\nconst interactionEntry = {\n  timestamp,\n  actor: 'usuario',\n  canal: 'whatsapp',\n  tipo: 'mensaje_recibido',\n  mensaje: originalMessage,\n  origen: 'auto_filter',\n  detalles: {\n    motivo: reasonText,\n    palabras_detectadas: matchedWords\n  }\n};\nconst updatedInteractions = [...existingInteractions, interactionEntry];\n\n// ‚úÖ Motivos actualizados\nconst existingReasons = Array.isArray(contextData.motivo_rechazo)\n  ? contextData.motivo_rechazo\n  : [];\nconst updatedReasons = [...existingReasons];\nif (!updatedReasons.includes(reasonText)) updatedReasons.push(reasonText);\n\n// ‚úÖ Historial actualizado\nconst existingHistory = Array.isArray(contextData.mal_comportamiento_historial)\n  ? contextData.mal_comportamiento_historial\n  : [];\nconst updatedHistory = [...existingHistory, historyEntry];\n\n// ‚úÖ Nuevo contexto actualizado\nconst updatedContext = {\n  ...contextData,\n  nombre: fallbackName,\n  status: 'blocked',\n  rechazo_previo: true,\n  motivo_rechazo: updatedReasons,\n  mal_comportamiento_historial: updatedHistory,\n  ultima_interaccion: timestamp,\n  interacciones: updatedInteractions\n};\n\n// ‚úÖ Resultado final\nreturn [\n  {\n    json: {\n      ...detectorData,\n      misbehaviorOriginalMessage: originalMessage,\n      isExistingContext: isExisting,\n      contextId: contextRecord?.id || null,\n      updatedContext,\n      misbehaviorHistoryEntry: historyEntry,\n      interactionEntry,\n      api_contact_id: contextData?.api_contact_id || null,\n      needsApiContact: !contextData?.api_contact_id,\n      fallbackName,\n      reasonText\n    }\n  }\n];\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                896,
                160
            ],
            "id": "aca1db71-fa81-471f-a365-f2c4c1790e03",
            "name": "Prepare Misbehavior Context"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO user_contexts (wa_id, context_data, created_at, updated_at)\nVALUES (\n  '{{ $json.wa_id }}',\n  $${{ $json.updatedContext.toJsonString() }}$$::jsonb,\n  CURRENT_TIMESTAMP,\n  CURRENT_TIMESTAMP\n)\nON CONFLICT (wa_id) DO UPDATE SET\n  context_data = EXCLUDED.context_data,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING\n  id,\n  wa_id,\n  context_data,\n  context_data->>'api_contact_id' AS api_contact_id;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1088,
                160
            ],
            "id": "7e0e72f8-93d7-4a1d-a89f-f4ec83ca9db0",
            "name": "Postgres: Insert Misbehavior Context",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://vg.g210512.com/api/v1/contactos",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"nombre\": \"{{ $('Prepare Misbehavior Context').item.json.fallbackName }}\",\n  \"telefono\": \"{{ $('Get: Message Info').item.json.phone }}\",\n  \"estado\": \"blocked\",\n  \"fuente\": \"WhatsApp Bot\"\n}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1312,
                160
            ],
            "id": "fd6838da-bcf1-4d30-8bea-50ff0554a6be",
            "name": "API: Create Misbehavior Contact",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts\nSET\n  context_data = jsonb_set(\n    $${{ $('Prepare Misbehavior Context').item.json.updatedContext.toJsonString() }}$$::jsonb,\n    '{api_contact_id}',\n    '{{ $json.data.id }}'::jsonb,\n    true\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Prepare Misbehavior Context').item.json.wa_id }}'\nRETURNING\n  id,\n  wa_id,\n  context_data,\n  context_data->>'api_contact_id' AS api_contact_id;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1520,
                160
            ],
            "id": "e08cb4cf-4c15-45cb-9b6e-d02b8618f0b9",
            "name": "Postgres: Save API Contact (New)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const prepareData = $('Prepare Misbehavior Context').item.json;\nconst apiContactId = $json.api_contact_id || $json.data?.id;\n\nconst matchedWords = prepareData.misbehaviorMatchedWords || [];\nconst originalMessage = prepareData.misbehaviorOriginalMessage || '';\nconst reasonText = prepareData.reasonText || 'Comportamiento indebido detectado autom√°ticamente';\nconst timestamp = new Date().toISOString();\n\nconst commentLines = [\n  'üö® BLOQUEADO - MAL COMPORTAMIENTO',\n  '',\n  ` Motivo: ${reasonText}`,\n  matchedWords.length ? `Coincidencias detectadas: ${matchedWords.join(', ')}` : '',\n  originalMessage ? `Mensaje original: \\\"${originalMessage}\\\"` : '',\n  `Registrado el: ${timestamp}`\n].filter(Boolean);\n\nconst notificationMessage = 'Detectamos un comportamiento indebido en tu mensaje. Tu contacto ha sido reportado y no podremos continuar con la atenci√≥n. ‚ùå';\n\nconst existingInteractions = Array.isArray(prepareData.updatedContext?.interacciones)\n  ? prepareData.updatedContext.interacciones.map((entry) => ({ ...entry }))\n  : Array.isArray($json.interacciones)\n    ? $json.interacciones.map((entry) => ({ ...entry }))\n    : [];\n\nconst systemInteraction = {\n  timestamp,\n  actor: 'sistema',\n  canal: 'whatsapp',\n  tipo: 'bloqueo_registrado',\n  mensaje: 'Contacto bloqueado por comportamiento indebido.',\n  detalles: {\n    motivo: reasonText,\n    comentario: commentLines.join('\n')\n  }\n};\n\nconst updatedInteractions = [...existingInteractions, systemInteraction];\n\nconst updatedContext = {\n  ...(prepareData.updatedContext || {}),\n  interacciones: updatedInteractions\n};\n\nreturn [\n  {\n    json: {\n      api_contact_id: apiContactId,\n      comentario: commentLines.join(''),\n      wa_id: prepareData.wa_id,\n      misbehaviorNotification: notificationMessage,\n      updatedInteractions,\n      updatedContext\n    }\n  }\n];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1696,
                160
            ],
            "id": "4d6b470e-6103-4740-8370-044f5b29cc92",
            "name": "Build Misbehavior Comment"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.api_contact_id }}/comentarios",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"comentario\": {{ $json.comentario.toJsonString() }}\n}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1872,
                160
            ],
            "id": "4e5f995e-ff09-486b-a98f-9b177fbda73a",
            "name": "API: Add Misbehavior Comment",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
                "textBody": "={{ $json.message.content }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                2336,
                160
            ],
            "id": "9b0a4cee-ff48-40fe-bdca-ede2d69bf76c",
            "name": "Send Misbehavior Notice",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "content": "## -> Audio",
                "height": 704,
                "width": 304,
                "color": 6
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                64,
                -128
            ],
            "typeVersion": 1,
            "id": "1936afa1-c153-4f69-a112-be55e701dd2b",
            "name": "Sticky Note6"
        },
        {
            "parameters": {
                "resource": "media",
                "operation": "mediaUrlGet",
                "mediaGetId": "={{ $json.messages[0].audio.id }}"
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                128,
                -48
            ],
            "id": "5421e3c9-c49d-49ff-9dc1-e7a5bd6e78a8",
            "name": "Download media3",
            "webhookId": "02de1bd7-bb83-49da-baa6-392d89ed4096",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "url": "={{ $json.url }}",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpBearerAuth",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                176,
                208
            ],
            "id": "4e9f8956-0ccb-4b18-a5f3-e346fcb50d5f",
            "name": "HTTP Request3",
            "credentials": {
                "httpBearerAuth": {
                    "id": "QigdAtAlBxHMmIsD",
                    "name": "WA - Bearer Token"
                }
            }
        },
        {
            "parameters": {
                "resource": "audio",
                "modelId": {
                    "__rl": true,
                    "value": "models/gemini-2.5-flash",
                    "mode": "list",
                    "cachedResultName": "models/gemini-2.5-flash"
                },
                "inputType": "binary",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.googleGemini",
            "typeVersion": 1,
            "position": [
                160,
                432
            ],
            "id": "ce7e158a-a632-477b-98e9-87a3de5b663e",
            "name": "Transcribe: audio",
            "credentials": {
                "googlePalmApi": {
                    "id": "3Qw3858fHslDYr4D",
                    "name": "Gemini - alfgow"
                }
            }
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "4b195430-ea1d-49ce-84cb-06f1edc71280",
                            "name": "intent",
                            "value": "={{ $json.content.parts[0].text.replace(/^[\"'\\s]+|[\"'\\s]+$/g, '').replace(/\\\\/g, '') }}",
                            "type": "string"
                        },
                        {
                            "id": "8d0c4046-fab8-4adb-b011-92b920f7c4c7",
                            "name": "userPrompt",
                            "value": "={{ $('Get: Message Info').item.json.userPrompt }}",
                            "type": "string"
                        },
                        {
                            "id": "e5dc3f46-71fa-4d48-a8ff-85b0023aa398",
                            "name": "wa_id",
                            "value": "={{ $('Get: Message Info').item.json.wa_id }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                3568,
                1088
            ],
            "id": "71128568-2490-4639-b74c-1719f4f3e52e",
            "name": "Edit Fields"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT context_data \nFROM user_contexts \nWHERE wa_id = '{{ $json.wa_id }}' \nLIMIT 1;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                3744,
                1088
            ],
            "id": "45f987f9-7ff3-42ae-b7f3-72ca415f0262",
            "name": "Execute a SQL query",
            "alwaysOutputData": true,
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const existingContext = $input.first().json || {};\nconst previousContext = existingContext.context_data\n  ? JSON.parse(JSON.stringify(existingContext.context_data))\n  : {};\n\nconst messageData = $('Edit Fields').item.json;\nconst userPrompt = messageData.userPrompt || '';\nconst intent = messageData.intent || '';\nconst messageType = messageData.type || '';\nconst timestamp = new Date().toISOString();\n\nlet personaje;\nlet isNew = false;\n\nif (!previousContext.personaje) {\n  const personajes = ['Dany', 'Ale', 'Regi', 'Susy'];\n  personaje = personajes[Math.floor(Math.random() * personajes.length)];\n  isNew = true;\n} else {\n  personaje = previousContext.personaje;\n}\n\nconst clonedInteractions = Array.isArray(previousContext.interacciones)\n  ? previousContext.interacciones.map((entry) => ({ ...entry }))\n  : [];\n\nconst interactionEntry = {\n  timestamp,\n  actor: 'usuario',\n  canal: 'whatsapp',\n  tipo: 'mensaje_recibido',\n  mensaje: userPrompt,\n  detalles: {\n    intent,\n    tipo_mensaje: messageType\n  }\n};\n\nclonedInteractions.push(interactionEntry);\n\nconst updatedContext = {\n  ...previousContext,\n  personaje,\n  ultima_interaccion: timestamp,\n  interacciones: clonedInteractions\n};\n\nif (intent === 'property_search') {\n  updatedContext.original_search = userPrompt;\n  updatedContext.status = 'awaiting_data';\n}\n\nreturn {\n  wa_id: messageData.wa_id,\n  userPrompt,\n  type: messageType,\n  intent,\n  personaje,\n  isNew,\n  contextPayload: updatedContext,\n  interactionEntry\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                4160,
                1104
            ],
            "id": "6bb1a4d0-ef76-4059-9832-e539d20e0864",
            "name": "Check and Assign Character"
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "0d663079-05a6-411a-bd61-d6e05a5b7bae",
                            "leftValue": "={{ $json.isNew }}",
                            "rightValue": "",
                            "operator": {
                                "type": "boolean",
                                "operation": "true",
                                "singleValue": true
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                4368,
                1104
            ],
            "id": "7d0f9d27-8095-4416-9f7d-04406e5d2fca",
            "name": "If: Is New Contact"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO user_contexts (wa_id, context_data, created_at, updated_at)\nVALUES (\n  '{{ $json.wa_id }}',\n  $${{ $json.contextPayload.toJsonString() }}$$::jsonb,\n  CURRENT_TIMESTAMP,\n  CURRENT_TIMESTAMP\n)\nON CONFLICT (wa_id)\nDO UPDATE SET\n  context_data = $${{ $json.contextPayload.toJsonString() }}$$::jsonb,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                4576,
                1088
            ],
            "id": "783fc2a5-21f4-4faf-ae8b-5eb4b991bdcb",
            "name": "Set: New Costumer",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "return {\n  wa_id: $input.first().json.wa_id,\n  userPrompt: $('If: Is New Contact').first().json.userPrompt,\n  intent: $('If: Is New Contact').first().json.intent,\n  personaje: $input.first().json.context_data.personaje,\n  isNew: $('If: Is New Contact').first().json.isNew,\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                4768,
                1088
            ],
            "id": "ef57e2f3-8a2f-4249-bcb7-1efa29afb73d",
            "name": "Merge Context Data"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
                "textBody": "=¬°Hola! üëã Soy {{ $json.personaje }}, tu asistente en Inmobiliaria Villanueva Garc√≠a.\n\n¬øEn qu√© te puedo ayudar hoy? ",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                5472,
                1088
            ],
            "id": "99a9888b-f25f-486d-9a38-fd0abca0151b",
            "name": "Send message1",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const postgresResult = $json;\nconst previousData = $('Switch: Intent').item.json;\n\nconst contextData = postgresResult.context_data || {};\n\nreturn {\n  wa_id: previousData.wa_id,\n  userPrompt: previousData.userPrompt,\n  type: previousData.type,\n  intent: previousData.intent,\n  personaje: contextData.personaje || previousData.personaje,\n  context_id: postgresResult.id,\n  nombre: contextData.nombre || \"\",\n  telefono: contextData.telefono || \"\",\n  status: contextData.status || \"new\",\n  rechazo_previo: contextData.rechazo_previo || false,\n  motivo_rechazo: contextData.motivo_rechazo || [],\n  inmuebles_consultados:  $input.first().json.context_data.property_found || [],\n  ultima_interaccion: postgresResult.updated_at\n};\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5936,
                1024
            ],
            "id": "be5351c8-c868-499e-9155-08f7bd2a47ad",
            "name": "Parse Context Data"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT \n  id,\n  wa_id,\n  context_data,\n  created_at,\n  updated_at\nFROM user_contexts \nWHERE wa_id = '{{ $json.wa_id }}'\nLIMIT 1;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                5728,
                1024
            ],
            "id": "844473d5-3db9-4f37-8317-88c27540d9bf",
            "name": "Get: User Context",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const data = $json;\n\nlet missingData = [];\nlet contextStatus = \"\";\n\nif (data.rechazo_previo === true) {\n  contextStatus = \"rejected_before\";\n} else if (!data.nombre || data.nombre === \"\") {\n  missingData.push(\"nombre\");\n  contextStatus = \"incomplete_data\";\n} else if (!data.telefono || data.telefono === \"\") {\n  missingData.push(\"telefono\");\n  contextStatus = \"incomplete_data\";\n} else {\n  contextStatus = \"complete_data\";\n}\n\nreturn {\n  ...data,\n  missingData: missingData,\n  contextStatus: contextStatus\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                6128,
                1024
            ],
            "id": "4141c3cf-e13b-459c-9a4d-5e33eacd6045",
            "name": "Check missing Data"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.contextStatus }}",
                                        "rightValue": "rejected_before",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "15548fe7-a59a-44dd-87e0-c87fa85e30fd"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Rejected Before"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "9c138d09-5a25-4eb2-b926-784df2b799d9",
                                        "leftValue": "={{ $json.contextStatus }}",
                                        "rightValue": "incomplete_data",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Incomplete Data"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "e84bb5cb-d2fd-46a7-983b-6164d386d44e",
                                        "leftValue": "={{ $json.contextStatus }}",
                                        "rightValue": "complete_data",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Complete Data"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                6368,
                1008
            ],
            "id": "f04c6d74-5e10-4845-a7c1-d2f7aeb758ae",
            "name": "Actual Status"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
                "textBody": "=¬°Perfecto! Para ayudarte con la informaci√≥n del inmueble que buscas, necesito que me compartas:\n\nüìù Tu nombre completo\nüì± Tu n√∫mero de tel√©fono\n\nPor favor comp√°rtelos en un solo mensaje üòä",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                5712,
                1280
            ],
            "id": "75eee59d-befe-4d60-a862-5e54f328f51b",
            "name": "Request Data",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{status}',\n      '\"awaiting_data\"'\n    ),\n    '{original_search}',\n    '\"{{ $('Actual Status').item.json.userPrompt }}\"'\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Actual Status').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                5936,
                1280
            ],
            "id": "fc52e469-9ab7-4278-a029-39750e9a7fd1",
            "name": "Update: Status awaiting",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT \n  id,\n  wa_id,\n  context_data,\n  created_at,\n  updated_at\nFROM user_contexts \nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nLIMIT 1;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                848,
                464
            ],
            "id": "02dc7447-e47a-4ddf-8164-dbeb4cc87bbe",
            "name": "Check Context Status",
            "alwaysOutputData": true,
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const postgresResult = $('Check Context Status').first().json;  // ‚Üê Referencia directa\nconst previousData = $('Get: Message Info').item.json;\n\nconst contextData = postgresResult.context_data || {};\nconst currentStatus = contextData.status || \"new\";\n\nreturn {\n  ...previousData,\n  context_id: postgresResult.id,\n  personaje: contextData.personaje || \"\",\n  currentStatus: currentStatus,\n  isAwaitingData: currentStatus?.trim().toLowerCase() === \"awaiting_data\"\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -176,
                1104
            ],
            "id": "f21d665e-7977-40a9-b6f9-ef54b2f83a57",
            "name": "Parse: Status"
        },
        {
            "parameters": {
                "jsCode": "const userPrompt = $json.userPrompt;\n\nlet nombre = \"\";\nlet telefono = \"\";\n\nconst nombreMatch = userPrompt.match(/([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+)+)/);\nif (nombreMatch) {\n  nombre = nombreMatch[0].trim();\n}\n\nconst telefonoMatch = userPrompt.match(/(\\d{10,})/);\nif (telefonoMatch) {\n  telefono = telefonoMatch[0].replace(/\\D/g, '');\n  if (telefono.length > 10) {\n    telefono = telefono.slice(-10);\n  }\n}\n\nreturn {\n  ...$json,\n  nombre_extracted: nombre,\n  telefono_extracted: telefono,\n  has_valid_data: nombre !== \"\" && telefono !== \"\"\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                224,
                1088
            ],
            "id": "281b7742-ffc5-48a9-a9ea-2de515a77b95",
            "name": "Extract Name & Phone"
        },
        {
            "parameters": {
                "jsCode": "const postgresResult = $json;\nconst switchData = $('Switch: is Awaiting?').item.json;\n\nconst contextData = postgresResult.context_data;\n\nreturn {\n  wa_id: switchData.wa_id,\n  userPrompt: $input.first().json.context_data.original_search,\n  type: switchData.type,\n  personaje: contextData.personaje,\n  nombre: contextData.nombre,\n  telefono: contextData.telefono,\n  context_id: postgresResult.id,\n  status: contextData.status\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1376,
                1088
            ],
            "id": "afd56f7b-c2cb-45fd-9773-741c58e23c5f",
            "name": "Prepare for Property Search"
        },
        {
            "parameters": {
                "modelId": {
                    "__rl": true,
                    "value": "models/gemini-2.5-flash",
                    "mode": "list",
                    "cachedResultName": "models/gemini-2.5-flash"
                },
                "messages": {
                    "values": [
                        {
                            "content": "={{ $json.userPrompt }}"
                        }
                    ]
                },
                "jsonOutput": true,
                "options": {
                    "systemMessage": "=Eres un clasificador de intenciones. Analiza el mensaje del usuario y clasifica en UNA de estas categor√≠as:\n\n- property_search: Busca un inmueble espec√≠fico (departamento, casa, propiedad)\n- greeting: Saludos iniciales o conversaci√≥n casual amistosa\n- general_inquiry: Preguntas sobre servicios, √°reas, o informaci√≥n general\n- confirmation: Confirmaciones para avanzar (s√≠, ok, listo, adelante)\n- negotiation: Intenta negociar o pedir excepciones\n- out_of_scope: Cualquier tema no relacionado con inmobiliaria\n\nResponde SOLO con el nombre de la categor√≠a, sin explicaciones."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.googleGemini",
            "typeVersion": 1,
            "position": [
                3248,
                1088
            ],
            "id": "e05d843e-0886-467c-ad8b-dfd20b64a64f",
            "name": "Detect: Intention",
            "retryOnFail": true,
            "credentials": {
                "googlePalmApi": {
                    "id": "3Qw3858fHslDYr4D",
                    "name": "Gemini - alfgow"
                }
            }
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.has_valid_data }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "true",
                                            "singleValue": true
                                        },
                                        "id": "dae4488b-95af-4c88-a855-101544196f7a"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "TRUE"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "3225f10b-9880-42ec-8207-af7b7e64a479",
                                        "leftValue": "={{ $json.has_valid_data }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "false",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "FALSE"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                432,
                1088
            ],
            "id": "3175445a-2f06-402b-8c69-c61ba6cd7b8b",
            "name": "Is Valid Data"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      jsonb_set(\n        context_data,\n        '{nombre}',\n        '\"{{ $json.nombre_extracted }}\"'\n      ),\n      '{telefono}',\n      '\"{{ $json.telefono_extracted }}\"'\n    ),\n    '{status}',\n    '\"in_progress\"'\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                688,
                1072
            ],
            "id": "a1a7b08c-774e-4c06-abbb-120b290b4c7b",
            "name": "Get Context Awating Data",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "description": "Este Workflow busca la informacion de los inmuebles",
                "workflowId": {
                    "__rl": true,
                    "value": "8JWwPczEyYuP2J3N",
                    "mode": "list",
                    "cachedResultUrl": "/workflow/8JWwPczEyYuP2J3N",
                    "cachedResultName": "InmuebleFinderTool"
                },
                "workflowInputs": {
                    "mappingMode": "defineBelow",
                    "value": {
                        "termino": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('termino', ``, 'string') }}"
                    },
                    "matchingColumns": [],
                    "schema": [
                        {
                            "id": "termino",
                            "displayName": "termino",
                            "required": false,
                            "defaultMatch": false,
                            "display": true,
                            "canBeUsedToMatch": true,
                            "type": "string",
                            "removed": false
                        }
                    ],
                    "attemptToConvertTypes": false,
                    "convertFieldsToString": false
                }
            },
            "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
            "typeVersion": 2.2,
            "position": [
                1920,
                1296
            ],
            "id": "83aef0c4-cab3-47c0-bcff-3414e8200347",
            "name": "Call 'InmuebleFinderTool'1"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT \n  id,\n  wa_id,\n  context_data,\n  created_at,\n  updated_at\nFROM user_contexts \nWHERE wa_id = '{{ $json.wa_id }}'\nLIMIT 1;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                5712,
                1488
            ],
            "id": "1e1ca517-163b-46d4-a085-70b8570b90f5",
            "name": "Get Context with Property",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.contacts[0].wa_id }}",
                "options": {
                    "systemMessage": "=use the tool **InmuebleFinderTool** w search term: \"{{ $('Prepare for Property Search').item.json.userPrompt }} or {{ $('Get Context Awating Data').item.json.context_data.aviso }}\".\nYou must respond only with a valid JSON array.\nDo not include Markdown formatting, code fences (`````), explanations, or any text before or after the JSON.\n\nThe JSON must be parsable directly with JSON.parse() in JavaScript.\n\nOutput format required:\n\n[\n  {\n    \"id\": number,\n    \"title\": \"string\",\n    \"slug\": \"string\",\n    \"description\": \"string\",\n    \"ammount\": \"string\",\n    \"colonia\": \"string\",\n    \"municipio\": \"string\",\n    \"estado\": \"string\",\n    \"type\": \"string\",\n    \"operacion\": \"string\",\n    \"estatus\": \"string\",\n    \"rooms\": number,\n    \"baths\": number,\n    \"parkings\": number,\n    \"m2\": \"string\",\n    \"restrictions\": {\n      \"acepta_mascotas\": \"string\",\n      \"acepta_ni√±os\": \"string\",\n      \"acepta_estudiantes\": \"string\",\n      \"acepta_roomies\": \"string\",\n      \"ingresos_minimos\": \"string\",\n      \"precio_poliza\": \"string or null\",\n      \"requiere_comprobantes_ingresos\": boolean,\n      \"observaciones\": \"string\"\n    }\n  }\n]\n\n\n‚ö†Ô∏è Do not wrap your answer inside triple backticks or any markdown block.\n‚ö†Ô∏è Do not include the words ‚Äújson‚Äù or ‚Äúoutput‚Äù before the array.\n\nJust return the array itself ‚Äî nothing else."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                1744,
                1088
            ],
            "id": "67da3650-a689-4a69-8d15-fcec658c820e",
            "name": "AI Agent - Get Property",
            "alwaysOutputData": true
        },
        {
            "parameters": {
                "jsCode": "const previousData = $('Prepare for Property Search').item.json;\nlet raw = $json.output;\nlet propertyFound = false;\nlet propertyData = null;\n\ntry {\n  // üß† Primer parse: convierte el texto escapado en un objeto/array real\n  const parsed = JSON.parse(raw);\n\n  // ‚úÖ Verificamos que efectivamente sea un array con un objeto\n  if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].slug) {\n    const p = parsed[0];\n    propertyFound = true;\n    propertyData = {\n      id: p.id,\n      slug: p.slug,\n      title: p.title,\n      description: p.description,\n      colonia: p.colonia,\n      municipio: p.municipio,\n      estado: p.estado,\n      operacion: p.operacion,\n      ammount: p.ammount,\n      rooms: p.rooms,\n      baths: p.baths,\n      parkings: p.parkings,\n      m2: p.m2,\n      type: p.type,\n      restrictions: p.restrictions || {},\n    };\n  } else {\n    console.warn('‚ö†Ô∏è No se encontr√≥ slug en el resultado parseado.');\n  }\n} catch (err) {\n  console.error('‚ùå Error parseando propiedad:', err.message);\n  console.log('Contenido RAW:', raw);\n}\n\nreturn {\n  wa_id: previousData.wa_id,\n  nombre: previousData.nombre,\n  telefono: previousData.telefono,\n  personaje: previousData.personaje,\n  context_id: previousData.context_id,\n  propertyFound,\n  propertyData,\n};\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2096,
                1088
            ],
            "id": "b7b86486-bc7d-485f-8224-814213e945c9",
            "name": "Parse: Property Information"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('Extract Name & Phone').item.json.wa_id }}",
                "textBody": "=Para continuar, neceisto por favor me proporciones en un solo mensaje:\n\nNombre Completo\nN√∫mero de tel√©fono\n\nSigo al pendiente.",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                -176,
                16
            ],
            "id": "ff15da41-713e-4b26-ae74-c3a4be1eb499",
            "name": "Message: Wrong Name & Phone",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('Extract Name & Phone').item.json.wa_id }}",
                "textBody": "={{ $json.formatted_message }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                2976,
                1088
            ],
            "id": "040f9be5-ec50-49d2-87bb-d200a06709a7",
            "name": "Send message",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{status}',\n      '\"awaiting_questionnaire\"'\n    ),\n    '{property_found}',\n    '{{ $json.propertyData.toJsonString() }}'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                2288,
                1088
            ],
            "id": "516f3099-8c63-4644-91d7-342ffb1abe7b",
            "name": "Update: Costumer Context",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.intent }}",
                                        "rightValue": "property_search",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "cfe22d84-c2c3-4cb0-8a58-84d4a74ed500"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Property Search"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "fec70547-de3d-40c9-9d97-a73c74f4910b",
                                        "leftValue": "={{ $json.intent }}",
                                        "rightValue": "greeting",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Greeting"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "eb6f2f45-f416-4b8d-b47b-510056a95c53",
                                        "leftValue": "={{ $json.intent }}",
                                        "rightValue": "general_inquiry",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "General Inquiry"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "ff0ba65d-04e2-4f17-93f6-e0635cdb1ec7",
                                        "leftValue": "={{ $json.intent }}",
                                        "rightValue": "confirmation",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Confirmation"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "eae60bfa-ae3e-497b-ad36-53db5e479587",
                                        "leftValue": "={{ $json.intent }}",
                                        "rightValue": "negotiation",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Negotiation"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "7c3fbc8e-f957-4100-bc88-06410ce8dc75",
                                        "leftValue": "={{ $json.intent }}",
                                        "rightValue": "out_of_scope",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Out of scope"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                5168,
                1040
            ],
            "id": "49d698d3-457a-44e4-bbae-06ee9e356b54",
            "name": "Switch: Intent"
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "7335f5b8-de3b-423a-8519-36394cc79b76",
                            "leftValue": "={{ $json.status }}",
                            "rightValue": "awaiting_questionnaire",
                            "operator": {
                                "type": "string",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                6512,
                1488
            ],
            "id": "e3a5408e-3f6d-4301-bdcf-e9d4a85b2b1c",
            "name": "If: Is Awaiting Questionaire"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{questionnaire}',\n      '{{ $json.questions.toJsonString() }}'::jsonb\n    ),\n    '{current_question_index}',\n    '0'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                6704,
                1472
            ],
            "id": "5ba248a7-e7d4-48de-b40c-adaf63f7c59f",
            "name": "Execute a SQL query1",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $json.wa_id }}",
                "textBody": "=¬°Perfecto, {{ $json.context_data.nombre.split(' ')[0] }}! üòä\n\n{{ $json.context_data.questionnaire[0].question }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                6896,
                1472
            ],
            "id": "6c77049e-c600-4512-b03c-a2b3417d4a11",
            "name": "Send message5",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const postgresResult = $json;\nconst previousData = $('Get: Message Info').item.json;\n\nconst contextData = postgresResult.context_data || {};\nconst currentStatus = contextData.status || \"new\";\n\nconst isInQuestionnaire = currentStatus === \"awaiting_questionnaire\" && \n                          contextData.questionnaire && \n                          contextData.questionnaire.length > 0;\n\nconst currentIndex = contextData.current_question_index || 0;\nconst totalQuestions = contextData.questionnaire?.length || 0;\n\nreturn {\n  ...previousData,\n  context_id: postgresResult.id,\n  personaje: contextData.personaje || \"\",\n  nombre: contextData.nombre || \"\",\n  currentStatus: currentStatus,\n  isInQuestionnaire: isInQuestionnaire,\n  currentQuestionIndex: currentIndex,\n  totalQuestions: totalQuestions,\n  questionnaire: contextData.questionnaire || [],\n  answers: contextData.answers || {}\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3952,
                784
            ],
            "id": "40536dd5-ad65-4398-a4be-b8c5b1c7bd54",
            "name": "Check Questionnaire Status"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.isInQuestionnaire }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "true",
                                            "singleValue": true
                                        },
                                        "id": "40525fe2-fea0-4c92-b128-dc2dc73ebec1"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "TRUE"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "55c5ed97-3768-4d9d-9cb8-7e5dd20346af",
                                        "leftValue": "={{ $json.isInQuestionnaire }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "false",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "FALSE"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                4192,
                784
            ],
            "id": "31c87846-86a8-44f3-88d1-05b9bcdbd276",
            "name": "Is In Questionnaire"
        },
        {
            "parameters": {
                "jsCode": "const userResponse = $json.userPrompt;\nconst currentIndex = $json.currentQuestionIndex;\nconst questionnaire = $json.questionnaire;\nconst previousAnswers = $json.answers || {};\n\n// Obtener pregunta actual\nconst currentQuestion = questionnaire[currentIndex];\n\n// Guardar respuesta\nconst answers = {\n  ...previousAnswers,\n  [currentQuestion.field]: userResponse\n};\n\n// Verificar si quedan m√°s preguntas\nconst nextIndex = currentIndex + 1;\nconst hasMoreQuestions = nextIndex < questionnaire.length;\n\nreturn {\n  wa_id: $json.wa_id,\n  nombre: $json.nombre,\n  personaje: $json.personaje,\n  context_id: $json.context_id,\n  currentQuestionField: currentQuestion.field,\n  currentAnswer: userResponse,\n  answers: answers,\n  nextQuestionIndex: nextIndex,\n  hasMoreQuestions: hasMoreQuestions,\n  nextQuestion: hasMoreQuestions ? questionnaire[nextIndex] : null,\n  totalQuestions: questionnaire.length,\n  questionnaire: questionnaire\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                4432,
                768
            ],
            "id": "28ff693b-3d9a-410f-86bb-cd36fe56bc01",
            "name": "Process Answer & Next Question",
            "alwaysOutputData": false
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{answers}',\n      '{{ $json.answers.toJsonString() }}'::jsonb\n    ),\n    '{current_question_index}',\n    '{{ $json.nextQuestionIndex }}'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                4640,
                480
            ],
            "id": "4ed9ea0b-1e7e-425f-95a1-25f9548506f3",
            "name": "Update: Context questions",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.hasMoreQuestions }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "true",
                                            "singleValue": true
                                        },
                                        "id": "9d1e7db8-76f4-4019-8169-51090760d627"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "TRUE"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "876e9470-34b5-46d9-bdef-92f8de3c819f",
                                        "leftValue": "={{ $json.hasMoreQuestions }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "false",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "FALSE"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                4672,
                768
            ],
            "id": "218f568b-f9b0-4ec5-acf6-c8909e0ca08e",
            "name": "Has More Questions?"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('Extract Name & Phone').item.json.wa_id }}",
                "textBody": "=Gracias {{ $json.nombre.split(' ')[0] }}, dame por favor un momento, estoy trabajando tu solicitud",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                1552,
                1088
            ],
            "id": "93bf7f79-c6ab-49d1-86eb-4b7532dfe5da",
            "name": "Send message4",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $json.wa_id }}",
                "textBody": "={{ $json.nextQuestion.question }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                4896,
                480
            ],
            "id": "a40764f4-e618-44f8-91dc-c4bcc7fb4273",
            "name": "Send message6",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.isApproved }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "true",
                                            "singleValue": true
                                        },
                                        "id": "d4698e59-8af4-4d53-ae63-9b26b2ed4d2e"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Aprobado"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "2eebac30-5c99-4607-bf96-11199bf84bd6",
                                        "leftValue": "={{ $json.isApproved }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "false",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Rechazado"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                5408,
                784
            ],
            "id": "e5496147-52cb-4a2f-ab04-256480c4a3f1",
            "name": "Switch1"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      jsonb_set(\n        context_data,\n        '{status}',\n        '\"approved\"'::jsonb\n      ),\n      '{rechazo_previo}',\n      'false'::jsonb\n    ),\n    '{approved_at}',\n    to_jsonb(CURRENT_TIMESTAMP)\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                5696,
                560
            ],
            "id": "e5871a65-9009-4670-b713-91b9e99fb137",
            "name": "Execute a SQL query2",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      jsonb_set(\n        context_data,\n        '{status}',\n        '\"rejected\"'::jsonb\n      ),\n      '{rechazo_previo}',\n      'true'::jsonb\n    ),\n    '{motivo_rechazo}',\n    '{{ $json.rejectionReasons.toJsonString() }}'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                5680,
                800
            ],
            "id": "b8bb9dd6-47a2-416d-9989-5bc2ff95a419",
            "name": "Execute a SQL query3",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $json.wa_id }}",
                "textBody": "=¬°Excelentes noticias, {{ $json.nombre.split(' ')[0] }}! üéâ\n\nTu perfil cumple con todos los requisitos del arrendador ‚úÖ. \n\nNuestro equipo se pondr√° en contacto contigo en las pr√≥ximas 24 horas para coordinar la visita al inmueble.\n\n¬°Gracias por tu inter√©s! üòä",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                5200,
                464
            ],
            "id": "c1ea7300-2c5c-4194-9a3c-d9c9d823f318",
            "name": "Message: Aprobado",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $json.wa_id }}",
                "textBody": "=Gracias por tu tiempo, {{ $json.context_data.nombre.split(' ')[0] }}.\n\nLamentablemente, en este momento no cumples con todos los requisitos establecidos por el arrendador para este inmueble en particular.\n\nSi tienes alguna duda, con gusto puedes contactarnos.\n\n¬°Te deseamos mucho √©xito en tu b√∫squeda! üè°",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                5888,
                800
            ],
            "id": "a4ecdc5b-2e78-4481-a265-e4e5013f38cd",
            "name": "Message: Rejected",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.userPrompt }}",
                "options": {
                    "systemMessage": "=Tu funci√≥n ser√° rechazar al contacto, tienes que indicarle que previamente nos contact√≥ por el inmueble ubicado en {{ $json.inmuebles_consultados.colonia }} con un precio de renta de {{ $json.inmuebles_consultados.ammount }}, debes analizar por que se realiz√≥ el rechazo con la informaci√≥n que tienes en {{ $json.motivo_rechazo }}.\nSi la persona insiste, tienes que decirle amablemente que no puedes cambiar una decisi√≥n tomada previamente."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                6624,
                992
            ],
            "id": "ee2b3851-1e0f-407b-9564-55f3210cb2ca",
            "name": "AI Agent"
        },
        {
            "parameters": {
                "sessionIdType": "customKey",
                "sessionKey": "={{ $('Actual Status').item.json.wa_id }}"
            },
            "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
            "typeVersion": 1.3,
            "position": [
                6816,
                1184
            ],
            "id": "2f7231c6-8391-4461-b71f-1c78666a6fa4",
            "name": "Simple Memory"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('Actual Status').item.json.wa_id }}",
                "textBody": "={{ $json.output }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                6928,
                992
            ],
            "id": "17afd37c-85f9-4994-b9e4-1b1ef521f4dc",
            "name": "Message: Reject",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const apiResponse = $json;\nconst whatsappData = $('WhatsApp Trigger').item.json || {};\n\nconst tryParseJson = (value) => {\n  if (typeof value !== 'string') return null;\n  try {\n    return JSON.parse(value);\n  } catch (error) {\n    console.log('No se pudo convertir el valor a JSON:', error.message);\n    return null;\n  }\n};\n\nconst looksLikeContact = (value) => {\n  if (!value || typeof value !== 'object') return false;\n  const keys = Object.keys(value);\n  const hints = [\n    'id',\n    'uuid',\n    'contact_id',\n    'telefono',\n    'phone',\n    'nombre',\n    'status',\n    'estado',\n    'rechazo_previo',\n    'resumen_interacciones',\n    'etiquetas'\n  ];\n  return hints.some((hint) => keys.includes(hint));\n};\n\nconst extractContact = (value) => {\n  if (!value) return null;\n  if (typeof value === 'string') {\n    const parsed = tryParseJson(value);\n    return parsed ? extractContact(parsed) : null;\n  }\n  if (Array.isArray(value)) {\n    for (const item of value) {\n      const candidate = extractContact(item);\n      if (candidate) return candidate;\n    }\n    return null;\n  }\n  if (typeof value === 'object') {\n    if (looksLikeContact(value)) {\n      return value;\n    }\n\n    const nestedKeys = ['data', 'result', 'payload', 'body', 'contact', 'contacto'];\n    for (const key of nestedKeys) {\n      if (key in value) {\n        const candidate = extractContact(value[key]);\n        if (candidate) return candidate;\n      }\n    }\n  }\n  return null;\n};\n\nconst normalizeBoolean = (value) => {\n  if (typeof value === 'boolean') return value;\n  if (typeof value === 'number') return value !== 0;\n  if (typeof value === 'string') {\n    const normalized = value.trim().toLowerCase();\n    if (!normalized) return false;\n    return [\n      'true',\n      '1',\n      'yes',\n      'si',\n      's√≠',\n      'rechazado',\n      'rejected',\n      'blocked',\n      'bloqueado'\n    ].includes(normalized);\n  }\n  if (Array.isArray(value)) {\n    return value.some((entry) => normalizeBoolean(entry));\n  }\n  if (value && typeof value === 'object') {\n    return Object.values(value).some((entry) => normalizeBoolean(entry));\n  }\n  return false;\n};\n\nconst getFirstString = (...values) => {\n  for (const value of values) {\n    if (typeof value === 'string' && value.trim()) {\n      return value.trim();\n    }\n  }\n  return '';\n};\n\nconst contactRecord = extractContact(apiResponse);\nconst contactExists = Boolean(contactRecord);\nconst contactId = contactRecord?.id ?? contactRecord?.contact_id ?? contactRecord?.uuid ?? contactRecord?.telefono ?? contactRecord?.phone ?? null;\n\nlet hasRejectionHistory = false;\nif (contactRecord) {\n  const rejectionHints = [\n    contactRecord.rechazo_previo,\n    contactRecord.isRejected,\n    contactRecord.rechazado,\n    contactRecord.estado,\n    contactRecord.status,\n    contactRecord.etiquetas\n  ];\n  hasRejectionHistory = rejectionHints.some((hint) => normalizeBoolean(hint));\n}\n\nconst rejectionSummary = contactRecord\n  ? getFirstString(\n      contactRecord.resumen_interacciones,\n      contactRecord.resumen,\n      contactRecord.comentarios,\n      contactRecord.nota,\n      contactRecord.notas\n    )\n  : '';\n\nconst userMessage = whatsappData.messages?.[0]?.text?.body ?? '';\nconst waId = whatsappData.contacts?.[0]?.wa_id ?? null;\nconst sanitizedContact = contactRecord ? JSON.parse(JSON.stringify(contactRecord)) : null;\n\nreturn {\n  wa_id: waId,\n  userMessage,\n  contactExists,\n  contactId,\n  contactData: sanitizedContact,\n  hasRejectionHistory,\n  rejectionSummary\n};\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3152,
                768
            ],
            "id": "8fb6ba44-9c53-4e58-81b4-9093bb814216",
            "name": "Contact Actions"
        },
        {
            "parameters": {
                "jsCode": "const contactData = $('Contact Actions').item.json;\nconst whatsappData = $('WhatsApp Trigger').item.json;\n\n// Preparar datos en el formato que espera el Switch original\nreturn {\n  messages: whatsappData.messages,\n  contacts: whatsappData.contacts,\n  // Datos adicionales del contacto\n  _contactExists: contactData.contactExists,\n  _contactId: contactData.contactId,\n  _contactData: contactData.contactData,\n  _hasRejectionHistory: contactData.hasRejectionHistory\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3696,
                784
            ],
            "id": "64df679f-4760-45c5-8f5b-8926cf0c72a4",
            "name": "Prepare Message Data"
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "value": "gpt-5-nano",
                    "mode": "list",
                    "cachedResultName": "gpt-5-nano"
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.2,
            "position": [
                1712,
                1312
            ],
            "id": "041ed8e1-cad5-4923-9104-125884911d85",
            "name": "OpenAI Chat Model1",
            "credentials": {
                "openAiApi": {
                    "id": "g8OPzRDvvB6YO7mf",
                    "name": "OpenAi account"
                }
            }
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "value": "gpt-5-nano",
                    "mode": "list",
                    "cachedResultName": "gpt-5-nano"
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.2,
            "position": [
                6608,
                1184
            ],
            "id": "c135ef47-12d0-4e65-bbdd-ab1e3cedd0bd",
            "name": "OpenAI Chat Model2",
            "credentials": {
                "openAiApi": {
                    "id": "g8OPzRDvvB6YO7mf",
                    "name": "OpenAi account"
                }
            }
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.isAwaitingData }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "true",
                                            "singleValue": true
                                        },
                                        "id": "911b08be-9c60-4621-ac3e-8c0316f75792"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Is Awaiting"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "da44f585-3b7c-4a21-a1e5-b4ed16282b49",
                                        "leftValue": "={{ $json.isAwaitingData }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "false",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "NOT"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                0,
                1104
            ],
            "id": "3ad980f8-6628-4da4-b909-5e3ce48e31fc",
            "name": "Switch: is Awaiting?"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://vg.g210512.com/api/v1/contactos",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"nombre\": \"ü§ñ - {{ $('Extract Name & Phone').item.json.nombre_extracted }}\",\n  \"telefono\": \"{{ $('Extract Name & Phone').item.json.telefono_extracted }}\",\n  \"estado\": \"nuevo\",\n  \"fuente\": \"WhatsApp Bot\"\n}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                912,
                1072
            ],
            "id": "f8e652bc-b64d-4014-801d-58dfc4fdd03f",
            "name": "API: Set new costumer",
            "retryOnFail": true,
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            },
            "onError": "continueRegularOutput"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.context_data.api_contact_id }}/intereses",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"inmueble_id\": {{ $('Parse: Property Information').item.json.propertyData.id }}\n}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                2768,
                1104
            ],
            "id": "009f5297-e15a-4d73-9997-ac80b4813af8",
            "name": "Add Property Interest",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    context_data,\n    '{api_contact_id}',\n    '{{ $json.data.id }}'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get Context Awating Data').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1120,
                1072
            ],
            "id": "489b00a0-0ed4-47b6-b2a6-a228fe401197",
            "name": "Update API Contact ID",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "modelId": {
                    "__rl": true,
                    "value": "models/gemini-2.5-flash",
                    "mode": "list",
                    "cachedResultName": "models/gemini-2.5-flash"
                },
                "messages": {
                    "values": [
                        {}
                    ]
                },
                "options": {
                    "systemMessage": "=Eres un validador de respuestas para un cuestionario de renta inmobiliaria.\n\nTienes el cuestionario completo con todas las preguntas y respuestas del usuario.\n\nCUESTIONARIO:\n{{ $json.questionnaire.toJsonString() }}\n\nRESPUESTAS DEL USUARIO:\n{{ $json.answers.toJsonString() }}\n\nREGLAS DE VALIDACI√ìN:\n\nPara preguntas tipo \"boolean\":\n- Si expected = false: el usuario debe decir \"no\", \"ninguno\", \"no tengo\"\n  - Si dice \"s√≠\", \"tengo\", \"claro\", n√∫meros positivos ‚Üí NO CUMPLE\n  - Si es evasivo \"qui√©n sabe\", \"qu√© te importa\" ‚Üí NO CUMPLE (asumir que s√≠ tiene)\n\n- Si expected = true: el usuario debe decir \"s√≠\", \"tengo\", \"claro\"\n  - Si dice \"no\", \"ninguno\" ‚Üí NO CUMPLE\n\nPara preguntas tipo \"number_minimum\":\n- Extrae el n√∫mero de la respuesta del usuario\n- Compara si es >= al expected\n- Ejemplos: \"gano 32000\" ‚Üí 32000, \"35 mil\" ‚Üí 35000\n\nRESPONDE CON UN JSON ARRAY con esta estructura:\n\n[\n  {\n    \"campo\": \"mascotas\",\n    \"pregunta\": \"¬øTienes mascotas?\",\n    \"respuesta_usuario\": \"Si tengo un westie\",\n    \"expected\": false,\n    \"valor_interpretado\": true,\n    \"cumple\": false,\n    \"razon\": \"Se esperaba NO tener mascotas, pero el usuario tiene un perro\"\n  },\n  {\n    \"campo\": \"ingresos\",\n    \"pregunta\": \"¬øCu√°l es tu ingreso mensual?\",\n    \"respuesta_usuario\": \"Gano 32000\",\n    \"expected\": 30000,\n    \"valor_interpretado\": 32000,\n    \"cumple\": true,\n    \"razon\": \"Ingresos de $32,000 superan el m√≠nimo de $30,000\"\n  }\n]\n\nIMPORTANTE:\n- NO uses markdown (```json)\n- Analiza TODOS los campos del cuestionario\n- S√© estricto con los requisitos"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.googleGemini",
            "typeVersion": 1,
            "position": [
                4912,
                784
            ],
            "id": "89c05320-4f22-4cc2-9362-f4ae848f8999",
            "name": "Message a model1",
            "credentials": {
                "googlePalmApi": {
                    "id": "3Qw3858fHslDYr4D",
                    "name": "Gemini - alfgow"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const isAudio = $input.item.json.messages ? false : true;\n\nif (isAudio) {\n  const wa_id = $('WhatsApp Trigger').item.json.contacts[0].wa_id;\n  const phone = wa_id.replace(/^521/, ''); // elimina el prefijo 521 solo si est√° al inicio\n\n  return {\n    userPrompt: $json.content.parts[0].text,\n    type: \"audio\",\n    ai: \"\",\n    wa_id,\n    phone\n  };\n} else {\n  const wa_id = $json.contacts[0].wa_id;\n  const phone = wa_id.replace(/^521/, '');\n\n  return {\n    userPrompt: $json.messages[0].text.body,\n    type: $json.messages[0].type,\n    ai: \"\",\n    wa_id,\n    phone\n  };\n}\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                496,
                464
            ],
            "id": "b3b88c60-5829-466a-86aa-dbab50efbd94",
            "name": "Get: Message Info"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.hasRejectionHistory }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "true",
                                            "singleValue": true
                                        },
                                        "id": "9cd9e84b-29b5-4b88-a16c-b4ab8f71d3d1"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Rejection"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "6b1f1f79-9885-4085-b360-d943b9948656",
                                        "leftValue": "={{ $json.contactExists }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "true",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Exists"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "dce569ae-ec35-4393-8d21-b231b955d11a",
                                        "leftValue": "={{ $json.contactExists }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "false",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "New"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                3392,
                752
            ],
            "id": "5e17f03f-cfb2-4eaa-b0c1-138621cf5029",
            "name": "Actual status of contact"
        },
        {
            "parameters": {
                "jsCode": "const postgresResult = $json;\nconst previousData = $('Get: Message Info').item.json;\n\n// Si hay un ID en Postgres, significa que ya tenemos contexto\nconst hasContext = postgresResult && postgresResult.id;\n\nreturn {\n  ...previousData,\n  ...postgresResult, \n  hasPostgresContext: hasContext,  // ‚Üê Este campo faltaba en el output\n  postgresContextId: postgresResult.id || null\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1040,
                464
            ],
            "id": "e83d868e-4024-4ba4-b09e-263f60dd8daa",
            "name": "Has Postgres Context?"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.postgresContextId }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "number",
                                            "operation": "notExists",
                                            "singleValue": true
                                        },
                                        "id": "7200cba5-e9be-48ed-8051-a6193620c86a"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Need Check"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "c77aa4d5-afc8-4b56-943b-1d8bc9f762f8",
                                        "leftValue": "={{ $json.postgresContextId }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "number",
                                            "operation": "exists",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Skip Check"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                2704,
                784
            ],
            "id": "eb991fa3-751f-461b-8069-7adaa7bded6d",
            "name": "Need Contact Check?"
        },
        {
            "parameters": {
                "jsCode": "const geminiResponse = $json.content.parts[0].text;\nconst previousData = $('Has More Questions?').item.json;\n\n// Parsear el JSON que viene como texto\nlet validationResults = [];\ntry {\n  validationResults = JSON.parse(geminiResponse);\n} catch (error) {\n  console.error('Error parseando validaci√≥n:', error);\n}\n\n// Determinar si est√° aprobado\nconst isApproved = validationResults.every(item => item.cumple === true);\nconst rejectionReasons = validationResults\n  .filter(item => !item.cumple)\n  .map(item => item.razon);\n\nreturn {\n  wa_id: previousData.wa_id,\n  nombre: previousData.nombre,\n  personaje: previousData.personaje,\n  context_id: previousData.context_id,\n  isApproved: isApproved,\n  rejectionReasons: rejectionReasons,\n  validationResults: validationResults,\n  answers: previousData.answers\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                5232,
                784
            ],
            "id": "dea493c3-9560-4de7-a9d8-073bef390102",
            "name": "Parse Gemini Validation"
        },
        {
            "parameters": {
                "modelId": {
                    "__rl": true,
                    "value": "models/gemini-2.5-flash",
                    "mode": "list",
                    "cachedResultName": "models/gemini-2.5-flash"
                },
                "messages": {
                    "values": [
                        {}
                    ]
                },
                "options": {
                    "systemMessage": "=Genera un resumen ejecutivo de la interacci√≥n para el equipo de la inmobiliaria.\n\nDATOS DE LA INTERACCI√ìN:\n{{ $('Execute a SQL query2').item.json.context_data.toJsonString() }}\n\nFORMATO REQUERIDO:\n- APROBADO - üéâ\n\n**Contacto:** {{ $('Execute a SQL query2').item.json.context_data.nombre }}\n**Tel√©fono:** {{ $('Execute a SQL query2').item.json.context_data.telefono }}\n**Personaje atendi√≥:** {{ $('Execute a SQL query2').item.json.context_data.personaje }}\n\n**üìç Propiedad de Inter√©s:**\n- {{ $('Execute a SQL query2').item.json.context_data.property_found.title }}\n- {{ $('Execute a SQL query2').item.json.context_data.property_found.colonia }}, {{ $('Execute a SQL query2').item.json.context_data.property_found.municipio }}\n- Renta: {{ $('Execute a SQL query2').item.json.context_data.property_found.ammount }}\n\n**‚úÖ Validaci√≥n del Perfil:**\nEl contacto cumpli√≥ con TODOS los requisitos:\n- Sin mascotas ‚úÖ\n- Sin ni√±os ‚úÖ\n- No es estudiante sin tutor ‚úÖ\n- No vivir√° con roomies ‚úÖ\n- Ingresos comprobables: ${{ $('Execute a SQL query2').item.json.context_data.answers.ingresos }} (superior al m√≠nimo de ${{ $('Execute a SQL query2').item.json.context_data.property_found.restrictions.ingresos_minimos }}) ‚úÖ\n- Cuenta con comprobantes v√°lidos ‚úÖ\n\n**üìã Pr√≥ximos Pasos:**\n1. Contactar al cliente en las pr√≥ximas 24 horas\n2. Coordinar visita al inmueble\n3. Preparar documentaci√≥n requerida\n\n**Estado:** APROBADO para continuar proceso de renta üè°"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.googleGemini",
            "typeVersion": 1,
            "position": [
                5872,
                560
            ],
            "id": "b439882d-441f-4aae-b4dc-e248bdf4fba6",
            "name": "Generate Resume",
            "credentials": {
                "googlePalmApi": {
                    "id": "3Qw3858fHslDYr4D",
                    "name": "Gemini - alfgow"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const aiResponse = $json.content.parts[0].text;\nconst contextData = $('Execute a SQL query2').first().json.context_data;\n\nreturn {\n  contactId: contextData.api_contact_id,\n  body: {\n    comentario: aiResponse,\n    created_at: new Date().toISOString()\n  }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                6192,
                560
            ],
            "id": "63664fc6-1de9-435f-8e75-34d604daa7ea",
            "name": "Parse Resume"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.contactId }}/comentarios",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"comentario\": {{ $json.body.comentario.toJsonString() }}\n}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                6416,
                560
            ],
            "id": "affba61c-96ff-4d81-bc60-d27e0f10096e",
            "name": "HTTP Request",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT \n  id,\n  wa_id,\n  context_data,\n  created_at,\n  updated_at\nFROM user_contexts \nWHERE wa_id = '{{ $json.wa_id }}'\nLIMIT 1;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                3232,
                1408
            ],
            "id": "94e8d2ba-3739-4f34-b005-a07fc199305f",
            "name": "Get: User Context General Inq or Out Scope",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "mode": "list",
                    "value": "gpt-4.1-mini"
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.2,
            "position": [
                3424,
                1648
            ],
            "id": "36f824a6-8cd6-4694-a569-b429af51c885",
            "name": "OpenAI Chat Model",
            "credentials": {
                "openAiApi": {
                    "id": "g8OPzRDvvB6YO7mf",
                    "name": "OpenAi account"
                }
            }
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.wa_id }}",
                "options": {
                    "systemMessage": "=Tu funci√≥n es analizar el mensaje del cliente y determinar su requerimiento de manera estructurada, siempre devolviendo un JSON limpio.\n\n## ENTRADAS\n- Mensaje del cliente: {{ $('WhatsApp Trigger').item.json.messages[0].text.body }}\n- Context data: {{ $('Get: User Context General Inq or Out Scope').item.json.context_data.toJsonString() }}\n\n## INSTRUCCIONES\n\n1. Analiza el mensaje y el contexto para descubrir el requerimiento real del cliente.\n\n2. Si el mensaje contiene alguna **groser√≠a, agresi√≥n, palabra profana o acoso**, debes:\n   - Generar un JSON donde:\n     - `message` sea un aviso al cliente indicando que su comportamiento ha sido reportado y no podr√°s continuar la atenci√≥n.\n     - `contexto` describa el mensaje ofensivo detectado.\n     - `requiereAtencion` sea `false`.\n\n3. Si el **context data** contiene un estado de **rechazo** (`status = \"rejected\"`, `rechazo_previo = true` o motivo de rechazo presente):\n   - Env√≠a un mensaje al cliente indicando amablemente que, **debido al motivo de rechazo previo**, no es posible continuar la atenci√≥n.\n   - Incluye en `contexto` el motivo de rechazo.\n   - `requiereAtencion` debe ser `false`.\n\n4. Si **no hay informaci√≥n previa en context data**, o el prospecto no est√° identificado:\n   - Env√≠a un mensaje breve, amable y coherente, indicando que **solo puedes atender solicitudes relacionadas con Inmobiliaria Villanueva Garc√≠a**.\n   - `requiereAtencion` debe ser `false`.\n\n5. Si **el contexto previo est√° aprobado o requiere seguimiento activo** (`status` = \"approved\", \"requiere_atention\", \"requires_attention\" o similar, o `approved_at` existe sin un rechazo posterior):\n   - Interpreta el mensaje actual para descubrir qu√© requiere (por ejemplo: confirmar cita, pedir seguimiento, solicitar informaci√≥n adicional, etc.).\n   - Genera una respuesta emp√°tica, **sin preguntas abiertas**, simplemente informando al cliente que su solicitud ya fue notificada al equipo correspondiente para pronta atenci√≥n.\n   - Refuerza que se dar√° seguimiento y evita redirigir al bot.\n   - Ejemplo de tono correcto:  \n     üëâ \"Muchas gracias por tu mensaje, {{ $('Get: User Context General Inq or Out Scope').item.json.context_data.nombre.split(' ')[0] }}, te confirmo que en este momento he notificado nuevamente tu solicitud al equipo para su pronta atenci√≥n.\"  \n   - Ejemplo de tono incorrecto:  \n     üö´ \"¬øPodr√≠as confirmarme a qu√© cita te refieres?\"  \n   - `requiereAtencion` debe ser `true`.\n\n6. En todos los casos, **la salida DEBE SER EXCLUSIVAMENTE** un arreglo JSON con este formato exacto (sin explicaciones, sin markdown):\n\n[\n  {\n    \"message\": \"mensaje coherente y amable para enviar al cliente\",\n    \"contexto\": \"breve descripci√≥n del requerimiento o motivo de respuesta\",\n    \"requiereAtencion\": true o false,\n    \"timestamp\": \"{{ $now.toISO() }}\"\n  }\n]\n\n## REGLAS DE FORMATO\n- No incluyas texto antes ni despu√©s del JSON.\n- No uses comillas triples, markdown, ni explicaciones.\n- Aseg√∫rate de que el JSON sea v√°lido y pueda parsearse directamente con JSON.parse().\n- Evita cualquier pregunta o frase abierta. El tono debe ser profesional, informativo y cerrado."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                3424,
                1408
            ],
            "id": "24470aea-9078-47d6-b9f0-d9937f62b02d",
            "name": "AI General Inq or Out Scope"
        },
        {
            "parameters": {
                "sessionIdType": "customKey",
                "sessionKey": "={{ $json.wa_id }}"
            },
            "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
            "typeVersion": 1.3,
            "position": [
                3600,
                1648
            ],
            "id": "01288a16-2d91-4fd7-9029-0e9f00b105c1",
            "name": "Simple Memory1"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('Get: User Context General Inq or Out Scope').item.json.wa_id }}",
                "textBody": "={{ $json.message }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                3936,
                1408
            ],
            "id": "3a4db324-133e-4cf4-9b2c-dc665b0fce19",
            "name": "Message: General Inq or Out Scope",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// ===================================================\n// NODE: Parse AI JSON\n// ===================================================\n// Este nodo toma la respuesta cruda de la IA (por ejemplo, del nodo \"AI Agent\")\n// y la convierte en datos estructurados.\n// Espera un JSON en formato:\n// [\n//   {\n//     \"message\": \"...\",\n//     \"contexto\": \"...\",\n//     \"requiereAtencion\": true,\n//     \"timestamp\": \"2025-11-06T22:13:00Z\"\n//   }\n// ]\n// ===================================================\n\nconst raw = $json.output || $json.text || $json.message || '';\n\nlet parsed = [];\n\ntry {\n  // El modelo a veces devuelve texto con espacios o saltos de l√≠nea,\n  // as√≠ que limpiamos y detectamos el bloque JSON.\n  const jsonMatch = raw.match(/\\[.*\\]/s);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No se encontr√≥ un arreglo JSON v√°lido en la respuesta.');\n  }\n} catch (err) {\n  return [\n    {\n      json: {\n        error: true,\n        message: 'Error al parsear la salida de la IA',\n        detalle: err.message,\n        raw_output: raw,\n      },\n    },\n  ];\n}\n\n// Si todo sali√≥ bien, devolvemos cada elemento del arreglo como un item nuevo\nreturn parsed.map(entry => ({\n  json: {\n    message: entry.message || '',\n    contexto: entry.contexto || '',\n    requiereAtencion: entry.requiereAtencion ?? false,\n    timestamp: entry.timestamp || new Date().toISOString(),\n  },\n}));\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3744,
                1408
            ],
            "id": "3ea93dc7-146e-4fe0-946c-cdb475e6c7ab",
            "name": "Parse: AI Response"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://vg.g210512.com/api/v1/contactos/{{ $('Get: User Context General Inq or Out Scope').item.json.context_data.api_contact_id }}/comentarios",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"comentario\": \"ü§ñ - El contacto escribi√≥: {{ $('WhatsApp Trigger').item.json.messages[0].text.body }} // Respuesta: {{ $('Parse: AI Response').item.json.message }}\"\n}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                4304,
                1408
            ],
            "id": "c69c32e0-2356-4197-9145-d08bfa900311",
            "name": "HTTP Request1",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{status}',\n      '\"requiere_atention\"'\n    ),\n    '{last_query}',\n    to_jsonb('{{ $('WhatsApp Trigger').item.json.messages[0].text.body }}'::text)\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                4496,
                1408
            ],
            "id": "01366ef6-2b04-4263-b28f-e368eae01b0e",
            "name": "Update: Status awaiting1",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "authentication": "webhook",
                "content": "=üì¢ **ATENCI√ìN PENDIENTE**\n\nüßç‚Äç‚ôÇÔ∏è **Prospecto:** *{{ $('Get: User Context General Inq or Out Scope').item.json.context_data.nombre }}*  \nüì± **Tel√©fono:**   {{ $('Get: User Context General Inq or Out Scope').item.json.wa_id }}\nüè° **Origen:** *ü§ñ - AI WhatsApp*  \nüïê **Hora:** {{ new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' }) }}  \n\nüí¨ **√öltimo mensaje del cliente:**  \n> {{ $('WhatsApp Trigger').item.json.messages[0].text.body }}\n\nüìå **Situac√≠on Actual:**  \n> {{ $json.contexto || 'Solicita atenci√≥n o confirmaci√≥n de cita.' }}\n\n---\n\n‚ö° **Acci√≥n sugerida:**  \nEl prospecto ya fue **notificado** que su solicitud est√° siendo atendida.  \nPor favor, **asigna un asesor o confirma seguimiento** en los pr√≥ximos minutos.  \n",
                "options": {}
            },
            "type": "n8n-nodes-base.discord",
            "typeVersion": 2,
            "position": [
                4128,
                1408
            ],
            "id": "c9cf24d2-a975-4896-bd9f-3f443a08c813",
            "name": "Discord: Attention Message",
            "webhookId": "d0a56f58-550a-46fa-bb94-26037d82b649",
            "credentials": {
                "discordWebhookApi": {
                    "id": "T5xO2IcTLSwkGbFt",
                    "name": "Discord Webhook account"
                }
            }
        },
        {
            "parameters": {
                "authentication": "webhook",
                "content": "=üì¢ **NUEVO CONTACTO FILTRADO**\n\nüßç‚Äç‚ôÇÔ∏è **Prospecto:** *{{ $('Switch1').item.json.nombre }}*  \nüì± **Tel√©fono:**   {{ $json.contacts[0].wa_id.substring(3) }}\nüè° **Origen:** *ü§ñ - AI WhatsApp*  \nüïê **Hora:** {{ new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' }) }}  \n\nüìå **Situac√≠on Actual:**  \n> Contacto cumple con requisitos\n\n---\n\n‚ö° **Acci√≥n sugerida:**  \nEl prospecto ya fue **APROBADO** por nuestros est√°ndares, cont√°ctalo.  \n",
                "options": {}
            },
            "type": "n8n-nodes-base.discord",
            "typeVersion": 2,
            "position": [
                5440,
                464
            ],
            "id": "cc4bf055-9853-43e0-b501-7702a3743787",
            "name": "Discord: Approved Message",
            "webhookId": "d0a56f58-550a-46fa-bb94-26037d82b649",
            "credentials": {
                "discordWebhookApi": {
                    "id": "T5xO2IcTLSwkGbFt",
                    "name": "Discord Webhook account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const propertyData = $('Parse: Property Information').item.json.propertyData;\nconst contextData = $json.context_data.property_found;\nconst nombre = $('Parse: Property Information').item.json.nombre.split(' ')[0];\n\n// Formatear montos a moneda mexicana\nconst formatCurrency = (amount) => {\n  if (!amount || amount === 'null' || amount === null) return 'No aplica';\n  const numAmount = parseFloat(amount);\n  return new Intl.NumberFormat('es-MX', {\n    style: 'currency',\n    currency: 'MXN'\n  }).format(numAmount);\n};\n\n// Formatear restricciones\nconst restrictions = propertyData.restrictions;\n\nconst formatRestriction = (field, label) => {\n  const value = restrictions[field];\n  if (value === 'si' || value === 'yes' || value === true) {\n    return '‚úÖ ' + label;\n  } else if (value === 'no' || value === false) {\n    return '‚ùå No se aceptan ' + label.toLowerCase();\n  } else {\n    return '‚ö†Ô∏è ' + label + ': ' + value;\n  }\n};\n\n// Caso especial para mascotas\nlet mascotasText = '';\nif (restrictions.acepta_mascotas === 'no' || restrictions.acepta_mascotas === false) {\n  mascotasText = '‚ùå No se aceptan mascotas';\n} else if (restrictions.acepta_mascotas === 'si' || restrictions.acepta_mascotas === true) {\n  mascotasText = '‚úÖ Solo se acepta una mascota peque√±a (perro o gato peque√±o)';\n} else {\n  mascotasText = '‚ö†Ô∏è Mascotas: ' + restrictions.acepta_mascotas;\n}\n\n// Construir mensaje - usando concatenaci√≥n en lugar de template strings\nconst mensaje = '¬°Listo ' + nombre + '! üôå\\n\\n' +\n'Aqu√≠ tienes la informaci√≥n del inmueble que buscas üè°‚ú®\\n\\n' +\n'üìç ' + contextData.title + '\\n' +\n'üèòÔ∏è ' + contextData.colonia + ', ' + contextData.municipio + '\\n' +\n'üí∞ ' + contextData.operacion + ': ' + contextData.ammount + '\\n' +\n'üõèÔ∏è ' + contextData.rooms + ' rec√°maras | üöø ' + contextData.baths + ' ba√±os | üöó ' + contextData.parkings + ' estacionamientos\\n' +\n'üìê ' + contextData.m2 + ' m¬≤ construidos\\n\\n' +\n  \n'Para continuar con el proceso, necesito hacerte unas breves preguntas para confirmar que cumples con los requisitos del arrendador. ¬øEst√°s listo/a? üòä';\n\nreturn {\n  ...$json,\n  formatted_message: mensaje\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2512,
                1088
            ],
            "id": "b4912f01-15de-44f3-ba44-0580a3864f13",
            "name": "Parse: Message w Property Info"
        },
        {
            "parameters": {
                "jsCode": "const geminiResponse = $input.first().json.output;  // ‚Üê Usar la variable correcta\nconst previousData = $('Get Context with Property').item.json;\n\nlet questions = [];\n\ntry {\n  // Limpiar y parsear\n  const cleanedText = geminiResponse\n    .replace(/```json\\n?/g, '')\n    .replace(/```\\n?/g, '')\n    .trim();\n  \n  questions = JSON.parse(cleanedText);\n} catch (error) {\n  console.error('Error parseando cuestionario:', error);\n  console.error('Contenido recibido:', geminiResponse);\n  \n  // Fallback a preguntas b√°sicas si falla\n  questions = [\n    {\n      field: \"mascotas\",\n      question: \"¬øTienes mascotas? üêïüêà\",\n      type: \"boolean\",\n      expected: false\n    }\n  ];\n}\n\nreturn {\n  status: $('Get Context with Property').first().json.context_data.status,\n  wa_id: previousData.wa_id,\n  nombre: previousData.context_data.nombre,\n  personaje: previousData.context_data.personaje,\n  context_id: previousData.id,\n  questions: questions,\n  totalQuestions: questions.length\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                6304,
                1488
            ],
            "id": "8c40ab2c-caf2-4c8e-b9b1-961fc293ee3c",
            "name": "Parse AI Questionnaire"
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "value": "gpt-5",
                    "mode": "list",
                    "cachedResultName": "gpt-5"
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.2,
            "position": [
                5936,
                1712
            ],
            "id": "06899628-9eee-4176-8709-2e904b723519",
            "name": "OpenAI Chat Model3",
            "credentials": {
                "openAiApi": {
                    "id": "g8OPzRDvvB6YO7mf",
                    "name": "OpenAi account"
                }
            }
        },
        {
            "parameters": {
                "sessionIdType": "customKey",
                "sessionKey": "={{ $json.wa_id }}",
                "contextWindowLength": 10
            },
            "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
            "typeVersion": 1.3,
            "position": [
                6096,
                1712
            ],
            "id": "4a0b2cde-71ba-42fd-814b-fe30daf0f2b5",
            "name": "Simple Memory2"
        },
        {
            "parameters": {
                "content": "## ---> Misbehavior",
                "height": 288,
                "width": 2336
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                416,
                64
            ],
            "typeVersion": 1,
            "id": "d8d608ec-1f18-4839-ae47-b4068334c7fa",
            "name": "Sticky Note"
        },
        {
            "parameters": {
                "modelId": {
                    "__rl": true,
                    "value": "gpt-5-nano",
                    "mode": "list",
                    "cachedResultName": "GPT-5-NANO"
                },
                "messages": {
                    "values": [
                        {
                            "content": "=Tu funci√≥n es analizar el contenido de {{ $json.data.comentario }} para identificar el motivo del rechazo (por ejemplo: lenguaje ofensivo, actitud inapropiada, insistencia indebida o falta de respeto).\n\nCon base en ello, redacta un mensaje breve, claro y profesional que:\n1. Indique que la interacci√≥n ha sido rechazada.\n2. Informe que el contacto ha sido bloqueado por comportamiento inapropiado.\n3. Mantenga un tono amable, emp√°tico y sin agresividad.\n4. Termine con un cierre cordial (por ejemplo: deseando √©xito o buen d√≠a).\n\nEjemplo de estilo esperado:\n\"Ups üòï, derivado de tu mensaje anterior hemos rechazado y bloqueado tu contacto, ya que no se permiten faltas de respeto ni conductas inapropiadas. Te deseamos mucho √©xito en tu b√∫squeda.\"\n\nEvita repetir el texto del ejemplo; genera una versi√≥n coherente y natural adaptada al contexto del comentario recibido.\n",
                            "role": "system"
                        }
                    ]
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.openAi",
            "typeVersion": 1.8,
            "position": [
                2048,
                160
            ],
            "id": "1f424c7f-c0fd-434f-a301-5e91346fa83e",
            "name": "Message a model",
            "credentials": {
                "openAiApi": {
                    "id": "g8OPzRDvvB6YO7mf",
                    "name": "OpenAi account"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "8b83aa35-ef33-4786-a195-3a03ce566f4c",
                            "leftValue": "={{ $json.context_data.status }}",
                            "rightValue": "rejected",
                            "operator": {
                                "type": "string",
                                "operation": "equals",
                                "name": "filter.operator.equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                3952,
                1088
            ],
            "id": "99563666-d7cd-47dd-b882-43e017bc07b0",
            "name": "If"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://vg.g210512.com/api/v1/contactos/{{ $('Check Context Status').item.json.context_data.api_contact_id }}/comentarios",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n\"comentario\":{{ $json.body.comentario.toJsonString() }}\n}\n",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                4144,
                480
            ],
            "id": "e3cd00bc-6e45-48ce-a533-11ed843517ba",
            "name": "Update: Contact Comments1",
            "credentials": {
                "httpBearerAuth": {
                    "id": "QigdAtAlBxHMmIsD",
                    "name": "WA - Bearer Token"
                },
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const aiResponse = $input.first().json;\n\nconst getNodeJson = (nodeName, extractor) => {\n  try {\n    const nodeData = $(nodeName);\n    const item = nodeData?.first?.();\n    if (!item) return undefined;\n    return extractor ? extractor(item) : item.json;\n  } catch (error) {\n    return undefined;\n  }\n};\n\nconst contactId =\n  getNodeJson('Contact Actions', (item) => item.json?.contactId) ??\n  getNodeJson('Actual status of contact', (item) => item.json?.contactData?.id) ??\n  getNodeJson('Has Postgres Context?', (item) => item.json?.api_contact_id) ??\n  getNodeJson('Check Context Status', (item) => item.json?.context_data?.api_contact_id) ??\n  aiResponse?.contactId ??\n  null;\n\nif (!contactId) {\n  throw new Error('No se pudo obtener el contactId para el comentario de rechazo.');\n}\n\nconsole.log('AI Response completo:', JSON.stringify(aiResponse, null, 2));\n\nlet summary = aiResponse?.output ??\n              aiResponse?.content?.parts?.[0]?.text ??\n              aiResponse?.text ??\n              aiResponse;\n\nif (typeof summary === 'object') {\n  summary = JSON.stringify(summary);\n}\n\nif (typeof summary === 'string') {\n  summary = summary.trim();\n}\n\nconsole.log('Summary extra√≠do:', summary);\n\nreturn {\n  contactId,\n  body: {\n    comentario: summary,\n    created_at: new Date().toISOString()\n  }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3936,
                480
            ],
            "id": "3542db32-67b8-4e9c-a778-0217a95c4eab",
            "name": "Format Reject Comment Payload"
        },
        {
            "parameters": {},
            "type": "n8n-nodes-base.merge",
            "typeVersion": 2.1,
            "position": [
                2704,
                480
            ],
            "id": "1c42d86c-4f35-465c-803c-9fd68710c618",
            "name": "Merge Rejection Sources"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "1f2fb1b0-9b10-4f2a-9f1e-2c1a6d0bcd70",
                            "name": "wa_id",
                            "value": "={{ $json.wa_id || $('Has Postgres Context?').item.json.wa_id || $('Contact Actions').item.json.wa_id || $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
                            "type": "string"
                        },
                        {
                            "id": "5a75b457-4b78-4f37-9e9d-4314f38fe0fd",
                            "name": "context_data",
                            "value": "={{ Object.assign({}, $('Check Context Status').item.json.context_data || {}, $json.context_data || {}) }}",
                            "type": "json"
                        },
                        {
                            "id": "d8db9700-84d2-4e4f-aeb8-1d0f8d49fd1b",
                            "name": "rejectionSummary",
                            "value": "={{ $json.rejectionSummary || '' }}",
                            "type": "string"
                        },
                        {
                            "id": "0d439b03-31c2-4ac5-b5df-2fa467db1749",
                            "name": "contactData",
                            "value": "={{ $json.contactData || null }}",
                            "type": "json"
                        },
                        {
                            "id": "6f9dc637-1ab7-4ce8-8f16-2ca36d5e1d5a",
                            "name": "misbehaviorHistoryEntry",
                            "value": "={{ $json.misbehaviorHistoryEntry || null }}",
                            "type": "json"
                        },
                        {
                            "id": "a3d969a0-9434-4986-8d30-2a1523cba4a5",
                            "name": "rejectionSource",
                            "value": "={{ $json.rejectionSummary ? 'actual_status' : 'context_status' }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                2912,
                480
            ],
            "id": "64f6b448-d9d5-439d-b3d5-167a6ab3c5aa",
            "name": "Set: Rejection Payload"
        },
        {
            "parameters": {
                "modelId": {
                    "__rl": true,
                    "value": "models/gemini-2.5-flash",
                    "mode": "list",
                    "cachedResultName": "models/gemini-2.5-flash"
                },
                "messages": {
                    "values": [
                        {
                            "content": "={{ $json.context_data.toJsonString() }}"
                        }
                    ]
                },
                "options": {
                    "systemMessage": "=Tu funci√≥n es analizar el contenido de {{ $json.context_data.mal_comportamiento_historial.toJsonString() }} para identificar el motivo del rechazo (por ejemplo: lenguaje ofensivo, actitud inapropiada, insistencia indebida o falta de respeto).\n\nSiempre debes mencionar que el rechazo es por faltas de respeto o comportamiento inapropiado en previas interacciones\n\nCon base en ello, redacta un mensaje breve, claro y profesional que:\n1. Indique que la interacci√≥n ha sido rechazada.\n2. Informe que el contacto ha sido bloqueado por comportamiento inapropiado.\n3. Mantenga un tono amable, emp√°tico y sin agresividad.\n4. Termine con un cierre cordial (por ejemplo: deseando √©xito o buen d√≠a).\n\nEjemplo de estilo esperado:\n\"Ups üòï, derivado de tu faltas de respeto en interacciones previas hemos rechazado y bloqueado tu contacto, ya que no se permiten faltas de respeto ni conductas inapropiadas. Te deseamos mucho √©xito en tu b√∫squeda.\"\n\nEvita repetir el texto del ejemplo; genera una versi√≥n coherente y natural adaptada al contexto del comentario recibido.\n"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.googleGemini",
            "typeVersion": 1,
            "position": [
                3120,
                480
            ],
            "id": "95873b08-3082-4b93-9aaa-d11d335b9c2f",
            "name": "AI: Create Reject Message",
            "credentials": {
                "googlePalmApi": {
                    "id": "3Qw3858fHslDYr4D",
                    "name": "Gemini - alfgow"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
                "textBody": "={{ $json.content.parts[0].text }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                3424,
                480
            ],
            "id": "9883f439-edfe-4d03-ba4b-edf9dfbdf0fe",
            "name": "Message: Reject 2",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "modelId": {
                    "__rl": true,
                    "value": "models/gemini-2.5-flash",
                    "mode": "list",
                    "cachedResultName": "models/gemini-2.5-flash"
                },
                "messages": {
                    "values": [
                        {}
                    ]
                },
                "options": {
                    "systemMessage": "=\nGenera un resumen ejecutivo de la interacci√≥n para el equipo de la inmobiliaria.\n\nIMPORTANTE AGREGAR AL INICIO DEL RESUMEN: ‚ùå RECHAZADO\n\nCONTEXTO DEL CONTACTO:\nNombre: {{ $('Check Context Status').item.json.context_data.nombre }}\nTel√©fono: {{ $('Check Context Status').item.json.context_data.telefono }}\nHistorial previo: {{ $('Check Context Status').item.json.context_data.mal_comportamiento_historial.toJsonString() }}\n\nINTERACCI√ìN ACTUAL:\nEl contacto escribi√≥: \"{{ $('WhatsApp Trigger').item.json.messages[0].text.body }}\"\n\nRespuesta del bot: {{ $('AI: Create Reject Message').item.json.content.parts[0].text }}\n\nFORMATO REQUERIDO:\nü§ñ **BOT WhatsApp** - {{ $now.format('dd/MM/yyyy HH:mm') }}\n\nüì± **Contacto escribi√≥:**\n[mensaje del usuario]\n\nüîç **Detecci√≥n autom√°tica:**\nSe identific√≥ que este contacto tiene un rechazo previo por: [raz√≥n espec√≠fica del rechazo]\n\nüì§ **Bot respondi√≥:**\n[resumen del mensaje enviado en 2-3 l√≠neas]\n\nüìã **Resultado:**\nContacto rechazado autom√°ticamente. No se continu√≥ con el flujo de atenci√≥n.\n\nINSTRUCCIONES:\n- S√© conciso pero informativo\n- Usa emojis para mejor escaneo visual\n- Menciona la raz√≥n espec√≠fica del rechazo previo\n- M√°ximo 150 palabras\n- Formato markdown para mejor lectura"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.googleGemini",
            "typeVersion": 1,
            "position": [
                3616,
                480
            ],
            "id": "bc51ca45-9f86-47e8-8d0d-2abe1d4e11d5",
            "name": "AI: Create Reject Resume",
            "credentials": {
                "googlePalmApi": {
                    "id": "3Qw3858fHslDYr4D",
                    "name": "Gemini - alfgow"
                }
            }
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.context_data.status }}",
                                        "rightValue": "blocked",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "d47e08b1-4c9d-402c-992e-f00cbb9b3af3"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "blocked"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "ad050447-b659-409e-bcfd-a037caac5943",
                                        "leftValue": "={{ $json.context_data.status }}",
                                        "rightValue": "rejected",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "rejected"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "8d34428d-f6e5-4bf1-adbe-bc9703683fb2",
                                        "leftValue": "={{ $json.context_data.status }}",
                                        "rightValue": "approved",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "approved"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "b60d19ee-3fe2-4014-8416-bdbfee424244",
                                        "leftValue": "={{ $json.postgresContextId }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "number",
                                            "operation": "notExists",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "No context"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "17afc7a8-8bc7-4893-a2a9-bb67e840bce6",
                                        "leftValue": "={{ $json.context_data.status }}",
                                        "rightValue": "awaiting_data",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Awaiting Data"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "b965f87d-6882-4015-ac98-9560bdced08c",
                                        "leftValue": "={{ $json.context_data.status }}",
                                        "rightValue": "awaiting_questionnaire",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Quest"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "6cd8b229-a32e-4354-865f-80a87b2957fd",
                                        "leftValue": "={{ $json.context_data.status }}",
                                        "rightValue": "requiere_atention",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "RequireAttention"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                2384,
                480
            ],
            "id": "6448c5b9-ea3a-425e-9ae8-86db91131480",
            "name": "Switch2"
        },
        {
            "parameters": {
                "jsCode": "// Obtener respuesta de OpenAI\nconst aiResponse = $input.first().json;\nconst contentText = aiResponse.message?.content || aiResponse.output || '';\n\n// Obtener datos originales del nodo anterior a la IA\nconst originalData = $('Has Postgres Context?').item.json;\n\nlet result = {\n  isMisbehavior: false,\n  confidence: 0,\n  reason: '',\n  detectedTerms: []\n};\n\ntry {\n  // Limpiar y parsear el JSON\n  const cleaned = contentText\n    .replace(/```json\\n?/g, '')\n    .replace(/```\\n?/g, '')\n    .trim();\n  \n  result = JSON.parse(cleaned);\n} catch (error) {\n  console.error('Error parsing misbehavior detection:', error);\n  console.log('Content received:', contentText);\n}\n\nreturn {\n  json: {\n    userPrompt: originalData.userPrompt,\n    wa_id: originalData.wa_id,\n    context_data: originalData.context_data,\n    hasPostgresContext: originalData.hasPostgresContext,\n    postgresContextId: originalData.postgresContextId,\n    misbehaviorDetected: result.isMisbehavior,\n    misbehaviorConfidence: result.confidence,\n    misbehaviorReason: result.reason,\n    misbehaviorMatchedWords: result.detectedTerms,\n    phone:$('Get: Message Info').first().json.phone\n  }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1744,
                496
            ],
            "id": "06394ac1-3da8-4bfe-b746-0535c07c0032",
            "name": "Parse Misbehavior"
        },
        {
            "parameters": {
                "modelId": {
                    "__rl": true,
                    "value": "gpt-5-nano",
                    "mode": "list",
                    "cachedResultName": "GPT-5-NANO"
                },
                "messages": {
                    "values": [
                        {
                            "content": "=Eres un detector de comportamiento inapropiado en mensajes de clientes.\n\nMENSAJE DEL CLIENTE: {{ $json.userPrompt }}\n\nINSTRUCCIONES:\nAnaliza si el mensaje contiene:\n- Insultos directos o indirectos\n- Lenguaje ofensivo o profano\n- Amenazas (legales, f√≠sicas, etc)\n- Acoso o discriminaci√≥n\n- Groser√≠as en espa√±ol mexicano\n- Intento de evadir filtros (p3nd3jo, p e n d e j o, etc)\n\nIMPORTANTE:\n- NO marques como ofensivo: quejas leg√≠timas, frustraci√≥n educada, cr√≠ticas constructivas\n- S√ç marca como ofensivo: insultos personales, amenazas, lenguaje agresivo\n\nFORMATO DE SALIDA (JSON):\n{\n  \"isMisbehavior\": true o false,\n  \"confidence\": 0.0 a 1.0,\n  \"reason\": \"Raz√≥n espec√≠fica si es ofensivo, vac√≠o si no\",\n  \"detectedTerms\": [\"lista de t√©rminos ofensivos detectados\"]\n}\n\nNO uses markdown. Solo responde con el JSON.",
                            "role": "system"
                        }
                    ]
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.openAi",
            "typeVersion": 1.8,
            "position": [
                1472,
                496
            ],
            "id": "8302bed3-6cf6-42fb-97c3-dbcce94d828c",
            "name": "AI Misbehavior Detector",
            "retryOnFail": true,
            "credentials": {
                "openAiApi": {
                    "id": "g8OPzRDvvB6YO7mf",
                    "name": "OpenAi account"
                }
            }
        },
        {
            "parameters": {
                "url": "=https://vg.g210512.com/api/v1/contactos?telefono={{ $json.phone }}",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                496,
                160
            ],
            "id": "722df29a-0ac6-4212-882a-18e4def962ed",
            "name": "Get API Contact",
            "alwaysOutputData": true,
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {},
            "type": "n8n-nodes-base.noOp",
            "typeVersion": 1,
            "position": [
                2576,
                160
            ],
            "id": "2eb5fdb6-43e4-43e0-b303-d3dd3dc517ee",
            "name": "No Operation, do nothing1"
        },
        {
            "parameters": {},
            "type": "n8n-nodes-base.noOp",
            "typeVersion": 1,
            "position": [
                1008,
                752
            ],
            "id": "21863796-28d8-4a42-a10e-fcdc4d70990f",
            "name": "No Operation, do nothing2"
        },
        {
            "parameters": {
                "jsCode": "const source = $input.first()?.json ?? {};\nconst clone = (data) => JSON.parse(JSON.stringify(data ?? {}));\nconst contextData = clone(source.context_data);\n\nconst cleanString = (value) => (typeof value === 'string' ? value.trim() : '');\n\nconst reasonText =\n  cleanString(source.misbehaviorReason) ||\n  cleanString(source.reasonText) ||\n  'Comportamiento indebido detectado autom√°ticamente';\n\nconst matchedWords = Array.isArray(source.misbehaviorMatchedWords)\n  ? source.misbehaviorMatchedWords.filter((word) => cleanString(word))\n  : [];\n\nconst originalMessage =\n  cleanString(source.misbehaviorOriginalMessage) ||\n  cleanString(source.userPrompt) ||\n  cleanString(source.originalMessage) ||\n  '';\n\nconst timestamp = new Date().toISOString();\n\nconst historyEntry = {\n  timestamp,\n  mensaje_original: originalMessage,\n  palabras_detectadas: matchedWords,\n  origen: 'auto_filter'\n};\n\nconst history = Array.isArray(contextData.mal_comportamiento_historial)\n  ? [...contextData.mal_comportamiento_historial, historyEntry]\n  : [historyEntry];\n\nconst reasons = Array.isArray(contextData.motivo_rechazo)\n  ? [...contextData.motivo_rechazo]\n  : [];\nif (!reasons.includes(reasonText)) {\n  reasons.push(reasonText);\n}\n\nconst contactLookups = [];\n\ntry {\n  const apiData = $('Get API Contact1')?.first()?.json?.data;\n  if (Array.isArray(apiData) && apiData.length) {\n    contactLookups.push(apiData[0]);\n  }\n} catch (error) {}\n\ntry {\n  const apiData = $('Get API Contact')?.first()?.json?.data;\n  if (Array.isArray(apiData) && apiData.length) {\n    contactLookups.push(apiData[0]);\n  }\n} catch (error) {}\n\nconst apiContactId =\n  source.api_contact_id ??\n  contextData.api_contact_id ??\n  contactLookups.find((contact) => contact?.id)?.id ??\n  null;\n\nif (!apiContactId) {\n  throw new Error('No se encontr√≥ api_contact_id en el contexto para registrar el comentario de bloqueo.');\n}\n\nconst fallbackName =\n  cleanString(source.fallbackName) ||\n  cleanString(source.contactName) ||\n  cleanString(contextData.nombre) ||\n  contactLookups.map((contact) => cleanString(contact?.nombre)).find(Boolean) ||\n  'ü§ñ - Contacto Bloqueado';\n\nconst commentLines = [\n  'üö´ IGNORADO POR BLOQUEO üö´',\n  `Motivo: ${reasonText}`,\n  matchedWords.length ? `Coincidencias: ${matchedWords.join(', ')}` : '',\n  originalMessage ? `Mensaje original: \"${originalMessage}\"` : '',\n  `Registrado el: ${timestamp}`\n].filter((line) => cleanString(line));\n\nconst existingInteractions = Array.isArray(contextData.interacciones)\n  ? contextData.interacciones.map((entry) => ({ ...entry }))\n  : [];\n\nconst userInteraction = {\n  timestamp,\n  actor: 'usuario',\n  canal: 'whatsapp',\n  tipo: 'mensaje_recibido',\n  mensaje: originalMessage,\n  origen: 'auto_filter',\n  detalles: {\n    motivo: reasonText,\n    palabras_detectadas: matchedWords\n  }\n};\n\nconst systemInteraction = {\n  timestamp,\n  actor: 'sistema',\n  canal: 'whatsapp',\n  tipo: 'mensaje_ignorado_por_bloqueo',\n  mensaje: 'Mensaje ignorado por bloqueo activo.',\n  detalles: {\n    motivo: reasonText,\n    comentario: commentLines.join('\\n')\n  }\n};\n\nconst updatedInteractions = [...existingInteractions, userInteraction, systemInteraction];\n\nconst waId =\n  cleanString(source.wa_id) ||\n  cleanString(contextData.wa_id) ||\n  cleanString($('Has Postgres Context?')?.first()?.json?.wa_id) ||\n  cleanString($('Get: Message Info')?.first()?.json?.wa_id) ||\n  cleanString($('WhatsApp Trigger')?.first()?.json?.contacts?.[0]?.wa_id) ||\n  null;\n\nconst updatedContext = {\n  ...contextData,\n  nombre: fallbackName,\n  status: 'blocked',\n  rechazo_previo: true,\n  motivo_rechazo: reasons,\n  mal_comportamiento_historial: history,\n  ultima_interaccion: timestamp,\n  api_contact_id: apiContactId,\n  interacciones: updatedInteractions\n};\n\nreturn [\n  {\n    json: {\n      wa_id: waId,\n      api_contact_id: apiContactId,\n      commentPayload: {\n        comentario: commentLines.join('\\n')\n      },\n      updatedContext,\n      historyEntry,\n      reasonText,\n      matchedWords,\n      originalMessage,\n      timestamp\n    }\n  }\n];\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                496,
                752
            ],
            "id": "7a6c6563-9d47-4f06-896d-80c479bacbbd",
            "name": "Build Blocked Comment Payload"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.api_contact_id }}/comentarios",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ $json.commentPayload.toJsonString() }}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                688,
                752
            ],
            "id": "b484375e-9ded-4266-a7ca-32d0c77f83c9",
            "name": "API: Add Blocked Comment",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts\nSET\n  context_data = '{{ $(\"Build Blocked Comment Payload\").item.json.updatedContext.toJsonString() }}'::jsonb,\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $(\"Build Blocked Comment Payload\").item.json.wa_id }}'\nRETURNING\n  id,\n  wa_id,\n  context_data,\n  context_data->>'api_contact_id' AS api_contact_id;\n\n",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                848,
                752
            ],
            "id": "b0beb604-6144-4ab1-8a8b-8ba1f7971c71",
            "name": "Postgres: Update Blocked Context",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "ac8010bd-97b8-4d50-9ec6-91015177b232",
                            "leftValue": "={{ $json.context_data.status }}",
                            "rightValue": "blocked",
                            "operator": {
                                "type": "string",
                                "operation": "equals",
                                "name": "filter.operator.equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                2128,
                480
            ],
            "id": "07d6ad5a-157d-4c3d-829d-dd6b2db55943",
            "name": "Is Blocked?"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $('Get API Contact1').item.json.data[0].estado }}",
                                        "rightValue": "blocked",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "8281b321-52c2-48a0-aa3b-4b1b0dec841f"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "block-api"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "a894962f-3420-4765-b14e-07d25b097abf",
                                        "leftValue": "={{ $('Check Context Status').item.json.context_data.status }}",
                                        "rightValue": "blocked",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "block-postgres"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "7fb769ac-a83d-49ae-ad30-7187a051316f",
                                        "leftValue": "",
                                        "rightValue": "=",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "nothing"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                1216,
                448
            ],
            "id": "0efa8d8d-7290-4512-8fdf-044def211558",
            "name": "Switch3"
        },
        {
            "parameters": {
                "url": "=https://vg.g210512.com/api/v1/contactos?telefono={{ $json.phone }}",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                672,
                464
            ],
            "id": "941f2fe8-e458-48a4-a39e-47d128f94113",
            "name": "Get API Contact1",
            "alwaysOutputData": true,
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
                "textBody": "Te recuerdo que este chat solo recibe texto y audio.",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                -176,
                400
            ],
            "id": "ca11c89a-21d9-4ae4-9933-ca2b8de9c0a1",
            "name": "Message: Error type",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
                "textBody": "=üòÖ Tuvimos un error de nuestro lado, intenta de nuevo por favor",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                -176,
                224
            ],
            "id": "f9b8fc12-f7e6-4cfe-a5f3-10945566d308",
            "name": "Error Message Our Side",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "content": "## ---> Incoming Message",
                "height": 400,
                "width": 592,
                "color": 4
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                -240,
                592
            ],
            "typeVersion": 1,
            "id": "bb0cbcc1-d4e5-4e0a-a8c7-4d1d698a488e",
            "name": "Sticky Note1"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.messages[0].text.body }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "string",
                                            "operation": "exists",
                                            "singleValue": true
                                        },
                                        "id": "b564c529-0a34-48cf-beaf-0004336706ef"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "text-message"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "250baf65-d4ac-41ab-a455-eb87a917a514",
                                        "leftValue": "={{ $json.messages[0].image }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "object",
                                            "operation": "exists",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "image-message"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "bf6ad2e8-fe57-43c2-8f6e-1b3381f0dcff",
                                        "leftValue": "={{ $json.messages[0].document.mime_type }}",
                                        "rightValue": "image/",
                                        "operator": {
                                            "type": "string",
                                            "operation": "contains"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "document-image"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "ad353bff-2299-4372-a4ea-1feadb00dab2",
                                        "leftValue": "={{ $json.messages[0].document.mime_type }}",
                                        "rightValue": "application/",
                                        "operator": {
                                            "type": "string",
                                            "operation": "contains"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "pdf"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "9c8d220b-1791-4273-bb74-08b2b3f7f319",
                                        "leftValue": "={{ $json.messages[0].audio }}",
                                        "rightValue": "",
                                        "operator": {
                                            "type": "object",
                                            "operation": "exists",
                                            "singleValue": true
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "audio-message"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                128,
                640
            ],
            "id": "6439de3d-ce76-4d6d-a639-697cb0e5eb3f",
            "name": "Switch Type Of Message",
            "onError": "continueErrorOutput"
        },
        {
            "parameters": {
                "content": "## ---> Error Messages",
                "height": 608,
                "width": 272,
                "color": 3
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                -256,
                -48
            ],
            "typeVersion": 1,
            "id": "72516c88-dec4-4987-8e07-45972ef6ef5b",
            "name": "Sticky Note2"
        },
        {
            "parameters": {
                "content": "## ---> Getting Context",
                "height": 224,
                "width": 912,
                "color": 6
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                480,
                400
            ],
            "typeVersion": 1,
            "id": "08eaab9f-5c8f-4a2b-93fc-bcaf1f4ade0e",
            "name": "Sticky Note4"
        },
        {
            "parameters": {
                "content": "## ---> Misbehavior",
                "height": 224,
                "width": 832,
                "color": 2
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                1440,
                400
            ],
            "typeVersion": 1,
            "id": "ac6603ea-6dcd-4883-8950-5c8694807b1c",
            "name": "Sticky Note5"
        },
        {
            "parameters": {
                "content": "## ---> Blocked Process",
                "height": 240,
                "width": 784,
                "color": 3
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                448,
                688
            ],
            "typeVersion": 1,
            "id": "2f477793-2b41-4498-b9a1-e64623d7bc46",
            "name": "Sticky Note7"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts\nSET context_data = jsonb_set(\n      context_data,\n      '{status}',\n      '\"blocked\"',\n      false\n    ),\n    updated_at = NOW()\nWHERE wa_id = CAST({{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }} AS TEXT);",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                4336,
                480
            ],
            "id": "f36f0730-8979-4f72-bb7e-b45aa899adf2",
            "name": "Update User Context Reject",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "content": "## ---> Rejected Flow",
                "height": 272,
                "width": 1904,
                "color": 3
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                2640,
                400
            ],
            "typeVersion": 1,
            "id": "257764eb-26b6-4d2b-989e-929ffa6d2d51",
            "name": "Sticky Note8"
        },
        {
            "parameters": {
                "url": "=https://vg.g210512.com/api/v1/contactos?telefono={{ $json.phone }}",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                2960,
                768
            ],
            "id": "71fe86de-2005-48c2-9a68-a3bbb2bac41c",
            "name": "Get API Contact2",
            "alwaysOutputData": true,
            "credentials": {
                "httpHeaderAuth": {
                    "id": "rzmCtJN8Vtwv6AO3",
                    "name": "API Key Inmuebles"
                }
            }
        },
        {
            "parameters": {
                "content": "## ---> Getting Context",
                "height": 256,
                "width": 1472,
                "color": 6
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                2656,
                720
            ],
            "typeVersion": 1,
            "id": "a903a332-ed9a-474b-87ff-77c47a30ef34",
            "name": "Sticky Note9"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.wa_id }}",
                "options": {
                    "systemMessage": "=Eres un asistente conversacional de una inmobiliaria. Tu tarea es generar un cuestionario personalizado y natural basado en las caracter√≠sticas y restricciones de un inmueble espec√≠fico.\n\nDATOS DEL INMUEBLE:\n{{ $json.context_data.property_found.toJsonString() }}\n\nRESTRICCIONES DEL ARRENDADOR:\n{{ $json.context_data.property_found.restrictions.toJsonString() }}\n\nINSTRUCCIONES:\n\n1. **Genera preguntas conversacionales** siguiendo estos principios:\n   - NUNCA saludes, no pongas palabras como hola, que tal, etc, se supone que tu ya vienes trabajando con el contacto\n   - Primero da contexto o explica la restricci√≥n\n   - Luego pregunta de forma natural\n   - Usa tono amigable y mexicano\n   - Incluye emojis apropiados\n\n2. **Tipos de preguntas a generar:**\n\n   A) **Si NO acepta mascotas** (acepta_mascotas = \"no\"):\n      - Ejemplo: \"¬øTienes mascotas? üêïüêà\"\n      - field: \"mascotas\"\n      - type: \"boolean\"\n      - expected: false\n\n   B) **Si NO acepta ni√±os** (acepta_ni√±os = \"no\"):\n      - Ejemplo: \"Plat√≠came, ¬øcu√°ntas personas habitar√°n el inmueble? ¬øHabr√° ni√±os? üë∂\"\n      - field: \"ninos\"\n      - type: \"boolean\"\n      - expected: false\n\n   C) **Si NO acepta estudiantes sin tutor** (acepta_estudiantes = \"no\"):\n      - Ejemplo: \"Muy bien, plat√≠came ¬øcu√°l es tu ocupaci√≥n actual? üìö\"\n      - field: \"estudiantes\"\n      - type: \"boolean\"\n      - expected: false\n\n   D) **Si NO acepta roomies** (acepta_roomies = \"no\"):\n      - Ejemplo: \"Cu√©ntame, ¬øc√≥mo ser√° tu forma de vivir? ¬øSolo(a) o con roomies? üë•\"\n      - field: \"roomies\"\n      - type: \"boolean\"\n      - expected: false\n\n   E) **Ingresos m√≠nimos** (si existe y > 0):\n      - Ejemplo: \"Una pregunta importante: ¬øcu√°l es tu ingreso mensual comprobable? üíµ (El m√≠nimo requerido es $XX,XXX)\"\n      - field: \"ingresos\"\n      - type: \"number_minimum\"\n      - expected: [valor num√©rico]\n\n   F) **Comprobantes de ingresos** (si requiere_comprobantes_ingresos = true):\n      - Ejemplo: \"¬øCuentas con recibos de n√≥mina, estados de cuenta o facturas que comprueben tus ingresos mensuales? üìã\"\n      - field: \"comprobantes\"\n      - type: \"boolean\"\n      - expected: true\n\n3. **Agrega preguntas adicionales basadas en caracter√≠sticas del inmueble:**\n\n   - **Si parkings = 0**: \"Te comento que el inmueble no cuenta con estacionamiento üöó ¬øEst√°s de acuerdo con eso?\"\n   - **Si tiene m√°s de 3 pisos y no menciona elevador**: \"El depa est√° en el [X] piso y no tiene elevador üè¢ ¬øTienes alg√∫n inconveniente?\"\n   - Cualquier otra caracter√≠stica relevante que valga la pena preguntar\n\nFORMATO DE SALIDA (JSON ARRAY):\n\n[\n  {\n    \"field\": \"mascotas\",\n    \"question\": \"¬øTienes mascotas? üêïüêà\",\n    \"type\": \"boolean\",\n    \"expected\": false\n  },\n  {\n    \"field\": \"estacionamiento\",\n    \"question\": \"Te comento que el inmueble no cuenta con estacionamiento üöó\\n¬øEst√°s de acuerdo con eso?\",\n    \"type\": \"boolean\",\n    \"expected\": true\n  }\n]\n\nIMPORTANTE:\n- NO uses markdown (```json)\n- NO agregues explicaciones\n- Responde SOLO con el JSON array\n- Mant√©n el tono conversacional y natural"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                5968,
                1488
            ],
            "id": "a570d8cf-117d-4e95-896c-97598f905599",
            "name": "AI Generate Dynamic Questionnaire"
        },
        {
            "parameters": {
                "content": "## ---> Questionaire Flow",
                "height": 272,
                "width": 1952
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                4160,
                720
            ],
            "typeVersion": 1,
            "id": "832e801d-4eb8-46b7-9d9c-1cb888057d4c",
            "name": "Sticky Note3"
        },
        {
            "parameters": {},
            "type": "n8n-nodes-base.noOp",
            "typeVersion": 1,
            "position": [
                1344,
                768
            ],
            "id": "e4b51311-f8a2-4117-b042-eec646b752cc",
            "name": "No Operation, do nothing"
        },
        {
            "parameters": {
                "content": "## ---> Awaiting Name & Phone\n",
                "height": 288,
                "width": 1488
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                -208,
                1024
            ],
            "typeVersion": 1,
            "id": "9ae12013-9126-40c2-a95e-71d81e177073",
            "name": "Sticky Note10"
        },
        {
            "parameters": {
                "content": "## ---> Getting Property Info",
                "height": 448,
                "width": 1856,
                "color": 4
            },
            "type": "n8n-nodes-base.stickyNote",
            "position": [
                1312,
                992
            ],
            "typeVersion": 1,
            "id": "6eac9f10-3a37-4a72-a97e-6fbf981ae8bd",
            "name": "Sticky Note11"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
                "textBody": "=¬°Hola {{ $json.nombre.split(' ')[0] }}! üòä Muchas gracias por tu mensaje, te cuento que ya tenemos tu solicitud en seguimiento y estamos trabajando con la informaci√≥n que nos compartiste. En breve un integrante de nuestro equipo te contactar√°.",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                6640,
                768
            ],
            "id": "adbc9897-219e-4c85-8c2c-45c8f781cc87",
            "name": "Message: Interaction In Progress",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "authentication": "webhook",
                "content": "=üì¢ **ATENCI√ìN PENDIENTE**\n\nüßç‚Äç‚ôÇÔ∏è **Prospecto:** *{{ $('Actual Status').item.json.nombre }}*  \nüì± **Tel√©fono:**   {{ $('Actual Status').item.json.telefono }}\nüè° **Origen:** *ü§ñ - AI WhatsApp*  \nüïê **Hora:** {{ new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' }) }}  \n\nüí¨ **√öltimo mensaje del cliente:**  \n> {{ $('WhatsApp Trigger').item.json.messages[0].text.body }}\n\nüìå **Situac√≠on Actual:**  \n> {{ $('Check Context Status').item.json.context_data.status|| 'Solicita atenci√≥n o confirmaci√≥n de cita.' }}\n\n---\n\n‚ö° **Acci√≥n sugerida:**  \nEl prospecto ya fue **notificado** que su solicitud est√° siendo atendida.  \nPor favor, **asigna un asesor o confirma seguimiento** en los pr√≥ximos minutos.  \n",
                "options": {}
            },
            "type": "n8n-nodes-base.discord",
            "typeVersion": 2,
            "position": [
                6880,
                768
            ],
            "id": "7b34a493-1eeb-4603-8ed7-5231aefa6288",
            "name": "Discord: Attention Message1",
            "webhookId": "d0a56f58-550a-46fa-bb94-26037d82b649",
            "credentials": {
                "discordWebhookApi": {
                    "id": "T5xO2IcTLSwkGbFt",
                    "name": "Discord Webhook account"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT COALESCE((\n  SELECT context_data->>'statusBot'\n  FROM user_contexts\n  WHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\n  LIMIT 1\n), 'free') AS \"statusBot\";",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                848,
                656
            ],
            "id": "0cf35937-f09f-4367-8fe4-41ad83131676",
            "name": "Get Bot Status",
            "alwaysOutputData": true,
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "9c945a0f-b0ee-4064-a1ac-81398fae8316",
                            "leftValue": "={{ $json.statusBot }}",
                            "rightValue": "working",
                            "operator": {
                                "type": "string",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                1056,
                656
            ],
            "id": "8c803c83-d682-4b35-b9aa-c972e87bff2c",
            "name": "If: Bot Working?"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "812415788624920",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
                "textBody": "=üëã Hola de nuevo. En este momento sigo trabajando en tu solicitud anterior. Por favor espera un momento y en cuanto termine te ayudar√© enseguida. üôè",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                1264,
                544
            ],
            "id": "10ef5909-6b1f-4527-bfe1-509c75539e7c",
            "name": "Message: Bot Busy",
            "webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
            "credentials": {
                "whatsAppApi": {
                    "id": "DpdLgHZCEJ199330",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO user_contexts (wa_id, context_data, created_at, updated_at)\nVALUES (\n  '{{ $('Get: Message Info').item.json.wa_id }}',\n  jsonb_build_object('statusBot', 'working'),\n  CURRENT_TIMESTAMP,\n  CURRENT_TIMESTAMP\n)\nON CONFLICT (wa_id) DO UPDATE SET\n  context_data = jsonb_set(\n    COALESCE(user_contexts.context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"working\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                1264,
                768
            ],
            "id": "776af727-59d0-4dbf-9eed-f275a367d908",
            "name": "Update: Bot Working",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                5680,
                1088
            ],
            "id": "73989c0f-9548-4a92-849e-b5e813194f99",
            "name": "Update: Bot Free (Welcome)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                32,
                16
            ],
            "id": "57b6fc21-de0f-4fb3-8ac5-46f01af66a3f",
            "name": "Update: Bot Free (Invalid Data)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                3184,
                1088
            ],
            "id": "4dfb6585-afc2-4356-bbc4-747055ac3319",
            "name": "Update: Bot Free (Response)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                7104,
                1472
            ],
            "id": "57679164-1e9c-4db7-962b-8b07092c013b",
            "name": "Update: Bot Free (Questionnaire)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                5104,
                480
            ],
            "id": "00651c14-8b8b-4ecf-9161-49800dc1bbe0",
            "name": "Update: Bot Free (Next Question)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                6096,
                800
            ],
            "id": "dfbfca4f-c7b4-45c5-9bdf-7e921ccf1a53",
            "name": "Update: Bot Free (Reject Auto)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                7136,
                992
            ],
            "id": "83021f6d-474c-4054-87af-2bda969c5278",
            "name": "Update: Bot Free (Manual Review)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                32,
                400
            ],
            "id": "3ab67e6e-7261-4011-b2dd-f371d9d08d42",
            "name": "Update: Bot Free (Invalid Media)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                32,
                224
            ],
            "id": "5987b1f2-4055-4cf0-91f5-744c28004545",
            "name": "Update: Bot Free (Error Side)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                5648,
                464
            ],
            "id": "1478a0df-6b73-475b-afb9-8d3d72bb4ba5",
            "name": "Update: Bot Free (Discord Approved)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    COALESCE(context_data, '{}'::jsonb),\n    '{statusBot}',\n    '\"free\"'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nRETURNING *;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                7088,
                768
            ],
            "id": "b830b0be-bbf0-4d91-a096-67695df398bc",
            "name": "Update: Bot Free (Discord Attention)",
            "credentials": {
                "postgres": {
                    "id": "qyR2OAIR7tUEVcQf",
                    "name": "Postgres-neon"
                }
            }
        }
    ],
    "connections": {
        "WhatsApp Trigger": {
            "main": [
                [
                    {
                        "node": "Switch Type Of Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "If: Misbehavior?": {
            "main": [
                [
                    {
                        "node": "Is Blocked?",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Switch2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Misbehavior Context": {
            "main": [
                [
                    {
                        "node": "Prepare Misbehavior Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Misbehavior Context": {
            "main": [
                [
                    {
                        "node": "Postgres: Insert Misbehavior Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Postgres: Insert Misbehavior Context": {
            "main": [
                [
                    {
                        "node": "API: Create Misbehavior Contact",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "API: Create Misbehavior Contact": {
            "main": [
                [
                    {
                        "node": "Postgres: Save API Contact (New)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Postgres: Save API Contact (New)": {
            "main": [
                [
                    {
                        "node": "Build Misbehavior Comment",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Build Misbehavior Comment": {
            "main": [
                [
                    {
                        "node": "API: Add Misbehavior Comment",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "API: Add Misbehavior Comment": {
            "main": [
                [
                    {
                        "node": "Message a model",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Misbehavior Notice": {
            "main": [
                [
                    {
                        "node": "No Operation, do nothing1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Download media3": {
            "main": [
                [
                    {
                        "node": "HTTP Request3",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP Request3": {
            "main": [
                [
                    {
                        "node": "Transcribe: audio",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Transcribe: audio": {
            "main": [
                [
                    {
                        "node": "Get: Message Info",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Edit Fields": {
            "main": [
                [
                    {
                        "node": "Execute a SQL query",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Execute a SQL query": {
            "main": [
                [
                    {
                        "node": "If",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check and Assign Character": {
            "main": [
                [
                    {
                        "node": "If: Is New Contact",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "If: Is New Contact": {
            "main": [
                [
                    {
                        "node": "Set: New Costumer",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Switch: Intent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set: New Costumer": {
            "main": [
                [
                    {
                        "node": "Merge Context Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Context Data": {
            "main": [
                [
                    {
                        "node": "Switch: Intent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Context Data": {
            "main": [
                [
                    {
                        "node": "Check missing Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get: User Context": {
            "main": [
                [
                    {
                        "node": "Parse Context Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check missing Data": {
            "main": [
                [
                    {
                        "node": "Actual Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Actual Status": {
            "main": [
                [
                    {
                        "node": "AI Agent",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Request Data",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Message: Interaction In Progress",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Request Data": {
            "main": [
                [
                    {
                        "node": "Update: Status awaiting",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Context Status": {
            "main": [
                [
                    {
                        "node": "Get Bot Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse: Status": {
            "main": [
                [
                    {
                        "node": "Switch: is Awaiting?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Name & Phone": {
            "main": [
                [
                    {
                        "node": "Is Valid Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare for Property Search": {
            "main": [
                [
                    {
                        "node": "Send message4",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Detect: Intention": {
            "main": [
                [
                    {
                        "node": "Edit Fields",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Is Valid Data": {
            "main": [
                [
                    {
                        "node": "Get Context Awating Data",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Message: Wrong Name & Phone",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Context Awating Data": {
            "main": [
                [
                    {
                        "node": "Prepare for Property Search",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "API: Set new costumer",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Call 'InmuebleFinderTool'1": {
            "ai_tool": [
                [
                    {
                        "node": "AI Agent - Get Property",
                        "type": "ai_tool",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Context with Property": {
            "main": [
                [
                    {
                        "node": "AI Generate Dynamic Questionnaire",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI Agent - Get Property": {
            "main": [
                [
                    {
                        "node": "Parse: Property Information",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse: Property Information": {
            "main": [
                [
                    {
                        "node": "Update: Costumer Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update: Costumer Context": {
            "main": [
                [
                    {
                        "node": "Add Property Interest",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Parse: Message w Property Info",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch: Intent": {
            "main": [
                [
                    {
                        "node": "Get: User Context",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Send message1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get: User Context General Inq or Out Scope",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get Context with Property",
                        "type": "main",
                        "index": 0
                    }
                ],
                [],
                [
                    {
                        "node": "Get: User Context General Inq or Out Scope",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "If: Is Awaiting Questionaire": {
            "main": [
                [
                    {
                        "node": "Execute a SQL query1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Send message1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Execute a SQL query1": {
            "main": [
                [
                    {
                        "node": "Send message5",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Questionnaire Status": {
            "main": [
                [
                    {
                        "node": "Is In Questionnaire",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Is In Questionnaire": {
            "main": [
                [
                    {
                        "node": "Process Answer & Next Question",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Parse: Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Process Answer & Next Question": {
            "main": [
                [
                    {
                        "node": "Update: Context questions",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Has More Questions?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Has More Questions?": {
            "main": [
                [
                    {
                        "node": "Send message6",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Message a model1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send message4": {
            "main": [
                [
                    {
                        "node": "AI Agent - Get Property",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch1": {
            "main": [
                [
                    {
                        "node": "Execute a SQL query2",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Message: Aprobado",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Execute a SQL query3",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Execute a SQL query2": {
            "main": [
                [
                    {
                        "node": "Generate Resume",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Execute a SQL query3": {
            "main": [
                [
                    {
                        "node": "Message: Rejected",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Message: Aprobado": {
            "main": [
                [
                    {
                        "node": "Discord: Approved Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI Agent": {
            "main": [
                [
                    {
                        "node": "Message: Reject",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Simple Memory": {
            "ai_memory": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_memory",
                        "index": 0
                    }
                ]
            ]
        },
        "Contact Actions": {
            "main": [
                [
                    {
                        "node": "Actual status of contact",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Message Data": {
            "main": [
                [
                    {
                        "node": "Check Questionnaire Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenAI Chat Model1": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI Agent - Get Property",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenAI Chat Model2": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch: is Awaiting?": {
            "main": [
                [
                    {
                        "node": "Extract Name & Phone",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Detect: Intention",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "API: Set new costumer": {
            "main": [
                [
                    {
                        "node": "Update API Contact ID",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Add Property Interest": {
            "main": [
                [
                    {
                        "node": "No Operation, do nothing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update API Contact ID": {
            "main": [
                [
                    {
                        "node": "No Operation, do nothing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Message a model1": {
            "main": [
                [
                    {
                        "node": "Parse Gemini Validation",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get: Message Info": {
            "main": [
                [
                    {
                        "node": "Get API Contact1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Actual status of contact": {
            "main": [
                [
                    {
                        "node": "Merge Rejection Sources",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Prepare Message Data",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Prepare Message Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Has Postgres Context?": {
            "main": [
                [
                    {
                        "node": "Switch3",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Need Contact Check?": {
            "main": [
                [
                    {
                        "node": "Get API Contact2",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Check Questionnaire Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Gemini Validation": {
            "main": [
                [
                    {
                        "node": "Switch1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Resume": {
            "main": [
                [
                    {
                        "node": "Parse Resume",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Resume": {
            "main": [
                [
                    {
                        "node": "HTTP Request",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP Request": {
            "main": [
                []
            ]
        },
        "Get: User Context General Inq or Out Scope": {
            "main": [
                [
                    {
                        "node": "AI General Inq or Out Scope",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenAI Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI General Inq or Out Scope",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "AI General Inq or Out Scope": {
            "main": [
                [
                    {
                        "node": "Parse: AI Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Simple Memory1": {
            "ai_memory": [
                [
                    {
                        "node": "AI General Inq or Out Scope",
                        "type": "ai_memory",
                        "index": 0
                    }
                ]
            ]
        },
        "Message: General Inq or Out Scope": {
            "main": [
                [
                    {
                        "node": "Discord: Attention Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse: AI Response": {
            "main": [
                [
                    {
                        "node": "Message: General Inq or Out Scope",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP Request1": {
            "main": [
                [
                    {
                        "node": "Update: Status awaiting1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Discord: Attention Message": {
            "main": [
                [
                    {
                        "node": "HTTP Request1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse: Message w Property Info": {
            "main": [
                [
                    {
                        "node": "Send message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse AI Questionnaire": {
            "main": [
                [
                    {
                        "node": "If: Is Awaiting Questionaire",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenAI Chat Model3": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI Generate Dynamic Questionnaire",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Simple Memory2": {
            "ai_memory": [
                [
                    {
                        "node": "AI Generate Dynamic Questionnaire",
                        "type": "ai_memory",
                        "index": 0
                    }
                ]
            ]
        },
        "Message a model": {
            "main": [
                [
                    {
                        "node": "Send Misbehavior Notice",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "If": {
            "main": [
                [
                    {
                        "node": "AI: Create Reject Message",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Check and Assign Character",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update: Contact Comments1": {
            "main": [
                [
                    {
                        "node": "Update User Context Reject",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Reject Comment Payload": {
            "main": [
                [
                    {
                        "node": "Update: Contact Comments1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Rejection Sources": {
            "main": [
                [
                    {
                        "node": "Set: Rejection Payload",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set: Rejection Payload": {
            "main": [
                [
                    {
                        "node": "AI: Create Reject Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI: Create Reject Message": {
            "main": [
                [
                    {
                        "node": "Message: Reject 2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Message: Reject 2": {
            "main": [
                [
                    {
                        "node": "AI: Create Reject Resume",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI: Create Reject Resume": {
            "main": [
                [
                    {
                        "node": "Format Reject Comment Payload",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch2": {
            "main": [
                [
                    {
                        "node": "No Operation, do nothing1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Rejection Sources",
                        "type": "main",
                        "index": 1
                    }
                ],
                [
                    {
                        "node": "Need Contact Check?",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Need Contact Check?",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Need Contact Check?",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Need Contact Check?",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Need Contact Check?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Misbehavior": {
            "main": [
                [
                    {
                        "node": "If: Misbehavior?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI Misbehavior Detector": {
            "main": [
                [
                    {
                        "node": "Parse Misbehavior",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get API Contact": {
            "main": [
                [
                    {
                        "node": "Get Misbehavior Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Build Blocked Comment Payload": {
            "main": [
                [
                    {
                        "node": "API: Add Blocked Comment",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "API: Add Blocked Comment": {
            "main": [
                [
                    {
                        "node": "Postgres: Update Blocked Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Postgres: Update Blocked Context": {
            "main": [
                [
                    {
                        "node": "No Operation, do nothing2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Is Blocked?": {
            "main": [
                [
                    {
                        "node": "Build Blocked Comment Payload",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Get API Contact",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch3": {
            "main": [
                [
                    {
                        "node": "Build Blocked Comment Payload",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Build Blocked Comment Payload",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "AI Misbehavior Detector",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get API Contact1": {
            "main": [
                [
                    {
                        "node": "Check Context Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch Type Of Message": {
            "main": [
                [
                    {
                        "node": "Get: Message Info",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Message: Error type",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Message: Error type",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Message: Error type",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Download media3",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Error Message Our Side",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get API Contact2": {
            "main": [
                [
                    {
                        "node": "Contact Actions",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI Generate Dynamic Questionnaire": {
            "main": [
                [
                    {
                        "node": "Parse AI Questionnaire",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Message: Interaction In Progress": {
            "main": [
                [
                    {
                        "node": "Discord: Attention Message1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Bot Status": {
            "main": [
                [
                    {
                        "node": "If: Bot Working?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "If: Bot Working?": {
            "main": [
                [
                    {
                        "node": "Message: Bot Busy",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Update: Bot Working",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update: Bot Working": {
            "main": [
                [
                    {
                        "node": "Has Postgres Context?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send message1": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Welcome)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Message: Wrong Name & Phone": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Invalid Data)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send message": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Response)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send message5": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Questionnaire)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send message6": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Next Question)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Message: Rejected": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Reject Auto)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Message: Reject": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Manual Review)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Message: Error type": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Invalid Media)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Error Message Our Side": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Error Side)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Discord: Approved Message": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Discord Approved)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Discord: Attention Message1": {
            "main": [
                [
                    {
                        "node": "Update: Bot Free (Discord Attention)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "37571b6e3b06c0ce894d50931b94c0b80b70f40d5b859a8ce717ce6c0e3d4b9d"
    }
}