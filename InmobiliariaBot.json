{
	"nodes": [
		{
			"parameters": {
				"updates": ["messages"],
				"options": {}
			},
			"type": "n8n-nodes-base.whatsAppTrigger",
			"typeVersion": 1,
			"position": [-384, 720],
			"id": "4280c8a4-cc09-4881-9b75-eb1c8b8d7677",
			"name": "WhatsApp Trigger",
			"webhookId": "74594388-e12c-4f20-b583-78678872e5e7",
			"credentials": {
				"whatsAppTriggerApi": {
					"id": "wFOtw7oArsG5zhql",
					"name": "WhatsApp OAuth account"
				}
			}
		},
		{
			"parameters": {
				"conditions": {
					"options": {
						"caseSensitive": true,
						"leftValue": "",
						"typeValidation": "strict",
						"version": 2
					},
					"conditions": [
						{
							"id": "7f76b2d5-6c02-451f-9c67-7777b3e92f92",
							"leftValue": "={{ $json.misbehaviorDetected }}",
							"rightValue": "",
							"operator": {
								"type": "boolean",
								"operation": "true",
								"singleValue": true
							}
						}
					],
					"combinator": "and"
				},
				"options": {}
			},
			"type": "n8n-nodes-base.if",
			"typeVersion": 2.2,
			"position": [144, 384],
			"id": "54b51b15-b13e-41b3-95dc-9eb9f8c6d4de",
			"name": "If: Misbehavior?"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "WITH context_data AS (\n  SELECT id, wa_id, context_data\n  FROM user_contexts\n  WHERE wa_id = '{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}'\n  LIMIT 1\n)\nSELECT\n  '{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}'::text AS wa_id,\n    (\n    SELECT row_to_json(context_row)\n    FROM context_data AS context_row\n  ) AS context_record;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [960, 0],
			"id": "2c3d70b2-397c-4b2e-8c8f-470cc91771f5",
			"name": "Get Misbehavior Context",
			"alwaysOutputData": true,
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const detectorData = $('Parse Misbehavior').item.json;\nconst contextRecord = $json.context_record || null;\n\n// âœ… Evitar error si context_data no existe\nconst contextData = contextRecord?.context_data\n  ? JSON.parse(JSON.stringify(contextRecord.context_data))\n  : {};\n\n// âœ… Verificar si ya existe contexto\nconst isExisting = Boolean(contextRecord && contextRecord.id);\n\n// âœ… Obtener contacto de manera segura\nconst contactData = $('Get API Contact').first().json?.data || [];\nconst contactName = contactData[1]?.nombre || contactData[0]?.nombre || null;\n\n// âœ… Nombre con fallback seguro\nconst fallbackName =\n  contactName && contactName.trim() !== ''\n    ? contactName.trim()\n    : 'ðŸ¤– - Sin Nombre Mal Comportamiento';\n\n// âœ… Texto de motivo de rechazo\nconst reasonText =\n  detectorData.misbehaviorReason && detectorData.misbehaviorReason.trim() !== ''\n    ? detectorData.misbehaviorReason\n    : 'Comportamiento indebido detectado automÃ¡ticamente';\n\n// âœ… Palabras y mensaje original\nconst matchedWords = detectorData.misbehaviorMatchedWords || [];\nconst originalMessage = detectorData.misbehaviorOriginalMessage || detectorData.userPrompt || '';\nconst timestamp = new Date().toISOString();\n\n// âœ… Registro de historial\nconst historyEntry = {\n  timestamp,\n  mensaje_original: originalMessage,\n  palabras_detectadas: matchedWords,\n  origen: 'auto_filter'\n};\n\n// âœ… Interacciones actualizadas\nconst existingInteractions = Array.isArray(contextData.interacciones)\n  ? contextData.interacciones.map((entry) => ({ ...entry }))\n  : [];\nconst interactionEntry = {\n  timestamp,\n  actor: 'usuario',\n  canal: 'whatsapp',\n  tipo: 'mensaje_recibido',\n  mensaje: originalMessage,\n  origen: 'auto_filter',\n  detalles: {\n    motivo: reasonText,\n    palabras_detectadas: matchedWords\n  }\n};\nconst updatedInteractions = [...existingInteractions, interactionEntry];\n\n// âœ… Motivos actualizados\nconst existingReasons = Array.isArray(contextData.motivo_rechazo)\n  ? contextData.motivo_rechazo\n  : [];\nconst updatedReasons = [...existingReasons];\nif (!updatedReasons.includes(reasonText)) updatedReasons.push(reasonText);\n\n// âœ… Historial actualizado\nconst existingHistory = Array.isArray(contextData.mal_comportamiento_historial)\n  ? contextData.mal_comportamiento_historial\n  : [];\nconst updatedHistory = [...existingHistory, historyEntry];\n\n// âœ… Nuevo contexto actualizado\nconst updatedContext = {\n  ...contextData,\n  nombre: fallbackName,\n  status: 'blocked',\n  rechazo_previo: true,\n  motivo_rechazo: updatedReasons,\n  mal_comportamiento_historial: updatedHistory,\n  ultima_interaccion: timestamp,\n  interacciones: updatedInteractions\n};\n\n// âœ… Resultado final\nreturn [\n  {\n    json: {\n      ...detectorData,\n      misbehaviorOriginalMessage: originalMessage,\n      isExistingContext: isExisting,\n      contextId: contextRecord?.id || null,\n      updatedContext,\n      misbehaviorHistoryEntry: historyEntry,\n      interactionEntry,\n      api_contact_id: contextData?.api_contact_id || null,\n      needsApiContact: !contextData?.api_contact_id,\n      fallbackName,\n      reasonText\n    }\n  }\n];\n"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [1168, 0],
			"id": "c1ce3210-59f7-40b2-b471-20458519a422",
			"name": "Prepare Misbehavior Context"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "INSERT INTO user_contexts (wa_id, context_data, created_at, updated_at)\nVALUES (\n  '{{ $json.wa_id }}',\n  $${{ $json.updatedContext.toJsonString() }}$$::jsonb,\n  CURRENT_TIMESTAMP,\n  CURRENT_TIMESTAMP\n)\nON CONFLICT (wa_id) DO UPDATE SET\n  context_data = EXCLUDED.context_data,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING\n  id,\n  wa_id,\n  context_data,\n  context_data->>'api_contact_id' AS api_contact_id;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [816, 208],
			"id": "07b5caf2-8487-4ee0-ab65-d67f2c51d428",
			"name": "Postgres: Insert Misbehavior Context",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"method": "POST",
				"url": "https://vg.g210512.com/api/v1/contactos",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n  \"nombre\": \"{{ $('Prepare Misbehavior Context').item.json.fallbackName }}\",\n  \"telefono\": \"{{ $('Get: Message Info').item.json.phone }}\",\n  \"estado\": \"blocked\",\n  \"fuente\": \"WhatsApp Bot\"\n}",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [1072, 208],
			"id": "779977e1-f828-48da-ba68-15639303a8b8",
			"name": "API: Create Misbehavior Contact",
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts\nSET\n  context_data = jsonb_set(\n    $${{ $('Prepare Misbehavior Context').item.json.updatedContext.toJsonString() }}$$::jsonb,\n    '{api_contact_id}',\n    '{{ $json.data.id }}'::jsonb,\n    true\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Prepare Misbehavior Context').item.json.wa_id }}'\nRETURNING\n  id,\n  wa_id,\n  context_data,\n  context_data->>'api_contact_id' AS api_contact_id;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [1280, 208],
			"id": "42179c57-206e-4ce1-8732-eabb53ba8d59",
			"name": "Postgres: Save API Contact (New)",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const prepareData = $('Prepare Misbehavior Context').item.json;\nconst apiContactId = $json.api_contact_id || $json.data?.id;\n\nconst matchedWords = prepareData.misbehaviorMatchedWords || [];\nconst originalMessage = prepareData.misbehaviorOriginalMessage || '';\nconst reasonText = prepareData.reasonText || 'Comportamiento indebido detectado automÃ¡ticamente';\nconst timestamp = new Date().toISOString();\n\nconst commentLines = [\n  'ðŸš¨ BLOQUEADO - MAL COMPORTAMIENTO',\n  '',\n  ` Motivo: ${reasonText}`,\n  matchedWords.length ? `Coincidencias detectadas: ${matchedWords.join(', ')}` : '',\n  originalMessage ? `Mensaje original: "${originalMessage}"` : '',\n  `Registrado el: ${timestamp}`\n].filter(Boolean);\n\nconst notificationMessage = 'Detectamos un comportamiento indebido en tu mensaje. Tu contacto ha sido reportado y no podremos continuar con la atenciÃ³n. âŒ';\n\nconst existingInteractions = Array.isArray(prepareData.updatedContext?.interacciones)\n  ? prepareData.updatedContext.interacciones.map((entry) => ({ ...entry }))\n  : Array.isArray($json.interacciones)\n    ? $json.interacciones.map((entry) => ({ ...entry }))\n    : [];\n\nconst systemInteraction = {\n  timestamp,\n  actor: 'sistema',\n  canal: 'whatsapp',\n  tipo: 'bloqueo_registrado',\n  mensaje: 'Contacto bloqueado por comportamiento indebido.',\n  detalles: {\n    motivo: reasonText,\n    comentario: commentLines.join('\n')\n  }\n};\n\nconst updatedInteractions = [...existingInteractions, systemInteraction];\n\nconst updatedContext = {\n  ...(prepareData.updatedContext || {}),\n  interacciones: updatedInteractions\n};\n\nreturn [\n  {\n    json: {\n      api_contact_id: apiContactId,\n      comentario: commentLines.join(''),\n      wa_id: prepareData.wa_id,\n      misbehaviorNotification: notificationMessage,\n      updatedInteractions,\n      updatedContext\n    }\n  }\n];"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [1568, 208],
			"id": "0686c23d-4a8e-48a9-8598-af5bd72790e7",
			"name": "Build Misbehavior Comment"
		},
		{
			"parameters": {
				"method": "POST",
				"url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.api_contact_id }}/comentarios",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n  \"comentario\": {{ $json.comentario.toJsonString() }}\n}",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [1808, 208],
			"id": "633400ba-3248-4ca3-b5ad-571c8c2af79c",
			"name": "API: Add Misbehavior Comment",
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
				"textBody": "={{ $json.message.content }}",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [2336, 208],
			"id": "a78ced2a-0b50-43cb-b4fb-e6af86f991a3",
			"name": "Send Misbehavior Notice",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.messages[0].text.body }}",
										"rightValue": "",
										"operator": {
											"type": "string",
											"operation": "exists",
											"singleValue": true
										},
										"id": "b564c529-0a34-48cf-beaf-0004336706ef"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "text-message"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "250baf65-d4ac-41ab-a455-eb87a917a514",
										"leftValue": "={{ $json.messages[0].image }}",
										"rightValue": "",
										"operator": {
											"type": "object",
											"operation": "exists",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "image-message"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "bf6ad2e8-fe57-43c2-8f6e-1b3381f0dcff",
										"leftValue": "={{ $json.messages[0].document.mime_type }}",
										"rightValue": "image/",
										"operator": {
											"type": "string",
											"operation": "contains"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "document-image"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "ad353bff-2299-4372-a4ea-1feadb00dab2",
										"leftValue": "={{ $json.messages[0].document.mime_type }}",
										"rightValue": "application/",
										"operator": {
											"type": "string",
											"operation": "contains"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "pdf"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "9c8d220b-1791-4273-bb74-08b2b3f7f319",
										"leftValue": "={{ $json.messages[0].audio }}",
										"rightValue": "",
										"operator": {
											"type": "object",
											"operation": "exists",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "audio-message"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [-192, 656],
			"id": "2b7fe12b-28ad-439e-a975-848cad5f8f70",
			"name": "Switch",
			"onError": "continueErrorOutput"
		},
		{
			"parameters": {
				"content": "## Incoming message",
				"height": 672,
				"width": 592,
				"color": 4
			},
			"type": "n8n-nodes-base.stickyNote",
			"position": [1024, 1504],
			"typeVersion": 1,
			"id": "ed6c244a-2a75-4455-8314-57ad7b3ae98b",
			"name": "Sticky Note3"
		},
		{
			"parameters": {
				"content": "## -> Audio",
				"height": 224,
				"width": 608,
				"color": 6
			},
			"type": "n8n-nodes-base.stickyNote",
			"position": [96, 880],
			"typeVersion": 1,
			"id": "3a5b3bf3-2e93-405f-ab66-c96bf4a0dbf5",
			"name": "Sticky Note6"
		},
		{
			"parameters": {
				"resource": "media",
				"operation": "mediaUrlGet",
				"mediaGetId": "={{ $json.messages[0].audio.id }}"
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [144, 944],
			"id": "f0b26993-dc86-489d-8f51-2341dcec3769",
			"name": "Download media3",
			"webhookId": "02de1bd7-bb83-49da-baa6-392d89ed4096",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"url": "={{ $json.url }}",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpBearerAuth",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [336, 944],
			"id": "ea5d1e44-6925-4dbe-91e6-f0b306995153",
			"name": "HTTP Request3",
			"credentials": {
				"httpBearerAuth": {
					"id": "QigdAtAlBxHMmIsD",
					"name": "WA - Bearer Token"
				}
			}
		},
		{
			"parameters": {
				"resource": "audio",
				"modelId": {
					"__rl": true,
					"value": "models/gemini-2.5-flash",
					"mode": "list",
					"cachedResultName": "models/gemini-2.5-flash"
				},
				"inputType": "binary",
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.googleGemini",
			"typeVersion": 1,
			"position": [560, 944],
			"id": "5315691d-f21e-405b-a683-111ed0afaa11",
			"name": "Transcribe: audio",
			"credentials": {
				"googlePalmApi": {
					"id": "3Qw3858fHslDYr4D",
					"name": "Gemini - alfgow"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
				"textBody": "Te recuerdo que este chat solo recibe texto y audio.",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [-384, 1056],
			"id": "18d5f5df-79db-4099-b887-a9f33f4fe1e9",
			"name": "Send message2",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"assignments": {
					"assignments": [
						{
							"id": "4b195430-ea1d-49ce-84cb-06f1edc71280",
							"name": "intent",
							"value": "={{ $json.content.parts[0].text.replace(/^[\"'\\s]+|[\"'\\s]+$/g, '').replace(/\\\\/g, '') }}",
							"type": "string"
						},
						{
							"id": "8d0c4046-fab8-4adb-b011-92b920f7c4c7",
							"name": "userPrompt",
							"value": "={{ $('Get: Message Info').item.json.userPrompt }}",
							"type": "string"
						},
						{
							"id": "e5dc3f46-71fa-4d48-a8ff-85b0023aa398",
							"name": "wa_id",
							"value": "={{ $('Get: Message Info').item.json.wa_id }}",
							"type": "string"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.set",
			"typeVersion": 3.4,
			"position": [3408, 2096],
			"id": "22209772-8606-4185-ae49-36d8b2f028cb",
			"name": "Edit Fields"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "SELECT context_data \nFROM user_contexts \nWHERE wa_id = '{{ $json.wa_id }}' \nLIMIT 1;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [3568, 2096],
			"id": "8e62e6df-894b-40e7-b9d4-13c317a353e0",
			"name": "Execute a SQL query",
			"alwaysOutputData": true,
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
                        "parameters": {
                                "jsCode": "const existingContext = $input.first().json || {};\nconst previousContext = existingContext.context_data\n  ? JSON.parse(JSON.stringify(existingContext.context_data))\n  : {};\n\nconst messageData = $('Edit Fields').item.json;\nconst userPrompt = messageData.userPrompt || '';\nconst intent = messageData.intent || '';\nconst messageType = messageData.type || '';\nconst timestamp = new Date().toISOString();\n\nlet personaje;\nlet isNew = false;\n\nif (!previousContext.personaje) {\n  const personajes = ['Dany', 'Ale', 'Regi', 'Susy'];\n  personaje = personajes[Math.floor(Math.random() * personajes.length)];\n  isNew = true;\n} else {\n  personaje = previousContext.personaje;\n}\n\nconst clonedInteractions = Array.isArray(previousContext.interacciones)\n  ? previousContext.interacciones.map((entry) => ({ ...entry }))\n  : [];\n\nconst interactionEntry = {\n  timestamp,\n  actor: 'usuario',\n  canal: 'whatsapp',\n  tipo: 'mensaje_recibido',\n  mensaje: userPrompt,\n  detalles: {\n    intent,\n    tipo_mensaje: messageType\n  }\n};\n\nclonedInteractions.push(interactionEntry);\n\nconst updatedContext = {\n  ...previousContext,\n  personaje,\n  ultima_interaccion: timestamp,\n  interacciones: clonedInteractions\n};\n\nif (intent === 'property_search') {\n  updatedContext.original_search = userPrompt;\n  updatedContext.status = 'awaiting_data';\n}\n\nreturn {\n  wa_id: messageData.wa_id,\n  userPrompt,\n  type: messageType,\n  intent,\n  personaje,\n  isNew,\n  contextPayload: updatedContext,\n  interactionEntry\n};"
                        },
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [4080, 2112],
			"id": "cbfe6149-3df6-4cd2-b77e-2c31e2755f14",
			"name": "Check and Assign Character"
		},
		{
			"parameters": {
				"conditions": {
					"options": {
						"caseSensitive": true,
						"leftValue": "",
						"typeValidation": "strict",
						"version": 2
					},
					"conditions": [
						{
							"id": "0d663079-05a6-411a-bd61-d6e05a5b7bae",
							"leftValue": "={{ $json.isNew }}",
							"rightValue": "",
							"operator": {
								"type": "boolean",
								"operation": "true",
								"singleValue": true
							}
						}
					],
					"combinator": "and"
				},
				"options": {}
			},
			"type": "n8n-nodes-base.if",
			"typeVersion": 2.2,
			"position": [4288, 2112],
			"id": "c28c3f28-65bc-41d6-84a5-91e8e4476666",
			"name": "If: Is New Contact"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "INSERT INTO user_contexts (wa_id, context_data, created_at, updated_at)\nVALUES (\n  '{{ $json.wa_id }}',\n  $${{ $json.contextPayload.toJsonString() }}$$::jsonb,\n  CURRENT_TIMESTAMP,\n  CURRENT_TIMESTAMP\n)\nON CONFLICT (wa_id)\nDO UPDATE SET\n  context_data = $${{ $json.contextPayload.toJsonString() }}$$::jsonb,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [4528, 2128],
			"id": "02214ca3-e37d-499e-b2b2-9a3687405b68",
			"name": "Set: New Costumer",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "return {\n  wa_id: $input.first().json.wa_id,\n  userPrompt: $('If: Is New Contact').first().json.userPrompt,\n  intent: $('If: Is New Contact').first().json.intent,\n  personaje: $input.first().json.context_data.personaje,\n  isNew: $('If: Is New Contact').first().json.isNew,\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [4800, 2128],
			"id": "ed862abe-07bd-4e79-8d3c-516945496b8f",
			"name": "Merge Context Data"
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
				"textBody": "=Â¡Hola! ðŸ‘‹ Soy {{ $json.personaje }}, tu asistente en Inmobiliaria Villanueva GarcÃ­a.\n\nÂ¿En quÃ© te puedo ayudar hoy? ",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [3088, 2688],
			"id": "56483035-4dea-450b-8ebe-de259155673c",
			"name": "Send message1",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const postgresResult = $json;\nconst previousData = $('Switch: Intent').item.json;\n\nconst contextData = postgresResult.context_data || {};\n\nreturn {\n  wa_id: previousData.wa_id,\n  userPrompt: previousData.userPrompt,\n  type: previousData.type,\n  intent: previousData.intent,\n  personaje: contextData.personaje || previousData.personaje,\n  context_id: postgresResult.id,\n  nombre: contextData.nombre || \"\",\n  telefono: contextData.telefono || \"\",\n  status: contextData.status || \"new\",\n  rechazo_previo: contextData.rechazo_previo || false,\n  motivo_rechazo: contextData.motivo_rechazo || [],\n  inmuebles_consultados:  $input.first().json.context_data.property_found || [],\n  ultima_interaccion: postgresResult.updated_at\n};\n"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [2688, 2368],
			"id": "3d33b000-c609-4f78-a068-b20cb7394f7a",
			"name": "Parse Context Data"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "SELECT \n  id,\n  wa_id,\n  context_data,\n  created_at,\n  updated_at\nFROM user_contexts \nWHERE wa_id = '{{ $json.wa_id }}'\nLIMIT 1;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [2496, 2368],
			"id": "519cde32-61e3-4645-8aad-649e5a17d6bf",
			"name": "Get: User Context",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const data = $json;\n\nlet missingData = [];\nlet contextStatus = \"\";\n\nif (data.rechazo_previo === true) {\n  contextStatus = \"rejected_before\";\n} else if (!data.nombre || data.nombre === \"\") {\n  missingData.push(\"nombre\");\n  contextStatus = \"incomplete_data\";\n} else if (!data.telefono || data.telefono === \"\") {\n  missingData.push(\"telefono\");\n  contextStatus = \"incomplete_data\";\n} else {\n  contextStatus = \"complete_data\";\n}\n\nreturn {\n  ...data,\n  missingData: missingData,\n  contextStatus: contextStatus\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [2880, 2368],
			"id": "eee9619f-c30a-4ca0-8bf8-5a5cb4b600f4",
			"name": "Check missing Data"
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.contextStatus }}",
										"rightValue": "rejected_before",
										"operator": {
											"type": "string",
											"operation": "equals"
										},
										"id": "15548fe7-a59a-44dd-87e0-c87fa85e30fd"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Rejected Before"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "9c138d09-5a25-4eb2-b926-784df2b799d9",
										"leftValue": "={{ $json.contextStatus }}",
										"rightValue": "incomplete_data",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Incomplete Data"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "e84bb5cb-d2fd-46a7-983b-6164d386d44e",
										"leftValue": "={{ $json.contextStatus }}",
										"rightValue": "complete_data",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Complete Data"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [3088, 2352],
			"id": "2b0ecbbb-01da-472e-94a9-380d25660b72",
			"name": "Actual Status"
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
				"textBody": "=Â¡Perfecto! Para ayudarte con la informaciÃ³n del inmueble que buscas, necesito que me compartas:\n\nðŸ“ Tu nombre completo\nðŸ“± Tu nÃºmero de telÃ©fono\n\nPor favor compÃ¡rtelos en un solo mensaje ðŸ˜Š",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [4112, 2752],
			"id": "39c45db7-d205-4ca0-9bdc-ec9ce96f908e",
			"name": "Request Data",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{status}',\n      '\"awaiting_data\"'\n    ),\n    '{original_search}',\n    '\"{{ $('Actual Status').item.json.userPrompt }}\"'\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Actual Status').item.json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [4352, 2752],
			"id": "97dc9d1e-4d41-4f91-8796-f336b9a1d214",
			"name": "Update: Status awaiting",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "SELECT \n  id,\n  wa_id,\n  context_data,\n  created_at,\n  updated_at\nFROM user_contexts \nWHERE wa_id = '{{ $('Get: Message Info').item.json.wa_id }}'\nLIMIT 1;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [528, 432],
			"id": "5552b9c2-5dad-4392-b210-49b831a6971b",
			"name": "Check Context Status",
			"alwaysOutputData": true,
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const postgresResult = $('Check Context Status').first().json;  // â† Referencia directa\nconst previousData = $('Get: Message Info').item.json;\n\nconst contextData = postgresResult.context_data || {};\nconst currentStatus = contextData.status || \"new\";\n\nreturn {\n  ...previousData,\n  context_id: postgresResult.id,\n  personaje: contextData.personaje || \"\",\n  currentStatus: currentStatus,\n  isAwaitingData: currentStatus?.trim().toLowerCase() === \"awaiting_data\"\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [3696, 1840],
			"id": "188c638f-2dfd-4c6d-99ef-20ee191ba151",
			"name": "Parse: Status"
		},
		{
			"parameters": {
				"jsCode": "const userPrompt = $json.userPrompt;\n\nlet nombre = \"\";\nlet telefono = \"\";\n\nconst nombreMatch = userPrompt.match(/([A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+(?:\\s+[A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+)+)/);\nif (nombreMatch) {\n  nombre = nombreMatch[0].trim();\n}\n\nconst telefonoMatch = userPrompt.match(/(\\d{10,})/);\nif (telefonoMatch) {\n  telefono = telefonoMatch[0].replace(/\\D/g, '');\n  if (telefono.length > 10) {\n    telefono = telefono.slice(-10);\n  }\n}\n\nreturn {\n  ...$json,\n  nombre_extracted: nombre,\n  telefono_extracted: telefono,\n  has_valid_data: nombre !== \"\" && telefono !== \"\"\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [4144, 1824],
			"id": "02a52791-5d63-4c51-a978-b8c8b953b536",
			"name": "Extract Name & Phone"
		},
		{
			"parameters": {
				"jsCode": "const postgresResult = $json;\nconst switchData = $('Switch: is Awaiting?').item.json;\n\nconst contextData = postgresResult.context_data;\n\nreturn {\n  wa_id: switchData.wa_id,\n  userPrompt: $input.first().json.context_data.original_search,\n  type: switchData.type,\n  personaje: contextData.personaje,\n  nombre: contextData.nombre,\n  telefono: contextData.telefono,\n  context_id: postgresResult.id,\n  status: contextData.status\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [5056, 2016],
			"id": "e998ac09-2522-4f43-bb40-1cccb31fc4b8",
			"name": "Prepare for Property Search"
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "models/gemini-2.5-flash",
					"mode": "list",
					"cachedResultName": "models/gemini-2.5-flash"
				},
				"messages": {
					"values": [
						{
							"content": "={{ $json.userPrompt }}"
						}
					]
				},
				"jsonOutput": true,
				"options": {
					"systemMessage": "=Eres un clasificador de intenciones. Analiza el mensaje del usuario y clasifica en UNA de estas categorÃ­as:\n\n- property_search: Busca un inmueble especÃ­fico (departamento, casa, propiedad)\n- greeting: Saludos iniciales o conversaciÃ³n casual amistosa\n- general_inquiry: Preguntas sobre servicios, Ã¡reas, o informaciÃ³n general\n- confirmation: Confirmaciones para avanzar (sÃ­, ok, listo, adelante)\n- negotiation: Intenta negociar o pedir excepciones\n- out_of_scope: Cualquier tema no relacionado con inmobiliaria\n\nResponde SOLO con el nombre de la categorÃ­a, sin explicaciones."
				}
			},
			"type": "@n8n/n8n-nodes-langchain.googleGemini",
			"typeVersion": 1,
			"position": [3104, 2096],
			"id": "d9df4bb5-8a08-4bd2-b971-f2b0b9d80859",
			"name": "Detect: Intention",
			"credentials": {
				"googlePalmApi": {
					"id": "3Qw3858fHslDYr4D",
					"name": "Gemini - alfgow"
				}
			}
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.has_valid_data }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "true",
											"singleValue": true
										},
										"id": "dae4488b-95af-4c88-a855-101544196f7a"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "TRUE"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "3225f10b-9880-42ec-8207-af7b7e64a479",
										"leftValue": "={{ $json.has_valid_data }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "false",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "FALSE"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [4416, 1824],
			"id": "5da10fe8-94d7-43e0-bc0b-ba8523b15842",
			"name": "Is Valid Data"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      jsonb_set(\n        context_data,\n        '{nombre}',\n        '\"{{ $json.nombre_extracted }}\"'\n      ),\n      '{telefono}',\n      '\"{{ $json.telefono_extracted }}\"'\n    ),\n    '{status}',\n    '\"in_progress\"'\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [4864, 1808],
			"id": "288ea6fb-0a5e-44d4-8aba-d84e86d13836",
			"name": "Get Context Awating Data",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"description": "Este Workflow busca la informacion de los inmuebles",
				"workflowId": {
					"__rl": true,
					"value": "8JWwPczEyYuP2J3N",
					"mode": "list",
					"cachedResultUrl": "/workflow/8JWwPczEyYuP2J3N",
					"cachedResultName": "InmuebleFinderTool"
				},
				"workflowInputs": {
					"mappingMode": "defineBelow",
					"value": {
						"termino": "={{ $('Prepare for Property Search').item.json.userPrompt }}"
					},
					"matchingColumns": [],
					"schema": [
						{
							"id": "termino",
							"displayName": "termino",
							"required": false,
							"defaultMatch": false,
							"display": true,
							"canBeUsedToMatch": true,
							"type": "string",
							"removed": false
						}
					],
					"attemptToConvertTypes": false,
					"convertFieldsToString": false
				}
			},
			"type": "@n8n/n8n-nodes-langchain.toolWorkflow",
			"typeVersion": 2.2,
			"position": [5664, 2192],
			"id": "6dc1a3ae-6670-4692-a08a-ade591eab889",
			"name": "Call 'InmuebleFinderTool'1"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "SELECT \n  id,\n  wa_id,\n  context_data,\n  created_at,\n  updated_at\nFROM user_contexts \nWHERE wa_id = '{{ $json.wa_id }}'\nLIMIT 1;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [2448, 2912],
			"id": "abc4bedb-fc01-4147-8021-60b067451e84",
			"name": "Get Context with Property",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"promptType": "define",
				"text": "={{ $('Prepare for Property Search').item.json.userPrompt }}",
				"options": {
					"systemMessage": "=use the tool **InmuebleFinderTool** w search term: \"{{ $('Prepare for Property Search').item.json.userPrompt }}\".\nYou must respond only with a valid JSON array.\nDo not include Markdown formatting, code fences (`````), explanations, or any text before or after the JSON.\n\nThe JSON must be parsable directly with JSON.parse() in JavaScript.\n\nOutput format required:\n\n[\n  {\n    \"id\": number,\n    \"title\": \"string\",\n    \"slug\": \"string\",\n    \"description\": \"string\",\n    \"ammount\": \"string\",\n    \"colonia\": \"string\",\n    \"municipio\": \"string\",\n    \"estado\": \"string\",\n    \"type\": \"string\",\n    \"operacion\": \"string\",\n    \"estatus\": \"string\",\n    \"rooms\": number,\n    \"baths\": number,\n    \"parkings\": number,\n    \"m2\": \"string\",\n    \"restrictions\": {\n      \"acepta_mascotas\": \"string\",\n      \"acepta_niÃ±os\": \"string\",\n      \"acepta_estudiantes\": \"string\",\n      \"acepta_roomies\": \"string\",\n      \"ingresos_minimos\": \"string\",\n      \"precio_poliza\": \"string or null\",\n      \"requiere_comprobantes_ingresos\": boolean,\n      \"observaciones\": \"string\"\n    }\n  }\n]\n\n\nâš ï¸ Do not wrap your answer inside triple backticks or any markdown block.\nâš ï¸ Do not include the words â€œjsonâ€ or â€œoutputâ€ before the array.\n\nJust return the array itself â€” nothing else."
				}
			},
			"type": "@n8n/n8n-nodes-langchain.agent",
			"typeVersion": 2.2,
			"position": [5504, 2016],
			"id": "327da6b9-613d-4d8f-bce6-a42318d821ef",
			"name": "AI Agent - Get Property",
			"alwaysOutputData": true
		},
		{
			"parameters": {
				"jsCode": "const previousData = $('Prepare for Property Search').item.json;\nlet raw = $json.output;\nlet propertyFound = false;\nlet propertyData = null;\n\ntry {\n  // ðŸ§  Primer parse: convierte el texto escapado en un objeto/array real\n  const parsed = JSON.parse(raw);\n\n  // âœ… Verificamos que efectivamente sea un array con un objeto\n  if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].slug) {\n    const p = parsed[0];\n    propertyFound = true;\n    propertyData = {\n      id: p.id,\n      slug: p.slug,\n      title: p.title,\n      description: p.description,\n      colonia: p.colonia,\n      municipio: p.municipio,\n      estado: p.estado,\n      operacion: p.operacion,\n      ammount: p.ammount,\n      rooms: p.rooms,\n      baths: p.baths,\n      parkings: p.parkings,\n      m2: p.m2,\n      type: p.type,\n      restrictions: p.restrictions || {},\n    };\n  } else {\n    console.warn('âš ï¸ No se encontrÃ³ slug en el resultado parseado.');\n  }\n} catch (err) {\n  console.error('âŒ Error parseando propiedad:', err.message);\n  console.log('Contenido RAW:', raw);\n}\n\nreturn {\n  wa_id: previousData.wa_id,\n  nombre: previousData.nombre,\n  telefono: previousData.telefono,\n  personaje: previousData.personaje,\n  context_id: previousData.context_id,\n  propertyFound,\n  propertyData,\n};\n"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [5840, 2016],
			"id": "b8661477-085c-44f2-863f-8fffebf5fd44",
			"name": "Parse: Property Information"
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('Extract Name & Phone').item.json.wa_id }}",
				"textBody": "=Lo siento, no pude identificar correctamente tus datos ðŸ˜…\n\nRecuerda que me tienes que enviar en un solo mensaje:\n\nNombre Completo\nNÃºmero de telÃ©fono\n\nSigo al pendiente.",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [4592, 1936],
			"id": "ecd59aee-729a-4348-aaa8-30ee1884eaee",
			"name": "Message: Wrong Name & Phone",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('Extract Name & Phone').item.json.wa_id }}",
				"textBody": "={{ $json.formatted_message }}",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [6496, 2160],
			"id": "ecb23faa-71e7-4529-8a66-8e01adf4723c",
			"name": "Send message",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{status}',\n      '\"awaiting_questionnaire\"'\n    ),\n    '{property_found}',\n    '{{ $json.propertyData.toJsonString() }}'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [6032, 2016],
			"id": "2d0118ec-0f07-4cfc-a262-4f3c767bb563",
			"name": "Update: Costumer Context",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.intent }}",
										"rightValue": "property_search",
										"operator": {
											"type": "string",
											"operation": "equals"
										},
										"id": "cfe22d84-c2c3-4cb0-8a58-84d4a74ed500"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Property Search"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "fec70547-de3d-40c9-9d97-a73c74f4910b",
										"leftValue": "={{ $json.intent }}",
										"rightValue": "greeting",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Greeting"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "eb6f2f45-f416-4b8d-b47b-510056a95c53",
										"leftValue": "={{ $json.intent }}",
										"rightValue": "general_inquiry",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "General Inquiry"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "ff0ba65d-04e2-4f17-93f6-e0635cdb1ec7",
										"leftValue": "={{ $json.intent }}",
										"rightValue": "confirmation",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Confirmation"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "eae60bfa-ae3e-497b-ad36-53db5e479587",
										"leftValue": "={{ $json.intent }}",
										"rightValue": "negotiation",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Negotiation"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "7c3fbc8e-f957-4100-bc88-06410ce8dc75",
										"leftValue": "={{ $json.intent }}",
										"rightValue": "out_of_scope",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Out of scope"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [1776, 2384],
			"id": "005c472e-72c1-4607-a65d-ee0c39b6ec89",
			"name": "Switch: Intent"
		},
		{
			"parameters": {
				"conditions": {
					"options": {
						"caseSensitive": true,
						"leftValue": "",
						"typeValidation": "strict",
						"version": 2
					},
					"conditions": [
						{
							"id": "7335f5b8-de3b-423a-8519-36394cc79b76",
							"leftValue": "={{ $json.status }}",
							"rightValue": "awaiting_questionnaire",
							"operator": {
								"type": "string",
								"operation": "equals"
							}
						}
					],
					"combinator": "and"
				},
				"options": {}
			},
			"type": "n8n-nodes-base.if",
			"typeVersion": 2.2,
			"position": [3360, 2960],
			"id": "5f4630ae-ff7d-4c6c-ac1e-bb60b7d9f319",
			"name": "If: Is Awaiting Questionaire"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{questionnaire}',\n      '{{ $json.questions.toJsonString() }}'::jsonb\n    ),\n    '{current_question_index}',\n    '0'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [4064, 2944],
			"id": "04efc492-e5e4-4683-a186-b70a1b8ea10a",
			"name": "Execute a SQL query1",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $json.wa_id }}",
				"textBody": "=Â¡Perfecto, {{ $json.context_data.nombre.split(' ')[0] }}! ðŸ˜Š\n\n{{ $json.context_data.questionnaire[0].question }}",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [4272, 2944],
			"id": "31c9a89d-0dcb-4625-a339-418735c5926f",
			"name": "Send message5",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const postgresResult = $json;\nconst previousData = $('Get: Message Info').item.json;\n\nconst contextData = postgresResult.context_data || {};\nconst currentStatus = contextData.status || \"new\";\n\nconst isInQuestionnaire = currentStatus === \"awaiting_questionnaire\" && \n                          contextData.questionnaire && \n                          contextData.questionnaire.length > 0;\n\nconst currentIndex = contextData.current_question_index || 0;\nconst totalQuestions = contextData.questionnaire?.length || 0;\n\nreturn {\n  ...previousData,\n  context_id: postgresResult.id,\n  personaje: contextData.personaje || \"\",\n  nombre: contextData.nombre || \"\",\n  currentStatus: currentStatus,\n  isInQuestionnaire: isInQuestionnaire,\n  currentQuestionIndex: currentIndex,\n  totalQuestions: totalQuestions,\n  questionnaire: contextData.questionnaire || [],\n  answers: contextData.answers || {}\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [448, 1808],
			"id": "4df61308-fbdb-41ca-bd00-d30a453894c3",
			"name": "Check Questionnaire Status"
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.isInQuestionnaire }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "true",
											"singleValue": true
										},
										"id": "40525fe2-fea0-4c92-b128-dc2dc73ebec1"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "TRUE"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "55c5ed97-3768-4d9d-9cb8-7e5dd20346af",
										"leftValue": "={{ $json.isInQuestionnaire }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "false",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "FALSE"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [4624, 1568],
			"id": "e643ad20-0e36-415b-bea6-5eb1e85ace4c",
			"name": "Is In Questionnaire"
		},
		{
			"parameters": {
				"jsCode": "const userResponse = $json.userPrompt;\nconst currentIndex = $json.currentQuestionIndex;\nconst questionnaire = $json.questionnaire;\nconst previousAnswers = $json.answers || {};\n\n// Obtener pregunta actual\nconst currentQuestion = questionnaire[currentIndex];\n\n// Guardar respuesta\nconst answers = {\n  ...previousAnswers,\n  [currentQuestion.field]: userResponse\n};\n\n// Verificar si quedan mÃ¡s preguntas\nconst nextIndex = currentIndex + 1;\nconst hasMoreQuestions = nextIndex < questionnaire.length;\n\nreturn {\n  wa_id: $json.wa_id,\n  nombre: $json.nombre,\n  personaje: $json.personaje,\n  context_id: $json.context_id,\n  currentQuestionField: currentQuestion.field,\n  currentAnswer: userResponse,\n  answers: answers,\n  nextQuestionIndex: nextIndex,\n  hasMoreQuestions: hasMoreQuestions,\n  nextQuestion: hasMoreQuestions ? questionnaire[nextIndex] : null,\n  totalQuestions: questionnaire.length,\n  questionnaire: questionnaire\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [4944, 1552],
			"id": "181e5e1c-1e01-4307-ac05-3c2767ce14b3",
			"name": "Process Answer & Next Question",
			"alwaysOutputData": false
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{answers}',\n      '{{ $json.answers.toJsonString() }}'::jsonb\n    ),\n    '{current_question_index}',\n    '{{ $json.nextQuestionIndex }}'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [4608, 1312],
			"id": "ddf8a05b-281b-4a19-8713-56dd756e0a50",
			"name": "Update: Context questions",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.hasMoreQuestions }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "true",
											"singleValue": true
										},
										"id": "9d1e7db8-76f4-4019-8169-51090760d627"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "TRUE"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "876e9470-34b5-46d9-bdef-92f8de3c819f",
										"leftValue": "={{ $json.hasMoreQuestions }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "false",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "FALSE"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [5152, 1552],
			"id": "55602a07-4605-4b5d-819c-40e9b12ff8e3",
			"name": "Has More Questions?"
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('Extract Name & Phone').item.json.wa_id }}",
				"textBody": "=Gracias {{ $json.nombre.split(' ')[0] }}, dame por favor un momento, estoy trabajando tu solicitud",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [5264, 2016],
			"id": "65897978-248d-430e-a1da-cd1c92c49276",
			"name": "Send message4",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $json.wa_id }}",
				"textBody": "={{ $json.nextQuestion.question }}",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [4880, 1312],
			"id": "066c2f10-88c2-4e3f-8438-bc09fd811c2c",
			"name": "Send message6",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.isApproved }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "true",
											"singleValue": true
										},
										"id": "d4698e59-8af4-4d53-ae63-9b26b2ed4d2e"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Aprobado"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "2eebac30-5c99-4607-bf96-11199bf84bd6",
										"leftValue": "={{ $json.isApproved }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "false",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Rechazado"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [5872, 1568],
			"id": "d1e216d4-a90a-499a-99ed-d58f76f216e4",
			"name": "Switch1"
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      jsonb_set(\n        context_data,\n        '{status}',\n        '\"approved\"'::jsonb\n      ),\n      '{rechazo_previo}',\n      'false'::jsonb\n    ),\n    '{approved_at}',\n    to_jsonb(CURRENT_TIMESTAMP)\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [6128, 1360],
			"id": "8fa7f8c7-767a-4677-b906-c8131c532821",
			"name": "Execute a SQL query2",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      jsonb_set(\n        context_data,\n        '{status}',\n        '\"rejected\"'::jsonb\n      ),\n      '{rechazo_previo}',\n      'true'::jsonb\n    ),\n    '{motivo_rechazo}',\n    '{{ $json.rejectionReasons.toJsonString() }}'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [6112, 1584],
			"id": "eb271c17-bc95-418f-8847-22ffe12e0ebb",
			"name": "Execute a SQL query3",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $json.wa_id }}",
				"textBody": "=Â¡Excelentes noticias, {{ $json.nombre.split(' ')[0] }}! ðŸŽ‰\n\nTu perfil cumple con todos los requisitos del arrendador âœ…. \n\nNuestro equipo se pondrÃ¡ en contacto contigo en las prÃ³ximas 24 horas para coordinar la visita al inmueble.\n\nÂ¡Gracias por tu interÃ©s! ðŸ˜Š",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [6128, 1152],
			"id": "0c243602-8574-4e50-bd21-67c41d8afaf5",
			"name": "Message: Aprobado",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $json.wa_id }}",
				"textBody": "=Gracias por tu tiempo, {{ $json.context_data.nombre.split(' ')[0] }}.\n\nLamentablemente, en este momento no cumples con todos los requisitos establecidos por el arrendador para este inmueble en particular.\n\nSi tienes alguna duda, con gusto puedes contactarnos.\n\nÂ¡Te deseamos mucho Ã©xito en tu bÃºsqueda! ðŸ¡",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [6320, 1584],
			"id": "7c27f263-bd03-4a29-a3e9-73351d9edd9e",
			"name": "Message: Rejected",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"promptType": "define",
				"text": "={{ $json.userPrompt }}",
				"options": {
					"systemMessage": "=Tu funciÃ³n serÃ¡ rechazar al contacto, tienes que indicarle que previamente nos contactÃ³ por el inmueble ubicado en {{ $json.inmuebles_consultados.colonia }} con un precio de renta de {{ $json.inmuebles_consultados.ammount }}, debes analizar por que se realizÃ³ el rechazo con la informaciÃ³n que tienes en {{ $json.motivo_rechazo }}.\nSi la persona insiste, tienes que decirle amablemente que no puedes cambiar una decisiÃ³n tomada previamente."
				}
			},
			"type": "@n8n/n8n-nodes-langchain.agent",
			"typeVersion": 2.2,
			"position": [4064, 2368],
			"id": "7a910696-4b00-4c18-9163-5971e00c9c1e",
			"name": "AI Agent"
		},
		{
			"parameters": {
				"sessionIdType": "customKey",
				"sessionKey": "={{ $('Actual Status').item.json.wa_id }}"
			},
			"type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
			"typeVersion": 1.3,
			"position": [4272, 2576],
			"id": "6bea07ab-80c9-40f8-adf8-19243016bbb8",
			"name": "Simple Memory"
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('Actual Status').item.json.wa_id }}",
				"textBody": "={{ $json.output }}",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [4384, 2368],
			"id": "7697f944-ae81-4aab-9dfc-1c77666c12c5",
			"name": "Message: Reject",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"workflowId": {
					"__rl": true,
					"value": "fF9WMy6NlCBRnQSn",
					"mode": "list",
					"cachedResultUrl": "/workflow/fF9WMy6NlCBRnQSn",
					"cachedResultName": "ContactoFinderTool"
				},
				"workflowInputs": {
					"mappingMode": "defineBelow",
					"value": {
						"telefono": "={{ $json.contacts[0].wa_id }}"
					},
					"matchingColumns": [],
					"schema": [
						{
							"id": "telefono",
							"displayName": "telefono",
							"required": false,
							"defaultMatch": false,
							"display": true,
							"canBeUsedToMatch": true,
							"type": "string",
							"removed": false
						}
					],
					"attemptToConvertTypes": false,
					"convertFieldsToString": false
				}
			},
			"type": "@n8n/n8n-nodes-langchain.toolWorkflow",
			"typeVersion": 2.2,
			"position": [2224, 1088],
			"id": "edd8a924-eed7-485a-998f-e6bcb1035e73",
			"name": "Call 'ContactoFinderTool'"
		},
		{
			"parameters": {
				"jsCode": "const geminiResponse = $json;\nconst whatsappData = $('WhatsApp Trigger').item.json;\n\nlet contactExists = false;\nlet contactData = null;\nlet contactId = null;\nlet hasRejectionHistory = false;\nlet rejectionSummary = \"\";\n\ntry {\n  const textContent = geminiResponse.content.parts[0].text;\n  \n  // Verificar si dice \"Contact not found\"\n  if (textContent.toLowerCase().includes('contact not found') || \n      textContent.toLowerCase().includes('not found')) {\n    contactExists = false;\n  } else {\n    // Limpiar posibles markdown (por si acaso)\n    let cleanedText = textContent.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    \n    const parsedData = JSON.parse(cleanedText);\n    \n    contactExists = true;\n    contactData = parsedData;\n    contactId = parsedData.phone;\n    \n    // Usar el campo isRejected que viene del JSON\n    hasRejectionHistory = parsedData.isRejected === true;\n    rejectionSummary = parsedData.resumen_interacciones || \"\";\n  }\n} catch (error) {\n  console.log('Error parsing contact response:', error.message);\n  console.log('Raw text:', geminiResponse.content.parts[0].text);\n  contactExists = false;\n}\n\nreturn {\n  wa_id: whatsappData.contacts[0].wa_id,\n  userMessage: whatsappData.messages[0].text.body,\n  contactExists: contactExists,\n  contactId: contactId,\n  contactData: contactData,\n  hasRejectionHistory: hasRejectionHistory,\n  rejectionSummary: rejectionSummary\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [2496, 976],
			"id": "d1c7ceb6-fce6-4c0c-9270-19a213e7a650",
			"name": "Contact Actions"
		},
		{
			"parameters": {
				"jsCode": "const contactData = $('Contact Actions').item.json;\nconst whatsappData = $('WhatsApp Trigger').item.json;\n\n// Preparar datos en el formato que espera el Switch original\nreturn {\n  messages: whatsappData.messages,\n  contacts: whatsappData.contacts,\n  // Datos adicionales del contacto\n  _contactExists: contactData.contactExists,\n  _contactId: contactData.contactId,\n  _contactData: contactData.contactData,\n  _hasRejectionHistory: contactData.hasRejectionHistory\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [3440, 1168],
			"id": "2409daf1-d627-47f8-8bea-8b00e9933cd1",
			"name": "Prepare Message Data"
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "models/gemini-2.5-flash",
					"mode": "list",
					"cachedResultName": "models/gemini-2.5-flash"
				},
				"messages": {
					"values": [
						{
							"content": "=Tu Ãºnica funciÃ³n es usar ContactFinderTool para buscar si el contacto {{ $('Get: Message Info').item.json.wa_id }} existe en la base de datos y analizar si tiene rechazo previo.\n\nCASO 1: Si NO encuentras el contacto\nResponde EXACTAMENTE asÃ­ (texto plano):\nContact not found\n\nCASO 2: Si SÃ encuentras el contacto\nAnaliza CUIDADOSAMENTE el campo \"resumen_interacciones\" y \"comentario\" de las interacciones.\n\nMarca isRejected como TRUE si encuentras CUALQUIERA de estas frases o conceptos:\n- \"no cumple\"\n- \"no cumplen\"\n- \"rechazo\" / \"rechazado\" / \"rechazada\"\n- \"no acepta\" / \"no aceptan\"\n- \"no puede\" / \"no pueden\"\n- \"desafortunadamente no\"\n- \"lamentablemente no\"\n- \"no tiene\" (cuando se refiere a requisitos)\n- \"falta de\" / \"sin\" (comprobantes, documentos, etc.)\n- \"basura de contacto\"\n- \"perdida de tiempo\"\n- \"muy pendejo\"\n- Cualquier lenguaje negativo sobre el contacto o sus requisitos\n\nMarca isRejected como FALSE SOLO si:\n- El resumen describe interÃ©s genuino sin mencionar rechazo\n- No hay indicios de incumplimiento de requisitos\n- Es un seguimiento normal\n\nResponde con un JSON vÃ¡lido:\n\n{\n  \"id\": nÃºmero_id_del_contacto,\n  \"name\": \"nombre del contacto\",\n  \"phone\": \"telÃ©fono\",\n  \"total_interactions\": nÃºmero,\n  \"resumen_interacciones\": \"texto completo del resumen\",\n  \"isRejected\": true o false,\n  \"interactions\": [array de interacciones]\n}\n\nCRÃTICO:\n- El campo \"id\" es OBLIGATORIO (nÃºmero)\n- isRejected debe ser TRUE si hay CUALQUIER indicio de rechazo\n- En caso de duda, marca como TRUE (mejor prevenir)\n- NO agregues markdown (```json)\n- NO agregues explicaciones adicionales"
						}
					]
				},
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.googleGemini",
			"typeVersion": 1,
			"position": [2016, 928],
			"id": "f338d26a-52dc-49b4-8d05-9c22a83133af",
			"name": "Contact Finder",
			"alwaysOutputData": true,
			"credentials": {
				"googlePalmApi": {
					"id": "3Qw3858fHslDYr4D",
					"name": "Gemini - alfgow"
				}
			}
		},
		{
			"parameters": {
				"model": {
					"__rl": true,
					"value": "gpt-5-nano",
					"mode": "list",
					"cachedResultName": "gpt-5-nano"
				},
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
			"typeVersion": 1.2,
			"position": [5456, 2208],
			"id": "b058857d-d2c1-420a-9e54-3978888d3cfe",
			"name": "OpenAI Chat Model1",
			"credentials": {
				"openAiApi": {
					"id": "g8OPzRDvvB6YO7mf",
					"name": "OpenAi account"
				}
			}
		},
		{
			"parameters": {
				"model": {
					"__rl": true,
					"value": "gpt-5-nano",
					"mode": "list",
					"cachedResultName": "gpt-5-nano"
				},
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
			"typeVersion": 1.2,
			"position": [4064, 2576],
			"id": "fd8e921a-a102-4073-a1b3-cd9955326830",
			"name": "OpenAI Chat Model2",
			"credentials": {
				"openAiApi": {
					"id": "g8OPzRDvvB6YO7mf",
					"name": "OpenAi account"
				}
			}
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.isAwaitingData }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "true",
											"singleValue": true
										},
										"id": "911b08be-9c60-4621-ac3e-8c0316f75792"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Is Awaiting"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "da44f585-3b7c-4a21-a1e5-b4ed16282b49",
										"leftValue": "={{ $json.isAwaitingData }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "false",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "NOT"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [3888, 1840],
			"id": "1e782133-d805-4a25-beef-21ee48f488da",
			"name": "Switch: is Awaiting?"
		},
		{
			"parameters": {
				"method": "POST",
				"url": "https://vg.g210512.com/api/v1/contactos",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n  \"nombre\": \"ðŸ¤– - {{ $('Extract Name & Phone').item.json.nombre_extracted }}\",\n  \"telefono\": \"{{ $('Extract Name & Phone').item.json.telefono_extracted }}\",\n  \"estado\": \"nuevo\",\n  \"fuente\": \"WhatsApp Bot\"\n}",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [5168, 1808],
			"id": "44ed50b3-63d0-4205-8dc8-6863a2d1c933",
			"name": "API: Set new costumer",
			"retryOnFail": true,
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {
				"method": "POST",
				"url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.context_data.api_contact_id }}/intereses",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n  \"inmueble_id\": {{ $('Parse: Property Information').item.json.propertyData.id }}\n}",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [6288, 1952],
			"id": "60a5523c-5335-4e62-96f2-116b536e6f6b",
			"name": "Add Property Interest",
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    context_data,\n    '{api_contact_id}',\n    '{{ $json.data.id }}'::jsonb\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('Get Context Awating Data').item.json.wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [5408, 1808],
			"id": "541bbc93-7282-4517-b6a5-249eac50353c",
			"name": "Update API Contact ID",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "models/gemini-2.5-flash",
					"mode": "list",
					"cachedResultName": "models/gemini-2.5-flash"
				},
				"messages": {
					"values": [{}]
				},
				"options": {
					"systemMessage": "=Eres un validador de respuestas para un cuestionario de renta inmobiliaria.\n\nTienes el cuestionario completo con todas las preguntas y respuestas del usuario.\n\nCUESTIONARIO:\n{{ $json.questionnaire.toJsonString() }}\n\nRESPUESTAS DEL USUARIO:\n{{ $json.answers.toJsonString() }}\n\nREGLAS DE VALIDACIÃ“N:\n\nPara preguntas tipo \"boolean\":\n- Si expected = false: el usuario debe decir \"no\", \"ninguno\", \"no tengo\"\n  - Si dice \"sÃ­\", \"tengo\", \"claro\", nÃºmeros positivos â†’ NO CUMPLE\n  - Si es evasivo \"quiÃ©n sabe\", \"quÃ© te importa\" â†’ NO CUMPLE (asumir que sÃ­ tiene)\n\n- Si expected = true: el usuario debe decir \"sÃ­\", \"tengo\", \"claro\"\n  - Si dice \"no\", \"ninguno\" â†’ NO CUMPLE\n\nPara preguntas tipo \"number_minimum\":\n- Extrae el nÃºmero de la respuesta del usuario\n- Compara si es >= al expected\n- Ejemplos: \"gano 32000\" â†’ 32000, \"35 mil\" â†’ 35000\n\nRESPONDE CON UN JSON ARRAY con esta estructura:\n\n[\n  {\n    \"campo\": \"mascotas\",\n    \"pregunta\": \"Â¿Tienes mascotas?\",\n    \"respuesta_usuario\": \"Si tengo un westie\",\n    \"expected\": false,\n    \"valor_interpretado\": true,\n    \"cumple\": false,\n    \"razon\": \"Se esperaba NO tener mascotas, pero el usuario tiene un perro\"\n  },\n  {\n    \"campo\": \"ingresos\",\n    \"pregunta\": \"Â¿CuÃ¡l es tu ingreso mensual?\",\n    \"respuesta_usuario\": \"Gano 32000\",\n    \"expected\": 30000,\n    \"valor_interpretado\": 32000,\n    \"cumple\": true,\n    \"razon\": \"Ingresos de $32,000 superan el mÃ­nimo de $30,000\"\n  }\n]\n\nIMPORTANTE:\n- NO uses markdown (```json)\n- Analiza TODOS los campos del cuestionario\n- SÃ© estricto con los requisitos"
				}
			},
			"type": "@n8n/n8n-nodes-langchain.googleGemini",
			"typeVersion": 1,
			"position": [5360, 1568],
			"id": "128561e0-ab42-460a-b79c-479ca0eab1a1",
			"name": "Message a model1",
			"credentials": {
				"googlePalmApi": {
					"id": "3Qw3858fHslDYr4D",
					"name": "Gemini - alfgow"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const isAudio = $input.item.json.messages ? false : true;\n\nif (isAudio) {\n  const wa_id = $('WhatsApp Trigger').item.json.contacts[0].wa_id;\n  const phone = wa_id.replace(/^521/, ''); // elimina el prefijo 521 solo si estÃ¡ al inicio\n\n  return {\n    userPrompt: $json.content.parts[0].text,\n    type: \"audio\",\n    ai: \"\",\n    wa_id,\n    phone\n  };\n} else {\n  const wa_id = $json.contacts[0].wa_id;\n  const phone = wa_id.replace(/^521/, '');\n\n  return {\n    userPrompt: $json.messages[0].text.body,\n    type: $json.messages[0].type,\n    ai: \"\",\n    wa_id,\n    phone\n  };\n}\n"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [112, 640],
			"id": "0eaa62a7-06a5-4ef6-a62f-57c4c18cbcf8",
			"name": "Get: Message Info"
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.hasRejectionHistory }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "true",
											"singleValue": true
										},
										"id": "9cd9e84b-29b5-4b88-a16c-b4ab8f71d3d1"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Rejection"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "6b1f1f79-9885-4085-b360-d943b9948656",
										"leftValue": "={{ $json.contactExists }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "true",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Exists"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "dce569ae-ec35-4393-8d21-b231b955d11a",
										"leftValue": "={{ $json.contactExists }}",
										"rightValue": "",
										"operator": {
											"type": "boolean",
											"operation": "false",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "New"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [2864, 1120],
			"id": "08cf0267-fd70-4d92-a6c6-af404b4aacb7",
			"name": "Actual status of contact"
		},
		{
			"parameters": {
				"jsCode": "const postgresResult = $json;\nconst previousData = $('Get: Message Info').item.json;\n\n// Si hay un ID en Postgres, significa que ya tenemos contexto\nconst hasContext = postgresResult && postgresResult.id;\n\nreturn {\n  ...previousData,\n  ...postgresResult, \n  hasPostgresContext: hasContext,  // â† Este campo faltaba en el output\n  postgresContextId: postgresResult.id || null\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [720, 432],
			"id": "eb6b7fd9-023f-456a-88bb-3b90cb93a06c",
			"name": "Has Postgres Context?"
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.postgresContextId }}",
										"rightValue": "",
										"operator": {
											"type": "number",
											"operation": "notExists",
											"singleValue": true
										},
										"id": "7200cba5-e9be-48ed-8051-a6193620c86a"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Need Check"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "c77aa4d5-afc8-4b56-943b-1d8bc9f762f8",
										"leftValue": "={{ $json.postgresContextId }}",
										"rightValue": "",
										"operator": {
											"type": "number",
											"operation": "exists",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "Skip Check"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [1536, 944],
			"id": "57dfc598-9610-4191-ae31-daaf04970844",
			"name": "Need Contact Check?"
		},
		{
			"parameters": {
				"jsCode": "const geminiResponse = $json.content.parts[0].text;\nconst previousData = $('Has More Questions?').item.json;\n\n// Parsear el JSON que viene como texto\nlet validationResults = [];\ntry {\n  validationResults = JSON.parse(geminiResponse);\n} catch (error) {\n  console.error('Error parseando validaciÃ³n:', error);\n}\n\n// Determinar si estÃ¡ aprobado\nconst isApproved = validationResults.every(item => item.cumple === true);\nconst rejectionReasons = validationResults\n  .filter(item => !item.cumple)\n  .map(item => item.razon);\n\nreturn {\n  wa_id: previousData.wa_id,\n  nombre: previousData.nombre,\n  personaje: previousData.personaje,\n  context_id: previousData.context_id,\n  isApproved: isApproved,\n  rejectionReasons: rejectionReasons,\n  validationResults: validationResults,\n  answers: previousData.answers\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [5680, 1568],
			"id": "ae271770-210b-4a6c-b67e-c53aa25f6a34",
			"name": "Parse Gemini Validation"
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "models/gemini-2.5-flash",
					"mode": "list",
					"cachedResultName": "models/gemini-2.5-flash"
				},
				"messages": {
					"values": [{}]
				},
				"options": {
					"systemMessage": "=Genera un resumen ejecutivo de la interacciÃ³n para el equipo de la inmobiliaria.\n\nDATOS DE LA INTERACCIÃ“N:\n{{ $('Execute a SQL query2').item.json.context_data.toJsonString() }}\n\nFORMATO REQUERIDO:\n- APROBADO - ðŸŽ‰\n\n**Contacto:** {{ $('Execute a SQL query2').item.json.context_data.nombre }}\n**TelÃ©fono:** {{ $('Execute a SQL query2').item.json.context_data.telefono }}\n**Personaje atendiÃ³:** {{ $('Execute a SQL query2').item.json.context_data.personaje }}\n\n**ðŸ“ Propiedad de InterÃ©s:**\n- {{ $('Execute a SQL query2').item.json.context_data.property_found.title }}\n- {{ $('Execute a SQL query2').item.json.context_data.property_found.colonia }}, {{ $('Execute a SQL query2').item.json.context_data.property_found.municipio }}\n- Renta: {{ $('Execute a SQL query2').item.json.context_data.property_found.ammount }}\n\n**âœ… ValidaciÃ³n del Perfil:**\nEl contacto cumpliÃ³ con TODOS los requisitos:\n- Sin mascotas âœ…\n- Sin niÃ±os âœ…\n- No es estudiante sin tutor âœ…\n- No vivirÃ¡ con roomies âœ…\n- Ingresos comprobables: ${{ $('Execute a SQL query2').item.json.context_data.answers.ingresos }} (superior al mÃ­nimo de ${{ $('Execute a SQL query2').item.json.context_data.property_found.restrictions.ingresos_minimos }}) âœ…\n- Cuenta con comprobantes vÃ¡lidos âœ…\n\n**ðŸ“‹ PrÃ³ximos Pasos:**\n1. Contactar al cliente en las prÃ³ximas 24 horas\n2. Coordinar visita al inmueble\n3. Preparar documentaciÃ³n requerida\n\n**Estado:** APROBADO para continuar proceso de renta ðŸ¡"
				}
			},
			"type": "@n8n/n8n-nodes-langchain.googleGemini",
			"typeVersion": 1,
			"position": [6304, 1360],
			"id": "784cbc5a-eebf-4d66-ba00-256556f2d66f",
			"name": "Generate Resume",
			"credentials": {
				"googlePalmApi": {
					"id": "3Qw3858fHslDYr4D",
					"name": "Gemini - alfgow"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const aiResponse = $json.content.parts[0].text;\nconst contextData = $('Execute a SQL query2').first().json.context_data;\n\nreturn {\n  contactId: contextData.api_contact_id,\n  body: {\n    comentario: aiResponse,\n    created_at: new Date().toISOString()\n  }\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [6624, 1360],
			"id": "43b955b2-5bb9-4b17-9f00-931bfca3e81c",
			"name": "Parse Resume"
		},
		{
			"parameters": {
				"method": "POST",
				"url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.contactId }}/comentarios",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n  \"comentario\": {{ $json.body.comentario.toJsonString() }}\n}",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [6848, 1360],
			"id": "f5b9ccfe-db45-4133-9047-b3f2c6fb3bb3",
			"name": "HTTP Request",
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "SELECT \n  id,\n  wa_id,\n  context_data,\n  created_at,\n  updated_at\nFROM user_contexts \nWHERE wa_id = '{{ $json.wa_id }}'\nLIMIT 1;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [2384, 3360],
			"id": "4a90da2b-8c4d-4cb2-b7d8-017c6d1ed8b9",
			"name": "Get: User Context General Inq or Out Scope",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"model": {
					"__rl": true,
					"mode": "list",
					"value": "gpt-4.1-mini"
				},
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
			"typeVersion": 1.2,
			"position": [2512, 3568],
			"id": "2e704e46-ff6d-4592-bf2c-aa582d51252e",
			"name": "OpenAI Chat Model",
			"credentials": {
				"openAiApi": {
					"id": "g8OPzRDvvB6YO7mf",
					"name": "OpenAi account"
				}
			}
		},
		{
			"parameters": {
				"promptType": "define",
				"text": "={{ $json.wa_id }}",
				"options": {
					"systemMessage": "=Tu funciÃ³n es analizar el mensaje del cliente y determinar su requerimiento de manera estructurada, siempre devolviendo un JSON limpio.\n\n## ENTRADAS\n- Mensaje del cliente: {{ $('WhatsApp Trigger').item.json.messages[0].text.body }}\n- Context data: {{ $('Get: User Context General Inq or Out Scope').item.json.context_data.toJsonString() }}\n\n## INSTRUCCIONES\n\n1. Analiza el mensaje y el contexto para descubrir el requerimiento real del cliente.\n\n2. Si el mensaje contiene alguna **groserÃ­a, agresiÃ³n, palabra profana o acoso**, debes:\n   - Generar un JSON donde:\n     - `message` sea un aviso al cliente indicando que su comportamiento ha sido reportado y no podrÃ¡s continuar la atenciÃ³n.\n     - `contexto` describa el mensaje ofensivo detectado.\n     - `requiereAtencion` sea `false`.\n\n3. Si el **context data** contiene un estado de **rechazo** (`status = \"rejected\"`, `rechazo_previo = true` o motivo de rechazo presente):\n   - EnvÃ­a un mensaje al cliente indicando amablemente que, **debido al motivo de rechazo previo**, no es posible continuar la atenciÃ³n.\n   - Incluye en `contexto` el motivo de rechazo.\n   - `requiereAtencion` debe ser `false`.\n\n4. Si **no hay informaciÃ³n previa en context data**, o el prospecto no estÃ¡ identificado:\n   - EnvÃ­a un mensaje breve, amable y coherente, indicando que **solo puedes atender solicitudes relacionadas con Inmobiliaria Villanueva GarcÃ­a**.\n   - `requiereAtencion` debe ser `false`.\n\n5. Si **el contexto previo estÃ¡ aprobado o requiere seguimiento activo** (`status` = \"approved\", \"requiere_atention\", \"requires_attention\" o similar, o `approved_at` existe sin un rechazo posterior):\n   - Interpreta el mensaje actual para descubrir quÃ© requiere (por ejemplo: confirmar cita, pedir seguimiento, solicitar informaciÃ³n adicional, etc.).\n   - Genera una respuesta empÃ¡tica, **sin preguntas abiertas**, simplemente informando al cliente que su solicitud ya fue notificada al equipo correspondiente para pronta atenciÃ³n.\n   - Refuerza que se darÃ¡ seguimiento y evita redirigir al bot.\n   - Ejemplo de tono correcto:  \n     ðŸ‘‰ \"Muchas gracias por tu mensaje, {{ $('Get: User Context General Inq or Out Scope').item.json.context_data.nombre.split(' ')[0] }}, te confirmo que en este momento he notificado nuevamente tu solicitud al equipo para su pronta atenciÃ³n.\"  \n   - Ejemplo de tono incorrecto:  \n     ðŸš« \"Â¿PodrÃ­as confirmarme a quÃ© cita te refieres?\"  \n   - `requiereAtencion` debe ser `true`.\n\n6. En todos los casos, **la salida DEBE SER EXCLUSIVAMENTE** un arreglo JSON con este formato exacto (sin explicaciones, sin markdown):\n\n[\n  {\n    \"message\": \"mensaje coherente y amable para enviar al cliente\",\n    \"contexto\": \"breve descripciÃ³n del requerimiento o motivo de respuesta\",\n    \"requiereAtencion\": true o false,\n    \"timestamp\": \"{{ $now.toISO() }}\"\n  }\n]\n\n## REGLAS DE FORMATO\n- No incluyas texto antes ni despuÃ©s del JSON.\n- No uses comillas triples, markdown, ni explicaciones.\n- AsegÃºrate de que el JSON sea vÃ¡lido y pueda parsearse directamente con JSON.parse().\n- Evita cualquier pregunta o frase abierta. El tono debe ser profesional, informativo y cerrado."
				}
			},
			"type": "@n8n/n8n-nodes-langchain.agent",
			"typeVersion": 2.2,
			"position": [2592, 3360],
			"id": "0be9af1d-853a-4b12-b894-9ddb6adadd2e",
			"name": "AI General Inq or Out Scope"
		},
		{
			"parameters": {
				"sessionIdType": "customKey",
				"sessionKey": "={{ $json.wa_id }}"
			},
			"type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
			"typeVersion": 1.3,
			"position": [2688, 3568],
			"id": "61516a49-2a10-4dd2-b13b-234b59fb3e5c",
			"name": "Simple Memory1"
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('Get: User Context General Inq or Out Scope').item.json.wa_id }}",
				"textBody": "={{ $json.message }}",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [3168, 3360],
			"id": "9d589fbf-c2f9-4055-a6eb-9ef411163b01",
			"name": "Message: General Inq or Out Scope",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "// ===================================================\n// NODE: Parse AI JSON\n// ===================================================\n// Este nodo toma la respuesta cruda de la IA (por ejemplo, del nodo \"AI Agent\")\n// y la convierte en datos estructurados.\n// Espera un JSON en formato:\n// [\n//   {\n//     \"message\": \"...\",\n//     \"contexto\": \"...\",\n//     \"requiereAtencion\": true,\n//     \"timestamp\": \"2025-11-06T22:13:00Z\"\n//   }\n// ]\n// ===================================================\n\nconst raw = $json.output || $json.text || $json.message || '';\n\nlet parsed = [];\n\ntry {\n  // El modelo a veces devuelve texto con espacios o saltos de lÃ­nea,\n  // asÃ­ que limpiamos y detectamos el bloque JSON.\n  const jsonMatch = raw.match(/\\[.*\\]/s);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No se encontrÃ³ un arreglo JSON vÃ¡lido en la respuesta.');\n  }\n} catch (err) {\n  return [\n    {\n      json: {\n        error: true,\n        message: 'Error al parsear la salida de la IA',\n        detalle: err.message,\n        raw_output: raw,\n      },\n    },\n  ];\n}\n\n// Si todo saliÃ³ bien, devolvemos cada elemento del arreglo como un item nuevo\nreturn parsed.map(entry => ({\n  json: {\n    message: entry.message || '',\n    contexto: entry.contexto || '',\n    requiereAtencion: entry.requiereAtencion ?? false,\n    timestamp: entry.timestamp || new Date().toISOString(),\n  },\n}));\n"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [2944, 3360],
			"id": "c5770348-877d-43e2-b2a9-41ebac00ae2f",
			"name": "Parse: AI Response"
		},
		{
			"parameters": {
				"method": "POST",
				"url": "=https://vg.g210512.com/api/v1/contactos/{{ $('Get: User Context General Inq or Out Scope').item.json.context_data.api_contact_id }}/comentarios",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n  \"comentario\": \"ðŸ¤– - El contacto escribiÃ³: {{ $('WhatsApp Trigger').item.json.messages[0].text.body }} // Respuesta: {{ $('Parse: AI Response').item.json.message }}\"\n}",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [4000, 3360],
			"id": "52d5cf0c-9127-4322-b9e8-f500174c965f",
			"name": "HTTP Request1",
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts \nSET \n  context_data = jsonb_set(\n    jsonb_set(\n      context_data,\n      '{status}',\n      '\"requiere_atention\"'\n    ),\n    '{last_query}',\n    to_jsonb('{{ $('WhatsApp Trigger').item.json.messages[0].text.body }}'::text)\n  ),\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}'\nRETURNING *;",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [4224, 3360],
			"id": "4372a9ac-517e-4cbe-92f6-d48444bba63f",
			"name": "Update: Status awaiting1",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"authentication": "webhook",
				"content": "=ðŸ“¢ **ATENCIÃ“N PENDIENTE**\n\nðŸ§â€â™‚ï¸ **Prospecto:** *{{ $('Get: User Context General Inq or Out Scope').item.json.context_data.nombre }}*  \nðŸ“± **TelÃ©fono:**   {{ $('Get: User Context General Inq or Out Scope').item.json.wa_id }}\nðŸ¡ **Origen:** *ðŸ¤– - AI WhatsApp*  \nðŸ• **Hora:** {{ new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' }) }}  \n\nðŸ’¬ **Ãšltimo mensaje del cliente:**  \n> {{ $('WhatsApp Trigger').item.json.messages[0].text.body }}\n\nðŸ“Œ **SituacÃ­on Actual:**  \n> {{ $json.contexto || 'Solicita atenciÃ³n o confirmaciÃ³n de cita.' }}\n\n---\n\nâš¡ **AcciÃ³n sugerida:**  \nEl prospecto ya fue **notificado** que su solicitud estÃ¡ siendo atendida.  \nPor favor, **asigna un asesor o confirma seguimiento** en los prÃ³ximos minutos.  \n",
				"options": {}
			},
			"type": "n8n-nodes-base.discord",
			"typeVersion": 2,
			"position": [3376, 3360],
			"id": "97cf5f84-135a-4c54-9d6f-ac4aea81b966",
			"name": "Discord: Attention Message",
			"webhookId": "d0a56f58-550a-46fa-bb94-26037d82b649",
			"credentials": {
				"discordWebhookApi": {
					"id": "T5xO2IcTLSwkGbFt",
					"name": "Discord Webhook account"
				}
			}
		},
		{
			"parameters": {
				"authentication": "webhook",
				"content": "=ðŸ“¢ **NUEVO CONTACTO FILTRADO**\n\nðŸ§â€â™‚ï¸ **Prospecto:** *{{ $('Switch1').item.json.nombre }}*  \nðŸ“± **TelÃ©fono:**   {{ $json.contacts[0].wa_id.substring(3) }}\nðŸ¡ **Origen:** *ðŸ¤– - AI WhatsApp*  \nðŸ• **Hora:** {{ new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' }) }}  \n\nðŸ“Œ **SituacÃ­on Actual:**  \n> Contacto cumple con requisitos\n\n---\n\nâš¡ **AcciÃ³n sugerida:**  \nEl prospecto ya fue **APROBADO** por nuestros estÃ¡ndares, contÃ¡ctalo.  \n",
				"options": {}
			},
			"type": "n8n-nodes-base.discord",
			"typeVersion": 2,
			"position": [6320, 1152],
			"id": "cd11bbbf-87cf-49b0-99fc-512e2497854b",
			"name": "Discord: Approved Message",
			"webhookId": "d0a56f58-550a-46fa-bb94-26037d82b649",
			"credentials": {
				"discordWebhookApi": {
					"id": "T5xO2IcTLSwkGbFt",
					"name": "Discord Webhook account"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const propertyData = $('Parse: Property Information').item.json.propertyData;\nconst contextData = $json.context_data.property_found;\nconst nombre = $('Parse: Property Information').item.json.nombre.split(' ')[0];\n\n// Formatear montos a moneda mexicana\nconst formatCurrency = (amount) => {\n  if (!amount || amount === 'null' || amount === null) return 'No aplica';\n  const numAmount = parseFloat(amount);\n  return new Intl.NumberFormat('es-MX', {\n    style: 'currency',\n    currency: 'MXN'\n  }).format(numAmount);\n};\n\n// Formatear restricciones\nconst restrictions = propertyData.restrictions;\n\nconst formatRestriction = (field, label) => {\n  const value = restrictions[field];\n  if (value === 'si' || value === 'yes' || value === true) {\n    return 'âœ… ' + label;\n  } else if (value === 'no' || value === false) {\n    return 'âŒ No se aceptan ' + label.toLowerCase();\n  } else {\n    return 'âš ï¸ ' + label + ': ' + value;\n  }\n};\n\n// Caso especial para mascotas\nlet mascotasText = '';\nif (restrictions.acepta_mascotas === 'no' || restrictions.acepta_mascotas === false) {\n  mascotasText = 'âŒ No se aceptan mascotas';\n} else if (restrictions.acepta_mascotas === 'si' || restrictions.acepta_mascotas === true) {\n  mascotasText = 'âœ… Solo se acepta una mascota pequeÃ±a (perro o gato pequeÃ±o)';\n} else {\n  mascotasText = 'âš ï¸ Mascotas: ' + restrictions.acepta_mascotas;\n}\n\n// Construir mensaje - usando concatenaciÃ³n en lugar de template strings\nconst mensaje = 'Â¡Listo ' + nombre + '! ðŸ™Œ\\n\\n' +\n'AquÃ­ tienes la informaciÃ³n del inmueble que buscas ðŸ¡âœ¨\\n\\n' +\n'ðŸ“ ' + contextData.title + '\\n' +\n'ðŸ˜ï¸ ' + contextData.colonia + ', ' + contextData.municipio + '\\n' +\n'ðŸ’° ' + contextData.operacion + ': ' + contextData.ammount + '\\n' +\n'ðŸ›ï¸ ' + contextData.rooms + ' recÃ¡maras | ðŸš¿ ' + contextData.baths + ' baÃ±os | ðŸš— ' + contextData.parkings + ' estacionamientos\\n' +\n'ðŸ“ ' + contextData.m2 + ' mÂ² construidos\\n\\n' +\n  \n'Para continuar con el proceso, necesito hacerte unas breves preguntas para confirmar que cumples con los requisitos del arrendador. Â¿EstÃ¡s listo/a? ðŸ˜Š';\n\nreturn {\n  ...$json,\n  formatted_message: mensaje\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [6288, 2160],
			"id": "96e1067b-aeea-4fcf-af9b-18f0cb0ff86a",
			"name": "Parse: Message w Property Info"
		},
		{
			"parameters": {
				"jsCode": "const geminiResponse = $input.first().json.output;  // â† Usar la variable correcta\nconst previousData = $('Get Context with Property').item.json;\n\nlet questions = [];\n\ntry {\n  // Limpiar y parsear\n  const cleanedText = geminiResponse\n    .replace(/```json\\n?/g, '')\n    .replace(/```\\n?/g, '')\n    .trim();\n  \n  questions = JSON.parse(cleanedText);\n} catch (error) {\n  console.error('Error parseando cuestionario:', error);\n  console.error('Contenido recibido:', geminiResponse);\n  \n  // Fallback a preguntas bÃ¡sicas si falla\n  questions = [\n    {\n      field: \"mascotas\",\n      question: \"Â¿Tienes mascotas? ðŸ•ðŸˆ\",\n      type: \"boolean\",\n      expected: false\n    }\n  ];\n}\n\nreturn {\n  status: $('Get Context with Property').first().json.context_data.status,\n  wa_id: previousData.wa_id,\n  nombre: previousData.context_data.nombre,\n  personaje: previousData.context_data.personaje,\n  context_id: previousData.id,\n  questions: questions,\n  totalQuestions: questions.length\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [3008, 2960],
			"id": "93acf797-f6c6-4efd-9d2a-19a6b66120a3",
			"name": "Parse AI Questionnaire"
		},
		{
			"parameters": {
				"model": {
					"__rl": true,
					"value": "gpt-5",
					"mode": "list",
					"cachedResultName": "gpt-5"
				},
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
			"typeVersion": 1.2,
			"position": [2592, 3088],
			"id": "6dcdcc28-784e-4dd7-8c61-ff27d682decb",
			"name": "OpenAI Chat Model3",
			"credentials": {
				"openAiApi": {
					"id": "g8OPzRDvvB6YO7mf",
					"name": "OpenAi account"
				}
			}
		},
		{
			"parameters": {
				"sessionIdType": "customKey",
				"sessionKey": "={{ $json.wa_id }}",
				"contextWindowLength": 10
			},
			"type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
			"typeVersion": 1.3,
			"position": [2752, 3088],
			"id": "c4c7e388-0c2e-4d88-9cc9-2efc82090ad9",
			"name": "Simple Memory2"
		},
		{
			"parameters": {
				"promptType": "define",
				"text": "={{ $json.wa_id }}",
				"options": {
					"systemMessage": "=Eres un asistente conversacional de una inmobiliaria. Tu tarea es generar un cuestionario personalizado y natural basado en las caracterÃ­sticas y restricciones de un inmueble especÃ­fico.\n\nDATOS DEL INMUEBLE:\n{{ $json.context_data.property_found.toJsonString() }}\n\nRESTRICCIONES DEL ARRENDADOR:\n{{ $json.context_data.property_found.restrictions.toJsonString() }}\n\nINSTRUCCIONES:\n\n1. **Genera preguntas conversacionales** siguiendo estos principios:\n   - NUNCA saludes, no pongas palabras como hola, que tal, etc, se supone que tu ya vienes trabajando con el contacto\n   - Primero da contexto o explica la restricciÃ³n\n   - Luego pregunta de forma natural\n   - Usa tono amigable y mexicano\n   - Incluye emojis apropiados\n\n2. **Tipos de preguntas a generar:**\n\n   A) **Si NO acepta mascotas** (acepta_mascotas = \"no\"):\n      - Ejemplo: \"Â¿Tienes mascotas? ðŸ•ðŸˆ\"\n      - field: \"mascotas\"\n      - type: \"boolean\"\n      - expected: false\n\n   B) **Si NO acepta niÃ±os** (acepta_niÃ±os = \"no\"):\n      - Ejemplo: \"PlatÃ­came, Â¿cuÃ¡ntas personas habitarÃ¡n el inmueble? Â¿HabrÃ¡ niÃ±os? ðŸ‘¶\"\n      - field: \"ninos\"\n      - type: \"boolean\"\n      - expected: false\n\n   C) **Si NO acepta estudiantes sin tutor** (acepta_estudiantes = \"no\"):\n      - Ejemplo: \"Muy bien, platÃ­came Â¿cuÃ¡l es tu ocupaciÃ³n actual? ðŸ“š\"\n      - field: \"estudiantes\"\n      - type: \"boolean\"\n      - expected: false\n\n   D) **Si NO acepta roomies** (acepta_roomies = \"no\"):\n      - Ejemplo: \"CuÃ©ntame, Â¿cÃ³mo serÃ¡ tu forma de vivir? Â¿Solo(a) o con roomies? ðŸ‘¥\"\n      - field: \"roomies\"\n      - type: \"boolean\"\n      - expected: false\n\n   E) **Ingresos mÃ­nimos** (si existe y > 0):\n      - Ejemplo: \"Una pregunta importante: Â¿cuÃ¡l es tu ingreso mensual comprobable? ðŸ’µ (El mÃ­nimo requerido es $XX,XXX)\"\n      - field: \"ingresos\"\n      - type: \"number_minimum\"\n      - expected: [valor numÃ©rico]\n\n   F) **Comprobantes de ingresos** (si requiere_comprobantes_ingresos = true):\n      - Ejemplo: \"Â¿Cuentas con recibos de nÃ³mina, estados de cuenta o facturas que comprueben tus ingresos mensuales? ðŸ“‹\"\n      - field: \"comprobantes\"\n      - type: \"boolean\"\n      - expected: true\n\n3. **Agrega preguntas adicionales basadas en caracterÃ­sticas del inmueble:**\n\n   - **Si parkings = 0**: \"Te comento que el inmueble no cuenta con estacionamiento ðŸš— Â¿EstÃ¡s de acuerdo con eso?\"\n   - **Si tiene mÃ¡s de 3 pisos y no menciona elevador**: \"El depa estÃ¡ en el [X] piso y no tiene elevador ðŸ¢ Â¿Tienes algÃºn inconveniente?\"\n   - Cualquier otra caracterÃ­stica relevante que valga la pena preguntar\n\nFORMATO DE SALIDA (JSON ARRAY):\n\n[\n  {\n    \"field\": \"mascotas\",\n    \"question\": \"Â¿Tienes mascotas? ðŸ•ðŸˆ\",\n    \"type\": \"boolean\",\n    \"expected\": false\n  },\n  {\n    \"field\": \"estacionamiento\",\n    \"question\": \"Te comento que el inmueble no cuenta con estacionamiento ðŸš—\\nÂ¿EstÃ¡s de acuerdo con eso?\",\n    \"type\": \"boolean\",\n    \"expected\": true\n  }\n]\n\nIMPORTANTE:\n- NO uses markdown (```json)\n- NO agregues explicaciones\n- Responde SOLO con el JSON array\n- MantÃ©n el tono conversacional y natural"
				}
			},
			"type": "@n8n/n8n-nodes-langchain.agent",
			"typeVersion": 2.2,
			"position": [2656, 2912],
			"id": "e71d038a-c7d8-48f7-8b64-1a566d81c62f",
			"name": "AI Generate Dynamic Questionnaire"
		},
		{
			"parameters": {
				"content": "## ---> Misbehavior",
				"height": 496,
				"width": 2160
			},
			"type": "n8n-nodes-base.stickyNote",
			"position": [576, -96],
			"typeVersion": 1,
			"id": "81e6ec54-0aa3-48c5-a4ab-54b7d9c18ff8",
			"name": "Sticky Note"
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "gpt-5-nano",
					"mode": "list",
					"cachedResultName": "GPT-5-NANO"
				},
				"messages": {
					"values": [
						{
							"content": "=Tu funciÃ³n es analizar el contenido de {{ $json.data.comentario }} para identificar el motivo del rechazo (por ejemplo: lenguaje ofensivo, actitud inapropiada, insistencia indebida o falta de respeto).\n\nCon base en ello, redacta un mensaje breve, claro y profesional que:\n1. Indique que la interacciÃ³n ha sido rechazada.\n2. Informe que el contacto ha sido bloqueado por comportamiento inapropiado.\n3. Mantenga un tono amable, empÃ¡tico y sin agresividad.\n4. Termine con un cierre cordial (por ejemplo: deseando Ã©xito o buen dÃ­a).\n\nEjemplo de estilo esperado:\n\"Ups ðŸ˜•, derivado de tu mensaje anterior hemos rechazado y bloqueado tu contacto, ya que no se permiten faltas de respeto ni conductas inapropiadas. Te deseamos mucho Ã©xito en tu bÃºsqueda.\"\n\nEvita repetir el texto del ejemplo; genera una versiÃ³n coherente y natural adaptada al contexto del comentario recibido.\n",
							"role": "system"
						}
					]
				},
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.openAi",
			"typeVersion": 1.8,
			"position": [2000, 208],
			"id": "2fe05865-8aff-440e-bcbd-52e060cc1282",
			"name": "Message a model",
			"credentials": {
				"openAiApi": {
					"id": "g8OPzRDvvB6YO7mf",
					"name": "OpenAi account"
				}
			}
		},
		{
			"parameters": {
				"conditions": {
					"options": {
						"caseSensitive": true,
						"leftValue": "",
						"typeValidation": "strict",
						"version": 2
					},
					"conditions": [
						{
							"id": "8b83aa35-ef33-4786-a195-3a03ce566f4c",
							"leftValue": "={{ $json.context_data.status }}",
							"rightValue": "rejected",
							"operator": {
								"type": "string",
								"operation": "equals",
								"name": "filter.operator.equals"
							}
						}
					],
					"combinator": "and"
				},
				"options": {}
			},
			"type": "n8n-nodes-base.if",
			"typeVersion": 2.2,
			"position": [3776, 2096],
			"id": "5061e78b-45f9-45cd-8472-1a680dce0716",
			"name": "If"
		},
		{
			"parameters": {
				"method": "POST",
				"url": "=https://vg.g210512.com/api/v1/contactos/{{ $('Check Context Status').item.json.context_data.api_contact_id }}/comentarios",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n\"comentario\":{{ $json.body.comentario.toJsonString() }}\n}\n",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [3232, 832],
			"id": "28a29848-f48f-4868-810d-cf4d11cab7de",
			"name": "Update: Contact Comments1",
			"credentials": {
				"httpBearerAuth": {
					"id": "QigdAtAlBxHMmIsD",
					"name": "WA - Bearer Token"
				},
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "const aiResponse = $input.first().json;\n\nconst getNodeJson = (nodeName, extractor) => {\n  try {\n    const nodeData = $(nodeName);\n    const item = nodeData?.first?.();\n    if (!item) return undefined;\n    return extractor ? extractor(item) : item.json;\n  } catch (error) {\n    return undefined;\n  }\n};\n\nconst contactId =\n  getNodeJson('Contact Actions', (item) => item.json?.contactId) ??\n  getNodeJson('Actual status of contact', (item) => item.json?.contactData?.id) ??\n  getNodeJson('Has Postgres Context?', (item) => item.json?.api_contact_id) ??\n  getNodeJson('Check Context Status', (item) => item.json?.context_data?.api_contact_id) ??\n  aiResponse?.contactId ??\n  null;\n\nif (!contactId) {\n  throw new Error('No se pudo obtener el contactId para el comentario de rechazo.');\n}\n\nconsole.log('AI Response completo:', JSON.stringify(aiResponse, null, 2));\n\nlet summary = aiResponse?.output ??\n              aiResponse?.content?.parts?.[0]?.text ??\n              aiResponse?.text ??\n              aiResponse;\n\nif (typeof summary === 'object') {\n  summary = JSON.stringify(summary);\n}\n\nif (typeof summary === 'string') {\n  summary = summary.trim();\n}\n\nconsole.log('Summary extraÃ­do:', summary);\n\nreturn {\n  contactId,\n  body: {\n    comentario: summary,\n    created_at: new Date().toISOString()\n  }\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [2960, 688],
			"id": "a0b9deca-8a3a-4466-a9fc-3e066530f5e1",
			"name": "Format Reject Comment Payload"
		},
		{
			"parameters": {},
			"type": "n8n-nodes-base.merge",
			"typeVersion": 2.1,
			"position": [1504, 688],
			"id": "93bf019d-4afc-40b2-9a08-c6bdb8d6f3af",
			"name": "Merge Rejection Sources"
		},
		{
			"parameters": {
				"assignments": {
					"assignments": [
						{
							"id": "1f2fb1b0-9b10-4f2a-9f1e-2c1a6d0bcd70",
							"name": "wa_id",
							"value": "={{ $json.wa_id || $('Has Postgres Context?').item.json.wa_id || $('Contact Actions').item.json.wa_id || $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
							"type": "string"
						},
						{
							"id": "5a75b457-4b78-4f37-9e9d-4314f38fe0fd",
							"name": "context_data",
							"value": "={{ Object.assign({}, $('Check Context Status').item.json.context_data || {}, $json.context_data || {}) }}",
							"type": "json"
						},
						{
							"id": "d8db9700-84d2-4e4f-aeb8-1d0f8d49fd1b",
							"name": "rejectionSummary",
							"value": "={{ $json.rejectionSummary || '' }}",
							"type": "string"
						},
						{
							"id": "0d439b03-31c2-4ac5-b5df-2fa467db1749",
							"name": "contactData",
							"value": "={{ $json.contactData || null }}",
							"type": "json"
						},
						{
							"id": "6f9dc637-1ab7-4ce8-8f16-2ca36d5e1d5a",
							"name": "misbehaviorHistoryEntry",
							"value": "={{ $json.misbehaviorHistoryEntry || null }}",
							"type": "json"
						},
						{
							"id": "a3d969a0-9434-4986-8d30-2a1523cba4a5",
							"name": "rejectionSource",
							"value": "={{ $json.rejectionSummary ? 'actual_status' : 'context_status' }}",
							"type": "string"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.set",
			"typeVersion": 3.4,
			"position": [1712, 688],
			"id": "e37474db-8e0b-4c91-8258-937cabe00b9d",
			"name": "Set: Rejection Payload"
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "models/gemini-2.5-flash",
					"mode": "list",
					"cachedResultName": "models/gemini-2.5-flash"
				},
				"messages": {
					"values": [
						{
							"content": "={{ $json.context_data.toJsonString() }}"
						}
					]
				},
				"options": {
					"systemMessage": "=Tu funciÃ³n es analizar el contenido de {{ $json.context_data.mal_comportamiento_historial.toJsonString() }} para identificar el motivo del rechazo (por ejemplo: lenguaje ofensivo, actitud inapropiada, insistencia indebida o falta de respeto).\n\nSiempre debes mencionar que el rechazo es por faltas de respeto o comportamiento inapropiado en previas interacciones\n\nCon base en ello, redacta un mensaje breve, claro y profesional que:\n1. Indique que la interacciÃ³n ha sido rechazada.\n2. Informe que el contacto ha sido bloqueado por comportamiento inapropiado.\n3. Mantenga un tono amable, empÃ¡tico y sin agresividad.\n4. Termine con un cierre cordial (por ejemplo: deseando Ã©xito o buen dÃ­a).\n\nEjemplo de estilo esperado:\n\"Ups ðŸ˜•, derivado de tu faltas de respeto en interacciones previas hemos rechazado y bloqueado tu contacto, ya que no se permiten faltas de respeto ni conductas inapropiadas. Te deseamos mucho Ã©xito en tu bÃºsqueda.\"\n\nEvita repetir el texto del ejemplo; genera una versiÃ³n coherente y natural adaptada al contexto del comentario recibido.\n"
				}
			},
			"type": "@n8n/n8n-nodes-langchain.googleGemini",
			"typeVersion": 1,
			"position": [2000, 688],
			"id": "2da62115-efc5-4041-bb96-fcdfd03930f7",
			"name": "AI: Create Reject Message",
			"credentials": {
				"googlePalmApi": {
					"id": "3Qw3858fHslDYr4D",
					"name": "Gemini - alfgow"
				}
			}
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
				"textBody": "={{ $json.content.parts[0].text }}",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [2384, 688],
			"id": "95e1794e-a365-4407-8e82-b4941107c964",
			"name": "Message: Reject 2",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "models/gemini-2.5-flash",
					"mode": "list",
					"cachedResultName": "models/gemini-2.5-flash"
				},
				"messages": {
					"values": [{}]
				},
				"options": {
					"systemMessage": "=\nGenera un resumen ejecutivo de la interacciÃ³n para el equipo de la inmobiliaria.\n\nIMPORTANTE AGREGAR AL INICIO DEL RESUMEN: âŒ RECHAZADO\n\nCONTEXTO DEL CONTACTO:\nNombre: {{ $('Check Context Status').item.json.context_data.nombre }}\nTelÃ©fono: {{ $('Check Context Status').item.json.context_data.telefono }}\nHistorial previo: {{ $('Check Context Status').item.json.context_data.mal_comportamiento_historial.toJsonString() }}\n\nINTERACCIÃ“N ACTUAL:\nEl contacto escribiÃ³: \"{{ $('WhatsApp Trigger').item.json.messages[0].text.body }}\"\n\nRespuesta del bot: {{ $('AI: Create Reject Message').item.json.content.parts[0].text }}\n\nFORMATO REQUERIDO:\nðŸ¤– **BOT WhatsApp** - {{ $now.format('dd/MM/yyyy HH:mm') }}\n\nðŸ“± **Contacto escribiÃ³:**\n[mensaje del usuario]\n\nðŸ” **DetecciÃ³n automÃ¡tica:**\nSe identificÃ³ que este contacto tiene un rechazo previo por: [razÃ³n especÃ­fica del rechazo]\n\nðŸ“¤ **Bot respondiÃ³:**\n[resumen del mensaje enviado en 2-3 lÃ­neas]\n\nðŸ“‹ **Resultado:**\nContacto rechazado automÃ¡ticamente. No se continuÃ³ con el flujo de atenciÃ³n.\n\nINSTRUCCIONES:\n- SÃ© conciso pero informativo\n- Usa emojis para mejor escaneo visual\n- Menciona la razÃ³n especÃ­fica del rechazo previo\n- MÃ¡ximo 150 palabras\n- Formato markdown para mejor lectura"
				}
			},
			"type": "@n8n/n8n-nodes-langchain.googleGemini",
			"typeVersion": 1,
			"position": [2624, 688],
			"id": "6fdb80bf-6e91-4e3e-bd4e-12d5bad191cd",
			"name": "AI: Create Reject Resume",
			"credentials": {
				"googlePalmApi": {
					"id": "3Qw3858fHslDYr4D",
					"name": "Gemini - alfgow"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts\nSET context_data = jsonb_set(\n      context_data,\n      '{status}',\n      '\"blocked\"',\n      false\n    ),\n    updated_at = NOW()\nWHERE wa_id = CAST({{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }} AS TEXT);",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [3536, 864],
			"id": "3e0295f4-ccb0-46e3-9c32-4065f1f01e53",
			"name": "Execute a SQL query4",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $json.context_data.status }}",
										"rightValue": "blocked",
										"operator": {
											"type": "string",
											"operation": "equals"
										},
										"id": "d47e08b1-4c9d-402c-992e-f00cbb9b3af3"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "blocked"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "ad050447-b659-409e-bcfd-a037caac5943",
										"leftValue": "={{ $json.context_data.status }}",
										"rightValue": "rejected",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "rejected"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "8d34428d-f6e5-4bf1-adbe-bc9703683fb2",
										"leftValue": "={{ $json.context_data.status }}",
										"rightValue": "approved",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "approved"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "b60d19ee-3fe2-4014-8416-bdbfee424244",
										"leftValue": "={{ $json.postgresContextId }}",
										"rightValue": "",
										"operator": {
											"type": "number",
											"operation": "exists",
											"singleValue": true
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "No Context"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [1088, 528],
			"id": "17c3e93a-781f-47cc-870b-1eafdced0525",
			"name": "Switch2"
		},
		{
			"parameters": {},
			"type": "n8n-nodes-base.noOp",
			"typeVersion": 1,
			"position": [1056, 928],
			"id": "764dd634-f373-46c6-8f48-8532f6ccc238",
			"name": "No Operation, do nothing"
		},
		{
			"parameters": {
				"operation": "send",
				"phoneNumberId": "812415788624920",
				"recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
				"textBody": "=ðŸ˜… Tuvimos un error de nuestro lado, intenta de nuevo por favor",
				"additionalFields": {}
			},
			"type": "n8n-nodes-base.whatsApp",
			"typeVersion": 1.1,
			"position": [-144, 1056],
			"id": "f4a774f6-b3db-4cc2-9f1b-b5b73a4f408f",
			"name": "Error Message",
			"webhookId": "32e518a9-64a8-4186-a7b0-d0962d11939a",
			"credentials": {
				"whatsAppApi": {
					"id": "DpdLgHZCEJ199330",
					"name": "WhatsApp account"
				}
			}
		},
		{
			"parameters": {
				"jsCode": "// Obtener respuesta de OpenAI\nconst aiResponse = $input.first().json;\nconst contentText = aiResponse.message?.content || aiResponse.output || '';\n\n// Obtener datos originales del nodo anterior a la IA\nconst originalData = $('Has Postgres Context?').item.json;\n\nlet result = {\n  isMisbehavior: false,\n  confidence: 0,\n  reason: '',\n  detectedTerms: []\n};\n\ntry {\n  // Limpiar y parsear el JSON\n  const cleaned = contentText\n    .replace(/```json\\n?/g, '')\n    .replace(/```\\n?/g, '')\n    .trim();\n  \n  result = JSON.parse(cleaned);\n} catch (error) {\n  console.error('Error parsing misbehavior detection:', error);\n  console.log('Content received:', contentText);\n}\n\nreturn {\n  json: {\n    userPrompt: originalData.userPrompt,\n    wa_id: originalData.wa_id,\n    context_data: originalData.context_data,\n    hasPostgresContext: originalData.hasPostgresContext,\n    postgresContextId: originalData.postgresContextId,\n    misbehaviorDetected: result.isMisbehavior,\n    misbehaviorConfidence: result.confidence,\n    misbehaviorReason: result.reason,\n    misbehaviorMatchedWords: result.detectedTerms,\n    phone:$('Get: Message Info').first().json.phone\n  }\n};"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [-32, 384],
			"id": "bf799f9c-0ca7-4cf6-9b46-029ab3215688",
			"name": "Parse Misbehavior"
		},
		{
			"parameters": {
				"modelId": {
					"__rl": true,
					"value": "gpt-5-nano",
					"mode": "list",
					"cachedResultName": "GPT-5-NANO"
				},
				"messages": {
					"values": [
						{
							"content": "=Eres un detector de comportamiento inapropiado en mensajes de clientes.\n\nMENSAJE DEL CLIENTE: {{ $json.userPrompt }}\n\nINSTRUCCIONES:\nAnaliza si el mensaje contiene:\n- Insultos directos o indirectos\n- Lenguaje ofensivo o profano\n- Amenazas (legales, fÃ­sicas, etc)\n- Acoso o discriminaciÃ³n\n- GroserÃ­as en espaÃ±ol mexicano\n- Intento de evadir filtros (p3nd3jo, p e n d e j o, etc)\n\nIMPORTANTE:\n- NO marques como ofensivo: quejas legÃ­timas, frustraciÃ³n educada, crÃ­ticas constructivas\n- SÃ marca como ofensivo: insultos personales, amenazas, lenguaje agresivo\n\nFORMATO DE SALIDA (JSON):\n{\n  \"isMisbehavior\": true o false,\n  \"confidence\": 0.0 a 1.0,\n  \"reason\": \"RazÃ³n especÃ­fica si es ofensivo, vacÃ­o si no\",\n  \"detectedTerms\": [\"lista de tÃ©rminos ofensivos detectados\"]\n}\n\nNO uses markdown. Solo responde con el JSON.",
							"role": "system"
						}
					]
				},
				"options": {}
			},
			"type": "@n8n/n8n-nodes-langchain.openAi",
			"typeVersion": 1.8,
			"position": [-352, 384],
			"id": "2b883074-f547-42c3-978c-1d77a172cd46",
			"name": "AI Misbehavior Detector",
			"credentials": {
				"openAiApi": {
					"id": "g8OPzRDvvB6YO7mf",
					"name": "OpenAi account"
				}
			}
		},
		{
			"parameters": {
				"url": "=https://vg.g210512.com/api/v1/contactos?telefono={{ $json.phone }}",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [720, 0],
			"id": "a55c8f8b-7eac-4701-8ebe-e846a65afc00",
			"name": "Get API Contact",
			"alwaysOutputData": true,
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {},
			"type": "n8n-nodes-base.noOp",
			"typeVersion": 1,
			"position": [2544, 208],
			"id": "7718adde-9484-41a4-b83b-1b643318968e",
			"name": "No Operation, do nothing1"
		},
		{
			"parameters": {},
			"type": "n8n-nodes-base.noOp",
			"typeVersion": 1,
			"position": [192, -32],
			"id": "984d469f-5635-453b-aa5c-c47495e4a12f",
			"name": "No Operation, do nothing2"
		},
		{
			"parameters": {
				"jsCode": "const source = $input.first()?.json ?? {};\nconst clone = (data) => JSON.parse(JSON.stringify(data ?? {}));\nconst contextData = clone(source.context_data);\n\nconst cleanString = (value) => (typeof value === 'string' ? value.trim() : '');\n\nconst reasonText =\n  cleanString(source.misbehaviorReason) ||\n  cleanString(source.reasonText) ||\n  'Comportamiento indebido detectado automÃ¡ticamente';\n\nconst matchedWords = Array.isArray(source.misbehaviorMatchedWords)\n  ? source.misbehaviorMatchedWords.filter((word) => cleanString(word))\n  : [];\n\nconst originalMessage =\n  cleanString(source.misbehaviorOriginalMessage) ||\n  cleanString(source.userPrompt) ||\n  cleanString(source.originalMessage) ||\n  '';\n\nconst timestamp = new Date().toISOString();\n\nconst historyEntry = {\n  timestamp,\n  mensaje_original: originalMessage,\n  palabras_detectadas: matchedWords,\n  origen: 'auto_filter'\n};\n\nconst history = Array.isArray(contextData.mal_comportamiento_historial)\n  ? [...contextData.mal_comportamiento_historial, historyEntry]\n  : [historyEntry];\n\nconst reasons = Array.isArray(contextData.motivo_rechazo)\n  ? [...contextData.motivo_rechazo]\n  : [];\nif (!reasons.includes(reasonText)) {\n  reasons.push(reasonText);\n}\n\nconst contactLookups = [];\n\ntry {\n  const apiData = $('Get API Contact1')?.first()?.json?.data;\n  if (Array.isArray(apiData) && apiData.length) {\n    contactLookups.push(apiData[0]);\n  }\n} catch (error) {}\n\ntry {\n  const apiData = $('Get API Contact')?.first()?.json?.data;\n  if (Array.isArray(apiData) && apiData.length) {\n    contactLookups.push(apiData[0]);\n  }\n} catch (error) {}\n\nconst apiContactId =\n  source.api_contact_id ??\n  contextData.api_contact_id ??\n  contactLookups.find((contact) => contact?.id)?.id ??\n  null;\n\nif (!apiContactId) {\n  throw new Error('No se encontrÃ³ api_contact_id en el contexto para registrar el comentario de bloqueo.');\n}\n\nconst fallbackName =\n  cleanString(source.fallbackName) ||\n  cleanString(source.contactName) ||\n  cleanString(contextData.nombre) ||\n  contactLookups.map((contact) => cleanString(contact?.nombre)).find(Boolean) ||\n  'ðŸ¤– - Contacto Bloqueado';\n\nconst commentLines = [\n  'ðŸš« IGNORADO POR BLOQUEO ðŸš«',\n  `Motivo: ${reasonText}`,\n  matchedWords.length ? `Coincidencias: ${matchedWords.join(', ')}` : '',\n  originalMessage ? `Mensaje original: \"${originalMessage}\"` : '',\n  `Registrado el: ${timestamp}`\n].filter((line) => cleanString(line));\n\nconst existingInteractions = Array.isArray(contextData.interacciones)\n  ? contextData.interacciones.map((entry) => ({ ...entry }))\n  : [];\n\nconst userInteraction = {\n  timestamp,\n  actor: 'usuario',\n  canal: 'whatsapp',\n  tipo: 'mensaje_recibido',\n  mensaje: originalMessage,\n  origen: 'auto_filter',\n  detalles: {\n    motivo: reasonText,\n    palabras_detectadas: matchedWords\n  }\n};\n\nconst systemInteraction = {\n  timestamp,\n  actor: 'sistema',\n  canal: 'whatsapp',\n  tipo: 'mensaje_ignorado_por_bloqueo',\n  mensaje: 'Mensaje ignorado por bloqueo activo.',\n  detalles: {\n    motivo: reasonText,\n    comentario: commentLines.join('\n')\n  }\n};\n\nconst updatedInteractions = [...existingInteractions, userInteraction, systemInteraction];\n\nconst waId =\n  cleanString(source.wa_id) ||\n  cleanString(contextData.wa_id) ||\n  cleanString($('Has Postgres Context?')?.first()?.json?.wa_id) ||\n  cleanString($('Get: Message Info')?.first()?.json?.wa_id) ||\n  cleanString($('WhatsApp Trigger')?.first()?.json?.contacts?.[0]?.wa_id) ||\n  null;\n\nconst updatedContext = {\n  ...contextData,\n  nombre: fallbackName,\n  status: 'blocked',\n  rechazo_previo: true,\n  motivo_rechazo: reasons,\n  mal_comportamiento_historial: history,\n  ultima_interaccion: timestamp,\n  api_contact_id: apiContactId,\n  interacciones: updatedInteractions\n};\n\nreturn [\n  {\n    json: {\n      wa_id: waId,\n      api_contact_id: apiContactId,\n      commentPayload: {\n        comentario: commentLines.join('\\n')\n      },\n      updatedContext,\n      historyEntry,\n      reasonText,\n      matchedWords,\n      originalMessage,\n      timestamp\n    }\n  }\n];\n"
			},
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [-304, -32],
			"id": "8a079a6e-c417-486d-a26c-003160ae0d9c",
			"name": "Build Blocked Comment Payload"
		},
		{
			"parameters": {
				"method": "POST",
				"url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.api_contact_id }}/comentarios",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={{ $json.commentPayload.toJsonString() }}",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [-112, -32],
			"id": "49a582b6-9e11-4511-94be-d8e1482970dc",
			"name": "API: Add Blocked Comment",
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		},
		{
			"parameters": {
				"operation": "executeQuery",
				"query": "UPDATE user_contexts\nSET\n  context_data = '{{ $(\"Build Blocked Comment Payload\").item.json.updatedContext.toJsonString() }}'::jsonb,\n  updated_at = CURRENT_TIMESTAMP\nWHERE wa_id = '{{ $(\"Build Blocked Comment Payload\").item.json.wa_id }}'\nRETURNING\n  id,\n  wa_id,\n  context_data,\n  context_data->>'api_contact_id' AS api_contact_id;\n\n",
				"options": {}
			},
			"type": "n8n-nodes-base.postgres",
			"typeVersion": 2.6,
			"position": [48, -32],
			"id": "a7cdd5ec-f352-42ac-87b9-0000b7cb8235",
			"name": "Postgres: Update Blocked Context",
			"credentials": {
				"postgres": {
					"id": "qyR2OAIR7tUEVcQf",
					"name": "Postgres-neon"
				}
			}
		},
		{
			"parameters": {
				"conditions": {
					"options": {
						"caseSensitive": true,
						"leftValue": "",
						"typeValidation": "strict",
						"version": 2
					},
					"conditions": [
						{
							"id": "ac8010bd-97b8-4d50-9ec6-91015177b232",
							"leftValue": "={{ $json.context_data.status }}",
							"rightValue": "blocked",
							"operator": {
								"type": "string",
								"operation": "equals",
								"name": "filter.operator.equals"
							}
						}
					],
					"combinator": "and"
				},
				"options": {}
			},
			"type": "n8n-nodes-base.if",
			"typeVersion": 2.2,
			"position": [336, 160],
			"id": "c4c6c7d2-5589-49a2-ab18-ba1dcd96f4a6",
			"name": "Is Blocked?"
		},
		{
			"parameters": {
				"rules": {
					"values": [
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"leftValue": "={{ $('Get API Contact1').item.json.data[0].estado }}",
										"rightValue": "blocked",
										"operator": {
											"type": "string",
											"operation": "equals"
										},
										"id": "8281b321-52c2-48a0-aa3b-4b1b0dec841f"
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "block-api"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "a894962f-3420-4765-b14e-07d25b097abf",
										"leftValue": "={{ $('Check Context Status').item.json.context_data.status }}",
										"rightValue": "blocked",
										"operator": {
											"type": "string",
											"operation": "equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "block-postgres"
						},
						{
							"conditions": {
								"options": {
									"caseSensitive": true,
									"leftValue": "",
									"typeValidation": "strict",
									"version": 2
								},
								"conditions": [
									{
										"id": "7fb769ac-a83d-49ae-ad30-7187a051316f",
										"leftValue": "",
										"rightValue": "=",
										"operator": {
											"type": "string",
											"operation": "equals",
											"name": "filter.operator.equals"
										}
									}
								],
								"combinator": "and"
							},
							"renameOutput": true,
							"outputKey": "nothing"
						}
					]
				},
				"options": {}
			},
			"type": "n8n-nodes-base.switch",
			"typeVersion": 3.3,
			"position": [864, 448],
			"id": "3cee5689-6b9a-4a50-a32f-e6acd9170f38",
			"name": "Switch3"
		},
		{
			"parameters": {
				"url": "=https://vg.g210512.com/api/v1/contactos?telefono={{ $json.phone }}",
				"authentication": "genericCredentialType",
				"genericAuthType": "httpHeaderAuth",
				"options": {}
			},
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [304, 528],
			"id": "d38c111d-c318-4e12-a479-bc4b297fa8d0",
			"name": "Get API Contact1",
			"alwaysOutputData": true,
			"credentials": {
				"httpHeaderAuth": {
					"id": "rzmCtJN8Vtwv6AO3",
					"name": "API Key Inmuebles"
				}
			}
		}
	],
	"connections": {
		"WhatsApp Trigger": {
			"main": [
				[
					{
						"node": "Switch",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"If: Misbehavior?": {
			"main": [
				[
					{
						"node": "Is Blocked?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Get Misbehavior Context": {
			"main": [
				[
					{
						"node": "Prepare Misbehavior Context",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Prepare Misbehavior Context": {
			"main": [
				[
					{
						"node": "Postgres: Insert Misbehavior Context",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Postgres: Insert Misbehavior Context": {
			"main": [
				[
					{
						"node": "API: Create Misbehavior Contact",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"API: Create Misbehavior Contact": {
			"main": [
				[
					{
						"node": "Postgres: Save API Contact (New)",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Postgres: Save API Contact (New)": {
			"main": [
				[
					{
						"node": "Build Misbehavior Comment",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Build Misbehavior Comment": {
			"main": [
				[
					{
						"node": "API: Add Misbehavior Comment",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"API: Add Misbehavior Comment": {
			"main": [
				[
					{
						"node": "Message a model",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Send Misbehavior Notice": {
			"main": [
				[
					{
						"node": "No Operation, do nothing1",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Switch": {
			"main": [
				[
					{
						"node": "Get: Message Info",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Send message2",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Send message2",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Send message2",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Download media3",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Error Message",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Download media3": {
			"main": [
				[
					{
						"node": "HTTP Request3",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"HTTP Request3": {
			"main": [
				[
					{
						"node": "Transcribe: audio",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Transcribe: audio": {
			"main": [
				[
					{
						"node": "Get: Message Info",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Edit Fields": {
			"main": [
				[
					{
						"node": "Execute a SQL query",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Execute a SQL query": {
			"main": [
				[
					{
						"node": "If",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Check and Assign Character": {
			"main": [
				[
					{
						"node": "If: Is New Contact",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"If: Is New Contact": {
			"main": [
				[
					{
						"node": "Set: New Costumer",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Switch: Intent",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Set: New Costumer": {
			"main": [
				[
					{
						"node": "Merge Context Data",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Merge Context Data": {
			"main": [
				[
					{
						"node": "Switch: Intent",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse Context Data": {
			"main": [
				[
					{
						"node": "Check missing Data",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Get: User Context": {
			"main": [
				[
					{
						"node": "Parse Context Data",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Check missing Data": {
			"main": [
				[
					{
						"node": "Actual Status",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Actual Status": {
			"main": [
				[
					{
						"node": "AI Agent",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Request Data",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Request Data": {
			"main": [
				[
					{
						"node": "Update: Status awaiting",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Check Context Status": {
			"main": [
				[
					{
						"node": "Has Postgres Context?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse: Status": {
			"main": [
				[
					{
						"node": "Switch: is Awaiting?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Extract Name & Phone": {
			"main": [
				[
					{
						"node": "Is Valid Data",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Prepare for Property Search": {
			"main": [
				[
					{
						"node": "Send message4",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Detect: Intention": {
			"main": [
				[
					{
						"node": "Edit Fields",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Is Valid Data": {
			"main": [
				[
					{
						"node": "Get Context Awating Data",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Message: Wrong Name & Phone",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Get Context Awating Data": {
			"main": [
				[
					{
						"node": "Prepare for Property Search",
						"type": "main",
						"index": 0
					},
					{
						"node": "API: Set new costumer",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Call 'InmuebleFinderTool'1": {
			"ai_tool": [
				[
					{
						"node": "AI Agent - Get Property",
						"type": "ai_tool",
						"index": 0
					}
				]
			]
		},
		"Get Context with Property": {
			"main": [
				[
					{
						"node": "AI Generate Dynamic Questionnaire",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"AI Agent - Get Property": {
			"main": [
				[
					{
						"node": "Parse: Property Information",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse: Property Information": {
			"main": [
				[
					{
						"node": "Update: Costumer Context",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Update: Costumer Context": {
			"main": [
				[
					{
						"node": "Add Property Interest",
						"type": "main",
						"index": 0
					},
					{
						"node": "Parse: Message w Property Info",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Switch: Intent": {
			"main": [
				[
					{
						"node": "Get: User Context",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Send message1",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Get: User Context General Inq or Out Scope",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Get Context with Property",
						"type": "main",
						"index": 0
					}
				],
				[],
				[
					{
						"node": "Get: User Context General Inq or Out Scope",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"If: Is Awaiting Questionaire": {
			"main": [
				[
					{
						"node": "Execute a SQL query1",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Send message1",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Execute a SQL query1": {
			"main": [
				[
					{
						"node": "Send message5",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Check Questionnaire Status": {
			"main": [
				[
					{
						"node": "Is In Questionnaire",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Is In Questionnaire": {
			"main": [
				[
					{
						"node": "Process Answer & Next Question",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Parse: Status",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Process Answer & Next Question": {
			"main": [
				[
					{
						"node": "Update: Context questions",
						"type": "main",
						"index": 0
					},
					{
						"node": "Has More Questions?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Has More Questions?": {
			"main": [
				[
					{
						"node": "Send message6",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Message a model1",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Send message4": {
			"main": [
				[
					{
						"node": "AI Agent - Get Property",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Switch1": {
			"main": [
				[
					{
						"node": "Execute a SQL query2",
						"type": "main",
						"index": 0
					},
					{
						"node": "Message: Aprobado",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Execute a SQL query3",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Execute a SQL query2": {
			"main": [
				[
					{
						"node": "Generate Resume",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Execute a SQL query3": {
			"main": [
				[
					{
						"node": "Message: Rejected",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Message: Aprobado": {
			"main": [
				[
					{
						"node": "Discord: Approved Message",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"AI Agent": {
			"main": [
				[
					{
						"node": "Message: Reject",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Simple Memory": {
			"ai_memory": [
				[
					{
						"node": "AI Agent",
						"type": "ai_memory",
						"index": 0
					}
				]
			]
		},
		"Call 'ContactoFinderTool'": {
			"ai_tool": [
				[
					{
						"node": "Contact Finder",
						"type": "ai_tool",
						"index": 0
					}
				]
			]
		},
		"Contact Actions": {
			"main": [
				[
					{
						"node": "Actual status of contact",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Prepare Message Data": {
			"main": [
				[
					{
						"node": "Check Questionnaire Status",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Contact Finder": {
			"main": [
				[
					{
						"node": "Contact Actions",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"OpenAI Chat Model1": {
			"ai_languageModel": [
				[
					{
						"node": "AI Agent - Get Property",
						"type": "ai_languageModel",
						"index": 0
					}
				]
			]
		},
		"OpenAI Chat Model2": {
			"ai_languageModel": [
				[
					{
						"node": "AI Agent",
						"type": "ai_languageModel",
						"index": 0
					}
				]
			]
		},
		"Switch: is Awaiting?": {
			"main": [
				[
					{
						"node": "Extract Name & Phone",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Detect: Intention",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"API: Set new costumer": {
			"main": [
				[
					{
						"node": "Update API Contact ID",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Message a model1": {
			"main": [
				[
					{
						"node": "Parse Gemini Validation",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Get: Message Info": {
			"main": [
				[
					{
						"node": "Get API Contact1",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Actual status of contact": {
			"main": [
				[
					{
						"node": "Merge Rejection Sources",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Prepare Message Data",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Prepare Message Data",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Has Postgres Context?": {
			"main": [
				[
					{
						"node": "Switch3",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Need Contact Check?": {
			"main": [
				[
					{
						"node": "Contact Finder",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Check Questionnaire Status",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse Gemini Validation": {
			"main": [
				[
					{
						"node": "Switch1",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Generate Resume": {
			"main": [
				[
					{
						"node": "Parse Resume",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse Resume": {
			"main": [
				[
					{
						"node": "HTTP Request",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Get: User Context General Inq or Out Scope": {
			"main": [
				[
					{
						"node": "AI General Inq or Out Scope",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"OpenAI Chat Model": {
			"ai_languageModel": [
				[
					{
						"node": "AI General Inq or Out Scope",
						"type": "ai_languageModel",
						"index": 0
					}
				]
			]
		},
		"AI General Inq or Out Scope": {
			"main": [
				[
					{
						"node": "Parse: AI Response",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Simple Memory1": {
			"ai_memory": [
				[
					{
						"node": "AI General Inq or Out Scope",
						"type": "ai_memory",
						"index": 0
					}
				]
			]
		},
		"Message: General Inq or Out Scope": {
			"main": [
				[
					{
						"node": "Discord: Attention Message",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse: AI Response": {
			"main": [
				[
					{
						"node": "Message: General Inq or Out Scope",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"HTTP Request1": {
			"main": [
				[
					{
						"node": "Update: Status awaiting1",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Discord: Attention Message": {
			"main": [
				[
					{
						"node": "HTTP Request1",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse: Message w Property Info": {
			"main": [
				[
					{
						"node": "Send message",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse AI Questionnaire": {
			"main": [
				[
					{
						"node": "If: Is Awaiting Questionaire",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"OpenAI Chat Model3": {
			"ai_languageModel": [
				[
					{
						"node": "AI Generate Dynamic Questionnaire",
						"type": "ai_languageModel",
						"index": 0
					}
				]
			]
		},
		"Simple Memory2": {
			"ai_memory": [
				[
					{
						"node": "AI Generate Dynamic Questionnaire",
						"type": "ai_memory",
						"index": 0
					}
				]
			]
		},
		"AI Generate Dynamic Questionnaire": {
			"main": [
				[
					{
						"node": "Parse AI Questionnaire",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Message a model": {
			"main": [
				[
					{
						"node": "Send Misbehavior Notice",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"If": {
			"main": [
				[
					{
						"node": "AI: Create Reject Message",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Check and Assign Character",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Update: Contact Comments1": {
			"main": [
				[
					{
						"node": "Execute a SQL query4",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Format Reject Comment Payload": {
			"main": [
				[
					{
						"node": "Update: Contact Comments1",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Merge Rejection Sources": {
			"main": [
				[
					{
						"node": "Set: Rejection Payload",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Set: Rejection Payload": {
			"main": [
				[
					{
						"node": "AI: Create Reject Message",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"AI: Create Reject Message": {
			"main": [
				[
					{
						"node": "Message: Reject 2",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Message: Reject 2": {
			"main": [
				[
					{
						"node": "AI: Create Reject Resume",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"AI: Create Reject Resume": {
			"main": [
				[
					{
						"node": "Format Reject Comment Payload",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Switch2": {
			"main": [
				[
					{
						"node": "No Operation, do nothing",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Merge Rejection Sources",
						"type": "main",
						"index": 1
					}
				],
				[
					{
						"node": "Need Contact Check?",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Need Contact Check?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse Misbehavior": {
			"main": [
				[
					{
						"node": "If: Misbehavior?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"AI Misbehavior Detector": {
			"main": [
				[
					{
						"node": "Parse Misbehavior",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Get API Contact": {
			"main": [
				[
					{
						"node": "Get Misbehavior Context",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Build Blocked Comment Payload": {
			"main": [
				[
					{
						"node": "API: Add Blocked Comment",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"API: Add Blocked Comment": {
			"main": [
				[
					{
						"node": "Postgres: Update Blocked Context",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Postgres: Update Blocked Context": {
			"main": [
				[
					{
						"node": "No Operation, do nothing2",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Is Blocked?": {
			"main": [
				[
					{
						"node": "Build Blocked Comment Payload",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Get API Contact",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Switch3": {
			"main": [
				[
					{
						"node": "Build Blocked Comment Payload",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Build Blocked Comment Payload",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "AI Misbehavior Detector",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Get API Contact1": {
			"main": [
				[
					{
						"node": "Check Context Status",
						"type": "main",
						"index": 0
					}
				]
			]
		}
	},
	"pinData": {},
	"meta": {
		"templateCredsSetupCompleted": true,
		"instanceId": "37571b6e3b06c0ce894d50931b94c0b80b70f40d5b859a8ce717ce6c0e3d4b9d"
	}
}
